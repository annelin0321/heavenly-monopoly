<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤©åœ‹å¤§å¯Œç¿ï¼šæ‡‰è¨±ä¹‹åœ°</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'adventure-bg': '#E6D5B8', // ç¾Šçš®ç´™åº•è‰²
              'adventure-paper': '#F3E5AB', // äº®ç´™è‰²
              'adventure-ink': '#3E2723', // å¢¨æ°´æ·±è¤
              'adventure-gold': '#B8860B', // å¤é‡‘
              'adventure-red': '#8B0000', // å°è Ÿç´…
              'adventure-sea': '#87A8B3', // å¾©å¤æµ·è—
            },
            fontFamily: {
              'rounded': ['"Zen Maru Gothic"', 'sans-serif'],
              'serif': ['"Times New Roman"', 'serif'], // å¢åŠ è¥¯ç·šé«”ç”¨æ–¼æ¨™é¡Œ
            },
            boxShadow: {
              'paper': '2px 3px 5px rgba(62, 39, 35, 0.3)', 
              'deep': 'inset 0 2px 10px rgba(0,0,0,0.2)',
            },
            backgroundImage: {
              'parchment': "url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxmaWx0ZXIgaWQ9Im4iPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjUiIG51bU9jdGF2ZXM9IjMiIHN0aXRjaFRpbGVzPSJzdGl0Y2giLz48L2ZpbHRlcj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ0cmFuc3BhcmVudCIvPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbHRlcj0idXJsKCNuKSIgb3BhY2l0eT0iMC4wNSIvPjwvc3ZnPg==')",
            }
          }
        }
      }
    </script>
    
    <!-- è¨­å®šå­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- å¼•å…¥ React å’Œ Babel -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #E6D5B8;
            color: #3E2723;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #E0C097; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #8B4513; border-radius: 4px; }
        
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        @keyframes hop {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }
        .animate-hop { animation: hop 0.6s ease-in-out infinite; }
        
        /* å¾©å¤é‚Šæ¡†æ¨£å¼ */
        .vintage-border {
            border: 2px solid #8B4513;
            outline: 2px dashed #BCAAA4;
            outline-offset: -6px;
        }
        
        .wood-texture {
            background-color: #8D6E63;
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 2px, transparent 2px, transparent 4px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BookOpen, Heart, Star, MessageCircle, RefreshCw, Check, X, Dices, AlertCircle, PauseCircle, Home, MapPin, Sword, Cross, Scroll, Tent, Footprints, Loader, HelpCircle, AlertTriangle, Play, Info, Send, Hammer, Castle, Flag, WifiOff, Sun, CloudRain, Flame, Compass, Ship } from 'lucide-react';

        // --- è³‡æ–™åº« (ä¿æŒä¸è®Š) ---
        const BLESSING_VERSES = [
          { text: "ä½ ç•¶å‰›å¼·å£¯è†½ï¼ä¸è¦æ‡¼æ€•ï¼Œä¹Ÿä¸è¦é©šæƒ¶ã€‚", ref: "ç´„æ›¸äºè¨˜ 1:9" },
          { text: "æµæ·šæ’’ç¨®çš„ï¼Œå¿…æ­¡å‘¼æ”¶å‰²ã€‚", ref: "è©©ç¯‡ 126:5" },
          { text: "æˆ‘çš„æ©å…¸å¤ ä½ ç”¨çš„ï¼Œå› ç‚ºæˆ‘çš„èƒ½åŠ›æ˜¯åœ¨äººçš„è»Ÿå¼±ä¸Šé¡¯å¾—å®Œå…¨ã€‚", ref: "å“¥æ—å¤šå¾Œæ›¸ 12:9" },
          { text: "å£“å‚·çš„è˜†è‘¦ï¼Œä»–ä¸æŠ˜æ–·ï¼›å°‡æ®˜çš„ç‡ˆç«ï¼Œä»–ä¸å¹æ»…ã€‚", ref: "ä»¥è³½äºæ›¸ 42:3" },
        ];

        const BIBLE_BOOKS_MAPPING = {
          "å‰µä¸–è¨˜": "Genesis", "å‡ºåŸƒåŠè¨˜": "Exodus", "ç´„æ›¸äºè¨˜": "Joshua", "è©©ç¯‡": "Psalms", "ç®´è¨€": "Proverbs",
          "é¦¬å¤ªç¦éŸ³": "Matthew", "ç´„ç¿°ç¦éŸ³": "John", "ç¾…é¦¬æ›¸": "Romans", "å•Ÿç¤ºéŒ„": "Revelation"
        };
        const BIBLE_BOOKS = Object.keys(BIBLE_BOOKS_MAPPING);

        const FALLBACK_SCRIPTURE = [
            { verse: 1, text: "è€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚" },
            { verse: 2, text: "ä»–ä½¿æˆ‘èººè‡¥åœ¨é’è‰åœ°ä¸Šï¼Œé ˜æˆ‘åœ¨å¯å®‰æ­‡çš„æ°´é‚Šã€‚" },
            { verse: 3, text: "ä»–ä½¿æˆ‘çš„éˆé­‚ç”¦é†’ï¼Œç‚ºè‡ªå·±çš„åå¼•å°æˆ‘èµ°ç¾©è·¯ã€‚" },
            { verse: 4, text: "æˆ‘é›–ç„¶è¡Œéæ­»è”­çš„å¹½è°·ï¼Œä¹Ÿä¸æ€•é­å®³ï¼Œå› ç‚ºä½ èˆ‡æˆ‘åŒåœ¨ï¼›ä½ çš„æ–ï¼Œä½ çš„ç«¿ï¼Œéƒ½å®‰æ…°æˆ‘ã€‚" },
            { verse: 5, text: "åœ¨æˆ‘æ•µäººé¢å‰ï¼Œä½ ç‚ºæˆ‘æ“ºè¨­ç­µå¸­ï¼›ä½ ç”¨æ²¹è†äº†æˆ‘çš„é ­ï¼Œä½¿æˆ‘çš„ç¦æ¯æ»¿æº¢ã€‚" },
            { verse: 6, text: "æˆ‘ä¸€ç”Ÿä¸€ä¸–å¿…æœ‰æ©æƒ æ…ˆæ„›éš¨è‘—æˆ‘ï¼›æˆ‘ä¸”è¦ä½åœ¨è€¶å’Œè¯çš„æ®¿ä¸­ï¼Œç›´åˆ°æ°¸é ã€‚" }
        ];

        const FATE_CARDS = [
          { type: 'bad', text: "ç™¾å§“åœ¨æ› é‡ç™¼æ€¨è¨€ï¼Œä¿¡å¿ƒå‹•æ–ã€‚", amount: -30, freeze: false, title: "æ€¨è¨€çš„ç¶²ç¾…" },
          { type: 'bad', text: "è£½é€ äº†é‡‘ç‰›çŠ¢ï¼Œå¾—ç½ªäº†ç¥ã€‚", amount: -50, freeze: true, title: "å¶åƒçš„è©¦æ¢" },
          { type: 'bad', text: "è½ä¿¡æ¢å­çš„æƒ¡ä¿¡ï¼Œä¸æ•¢é€²å»ã€‚", amount: -20, freeze: true, title: "è†½æ€¯çš„å¿ƒ" },
          { type: 'bad', text: "å› ç‚ºè²ªæ„›ä¸–ç•Œï¼Œåº•é¦¬é›¢æ£„äº†é“ç†ã€‚", amount: -40, freeze: false, title: "ä¸–ç•Œçš„èª˜æƒ‘" },
          { type: 'good', text: "ä½ åœ¨æ› é‡ä¸­å–®å–®ä»°æœ›ç¥ã€‚", amount: 50, freeze: false, title: "å …å®šçš„ä¿¡å¿ƒ" },
          { type: 'good', text: "å¤©é™å—å“ªï¼Œæ¯æ—¥ä¾›æ‡‰ã€‚", amount: 30, freeze: false, title: "ç¥çš„ä¾›æ‡‰" },
          { type: 'good', text: "æ“Šæ•—äº†ä¾†è¥²çš„äºç‘ªåŠ›äººã€‚", amount: 40, freeze: false, title: "é ä¸»å¾—å‹" },
          { type: 'good', text: "é›²æŸ±ç«æŸ±æ—¥å¤œå¼•é ˜ã€‚", amount: 60, freeze: false, title: "ç¥çš„åŒåœ¨" },
        ];

        const CHANCE_CARDS = [
          { type: 'quiz', q: "ä»¥è‰²åˆ—äººç¹è¡Œè€¶åˆ©å“¥åŸå¹¾å¤©å¾ŒåŸç‰†å€’å¡Œï¼Ÿ", options: ["3å¤©", "7å¤©", "12å¤©"], ans: 1, reward: 50 },
          { type: 'quiz', q: "èª°åœ¨ç´„æ—¦æ²³ç‚ºè€¶ç©Œæ–½æ´—ï¼Ÿ", options: ["å½¼å¾—", "æ–½æ´—ç´„ç¿°", "ä¿ç¾…"], ans: 1, reward: 50 },
          { type: 'quiz', q: "ä¿ç¾…åœ¨å“ªè£¡çœ‹è¦‹å¤§å…‰è€Œæ‚”æ”¹ï¼Ÿ", options: ["è€¶è·¯æ’’å†·", "å¤§é¦¬è‰²è·¯ä¸Š", "ç¾…é¦¬"], ans: 1, reward: 60 },
          { type: 'quiz', q: "è€¶ç©Œçš„ç¬¬ä¸€å€‹ç¥è¹Ÿæ˜¯ä»€éº¼ï¼Ÿ", options: ["æ°´è®Šé…’", "äº”é¤…äºŒé­š", "é†«æ²»çå­"], ans: 0, reward: 40 },
          { type: 'event_bad', title: "é‡åˆ°å·¨äºº", text: "çœ‹è¦‹äºç´æ—äººé«˜å¤§ï¼Œå¿ƒè£¡å®³æ€•ã€‚", amount: -30 },
          { type: 'event_bad', title: "ç‘ªæ‹‰è‹¦æ°´", text: "æ°´æ˜¯è‹¦çš„ï¼Œç„¡æ³•é£²ç”¨ã€‚", amount: -20 },
          { type: 'event_bad', title: "é‡åˆ°å¼·ç›œ", text: "è·¯é€”ä¸­é­é‡å±éšªï¼Œæå¤±è²¡ç‰©ã€‚", amount: -40 },
        ];

        // --- æ£‹ç›¤è¨­å®š ---
        const INITIAL_BOARD_MAP = [
          { id: 0, type: 'start', label: 'éç´…æµ·', name: 'å‡ºåŸƒåŠ', color: 'from-yellow-100 to-yellow-200', icon: <Footprints size={20} /> },
          { id: 1, type: 'city', label: 'åŸæ± ', name: 'è€¶åˆ©å“¥', price: 100, rent: 20, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 2, type: 'fate', label: 'å‘½é‹', name: 'æ› é‡', color: 'from-purple-100 to-purple-200', icon: <AlertTriangle size={18} /> },
          { id: 3, type: 'city', label: 'åŸæ± ', name: 'è‰¾åŸ', price: 120, rent: 25, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 4, type: 'bible', label: 'è®€ç¶“', name: 'æœƒå¹•', color: 'from-blue-50 to-blue-100', icon: <Scroll size={18} /> },
          { id: 5, type: 'city', label: 'åŸæ± ', name: 'åŸºé', price: 140, rent: 30, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 6, type: 'event_jesus', label: 'æ©å…¸', name: 'åŠ åˆ©åˆ©æµ·', color: 'from-cyan-50 to-cyan-100', icon: <Cross size={18} /> },
          { id: 7, type: 'city', label: 'åŸæ± ', name: 'å¸Œä¼¯å´™', price: 160, rent: 35, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 8, type: 'chance', label: 'æ©Ÿæœƒ', name: 'æ™ºæ…§é–€', color: 'from-yellow-50 to-yellow-100', icon: <HelpCircle size={18} /> },
          { id: 9, type: 'city', label: 'åŸæ± ', name: 'ä¼¯ç‰¹åˆ©', price: 150, rent: 30, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 10, type: 'prayer', label: 'ç¦±å‘Š', name: 'å®¢è¥¿é¦¬å°¼', color: 'from-orange-50 to-orange-100', icon: <MessageCircle size={18} /> },
          { id: 11, type: 'city', label: 'é‡é®', name: 'è€¶è·¯æ’’å†·', price: 300, rent: 60, owner: null, level: 0, color: 'from-rose-50 to-rose-100', icon: <Home size={18} /> },
          { id: 12, type: 'event_paul', label: 'äº‹ä»¶', name: 'å¤§é¦¬è‰²è·¯', color: 'from-indigo-50 to-indigo-100', icon: <MapPin size={18} /> },
          { id: 13, type: 'city', label: 'åŸæ± ', name: 'ç¤ºåŠ', price: 200, rent: 40, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 14, type: 'bible', label: 'è®€ç¶“', name: 'åº‡å“©äº', color: 'from-blue-50 to-blue-100', icon: <Scroll size={18} /> },
          { id: 15, type: 'city', label: 'åŸæ± ', name: 'ç¤ºç¾…', price: 180, rent: 35, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 16, type: 'fate', label: 'å‘½é‹', name: 'é¢¨æµª', color: 'from-purple-100 to-purple-200', icon: <AlertTriangle size={18} /> },
          { id: 17, type: 'city', label: 'åŸæ± ', name: 'åˆ¥æ˜¯å·´', price: 220, rent: 45, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 18, type: 'chance', label: 'æ©Ÿæœƒ', name: 'ä¿¡å¿ƒé–€', color: 'from-yellow-50 to-yellow-100', icon: <HelpCircle size={18} /> },
          { id: 19, type: 'city', label: 'åŸæ± ', name: 'å¤ç‘£', price: 250, rent: 50, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
        ];

        const getGridPosition = (index) => {
          if (index <= 3) return { x: index, y: 0 };
          if (index <= 9) return { x: 3, y: index - 3 };
          if (index <= 13) return { x: 3 - (index - 10), y: 7 };
          if (index <= 19) return { x: 0, y: 7 - (index - 13) };
          return { x: 0, y: 0 };
        };

        // --- å…¨è¢å¹•ç¾Šçš®ç´™åœ°åœ–å…ƒä»¶ ---
        const BackgroundMap = () => {
            return (
                <div className="fixed inset-0 w-full h-full z-[-1] overflow-hidden pointer-events-none">
                    <svg width="100%" height="100%" viewBox="0 0 400 800" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <filter id="paper-texture" x="0%" y="0%" width="100%" height="100%">
                                <feTurbulence type="fractalNoise" baseFrequency="0.04" numOctaves="5" result="noise" />
                                <feDiffuseLighting in="noise" lightingColor="#E6D5B8" surfaceScale="2"> 
                                    <feDistantLight azimuth="45" elevation="60" />
                                </feDiffuseLighting>
                            </filter>
                            <radialGradient id="vignette" cx="50%" cy="50%" r="70%" fx="50%" fy="50%">
                                <stop offset="50%" stopColor="#8B4513" stopOpacity="0" />
                                <stop offset="100%" stopColor="#3E2723" stopOpacity="0.5" />
                            </radialGradient>
                        </defs>
                        <rect width="100%" height="100%" fill="#E6D5B8" />
                        <rect width="100%" height="100%" filter="url(#paper-texture)" opacity="0.6" />
                        <path d="M -50 0 L 80 0 Q 60 200 40 400 T -20 800 L -50 800 Z" fill="#87A8B3" opacity="0.4" stroke="#546E7A" strokeWidth="1" />
                        <path d="M 280 150 Q 300 130 320 150 T 280 150" fill="#87A8B3" opacity="0.6" />
                        <path d="M 300 160 Q 290 200 310 250 T 290 350" fill="none" stroke="#546E7A" strokeWidth="2" opacity="0.5" />
                        <path d="M 290 350 Q 270 380 290 420 T 310 380 Q 320 360 290 350" fill="#87A8B3" opacity="0.6" />
                        <path d="M 100 700 L 130 650 L 160 700 L 190 660 L 220 700" fill="none" stroke="#5D4037" strokeWidth="2" strokeLinejoin="round" opacity="0.4" />
                        <path d="M 50 750 C 80 700, 150 720, 200 650 S 100 500, 150 450 S 250 350, 280 200" fill="none" stroke="#8B0000" strokeWidth="2" strokeDasharray="6,4" strokeLinecap="round" opacity="0.6" />
                        <g transform="translate(320, 700) scale(0.6)" opacity="0.4">
                            <circle cx="0" cy="0" r="40" fill="none" stroke="#3E2723" strokeWidth="2" />
                            <path d="M 0 -35 L 8 8 L 35 0 L 8 -8 Z" fill="#3E2723" />
                            <path d="M 0 35 L -8 -8 L -35 0 L -8 8 Z" fill="none" stroke="#3E2723" strokeWidth="2" />
                            <text x="-5" y="-45" fontSize="16" fontFamily="serif" fontWeight="bold" fill="#3E2723">N</text>
                        </g>
                        <text x="30" y="770" fill="#3E2723" opacity="0.5" fontSize="12" fontFamily="serif" fontWeight="bold" transform="rotate(-10 30,770)">WILDERNESS</text>
                        <text x="20" y="300" fill="#3E2723" opacity="0.5" fontSize="12" fontFamily="serif" fontWeight="bold" transform="rotate(-90 20,300)">GREAT SEA</text>
                        <text x="250" y="100" fill="#3E2723" opacity="0.5" fontSize="14" fontFamily="serif" fontWeight="bold">PROMISED LAND</text>
                        <line x1="0" y1="200" x2="400" y2="200" stroke="#3E2723" strokeWidth="0.5" opacity="0.1" />
                        <line x1="0" y1="400" x2="400" y2="400" stroke="#3E2723" strokeWidth="0.5" opacity="0.1" />
                        <line x1="0" y1="600" x2="400" y2="600" stroke="#3E2723" strokeWidth="0.5" opacity="0.1" />
                        <line x1="200" y1="0" x2="200" y2="800" stroke="#3E2723" strokeWidth="0.5" opacity="0.1" />
                        <rect width="100%" height="100%" fill="url(#vignette)" style={{mixBlendMode: 'multiply'}} />
                    </svg>
                </div>
            );
        };

        // --- Start Screen ---
        const StartScreen = ({ onStart }) => {
          return (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center relative overflow-hidden">
              <BackgroundMap />
              <div className="z-10 max-w-md w-full bg-[#F3E5AB] p-8 rounded-xl shadow-[0_10px_30px_rgba(62,39,35,0.4)] border-4 border-[#8B4513] relative vintage-border">
                <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-[#8B4513] text-[#F3E5AB] px-4 py-1 text-sm font-bold rounded shadow-md tracking-widest">BIBLE ADVENTURE</div>
                <h1 className="text-4xl font-black text-[#3E2723] mb-2 mt-4 tracking-widest font-serif drop-shadow-sm">å¤©åœ‹å¤§å¯Œç¿</h1>
                <h2 className="text-lg font-bold text-[#5D4037] mb-8 font-serif italic">- æ‡‰è¨±ä¹‹åœ°ç¯‡ -</h2>
                <div className="flex justify-center items-center gap-8 mb-10">
                  <div className="flex flex-col items-center">
                    <div className="w-20 h-20 bg-white rounded-full shadow-[0_4px_0_#8B4513] border-4 border-[#8B4513] flex items-center justify-center text-5xl relative">
                        ğŸ‘
                        <div className="absolute -bottom-3 bg-[#3E2723] text-[#F3E5AB] text-xs px-2 py-0.5 rounded font-bold">YOU</div>
                    </div>
                  </div>
                  <div className="text-3xl font-black text-[#8B4513] font-serif">VS</div>
                  <div className="flex flex-col items-center">
                    <div className="w-20 h-20 bg-[#5D4037] rounded-full shadow-[0_4px_0_#3E2723] border-4 border-[#3E2723] flex items-center justify-center text-5xl relative">
                        <span style={{filter: 'grayscale(100%)'}}>ğŸ</span>
                        <div className="absolute -bottom-3 bg-[#3E2723] text-[#F3E5AB] text-xs px-2 py-0.5 rounded font-bold">CPU</div>
                    </div>
                  </div>
                </div>
                <div className="text-left mb-8 space-y-3 bg-[#E6D5B8] p-4 rounded border border-[#8B4513]/30 shadow-inner">
                  <div className="flex items-start gap-3"><div className="bg-[#8B4513] text-[#F3E5AB] w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">1</div><p className="text-sm font-bold text-[#3E2723]">æ“²éª°å­ï¼Œç´¯ç© <span className="text-[#8B0000]">ä¿¡å¿ƒå€¼</span>ã€‚</p></div>
                  <div className="flex items-start gap-3"><div className="bg-[#8B4513] text-[#F3E5AB] w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">2</div><p className="text-sm font-bold text-[#3E2723]">æ”»ä½”åŸæ± ï¼Œå»ºç«‹ <span className="text-[#8B0000]">ç¥­å£‡</span> ç»ç¥­ã€‚</p></div>
                  <div className="flex items-start gap-3"><div className="bg-[#8B4513] text-[#F3E5AB] w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">3</div><p className="text-sm font-bold text-[#3E2723]">é‡åˆ°é»‘å…¬ç¾Šçš„ç‡Ÿå£˜ï¼Œé¸æ“‡ <span className="text-[#8B0000]">æ‹†æ¯€</span> æˆ–ç¥ç¦ã€‚</p></div>
                </div>
                <button onClick={onStart} className="w-full bg-[#8B4513] hover:bg-[#5D4037] text-[#F3E5AB] text-xl font-black py-4 rounded shadow-[0_4px_0_#3E2723] active:translate-y-1 active:shadow-none transition-all flex items-center justify-center gap-3 border-2 border-[#3E2723]"><Sword size={24} /> é–‹å§‹å¾æˆ°</button>
              </div>
            </div>
          );
        };

        const GameButton = ({ onClick, disabled, color = "blue", icon: Icon, children }) => {
            const colors = {
                blue: "bg-[#5DADE2] text-white border-[#2874A6] shadow-[#1B4F72]",
                amber: "bg-[#F39C12] text-white border-[#B9770E] shadow-[#7E5109]",
                indigo: "bg-[#5D6D7E] text-white border-[#34495E] shadow-[#1B2631]",
                red: "bg-[#C0392B] text-white border-[#922B21] shadow-[#641E16]",
                purple: "bg-[#8E44AD] text-white border-[#6C3483] shadow-[#4A235A]",
                gray: "bg-[#95A5A6] text-white border-[#7F8C8D] shadow-[#515A5A]",
                orange: "bg-[#E67E22] text-white border-[#BA681C] shadow-[#874C13]",
                cyan: "bg-[#1ABC9C] text-white border-[#148F77] shadow-[#0E6655]",
                green: "bg-[#27AE60] text-white border-[#1E8449] shadow-[#145A32]",
            };
            const btnStyle = disabled 
                ? "bg-[#D7CCC8] text-[#A1887F] border-[#A1887F] cursor-not-allowed border-2" 
                : `${colors[color]} border-b-4 active:border-b-0 active:translate-y-1 active:shadow-none shadow-md`;
            
            return (
                <button onClick={onClick} disabled={disabled} className={`w-full py-3.5 rounded-lg font-bold transition-all flex items-center justify-center gap-2 ${btnStyle}`}>
                    {Icon && <Icon size={20} strokeWidth={2.5} />}
                    {children}
                </button>
            );
        };

        const CardFlip = ({ frontTitle, frontColor, backContent, icon }) => {
            const [isFlipped, setIsFlipped] = useState(false);
            return (
                <div className="relative w-full h-[450px] perspective-1000 cursor-pointer group" onClick={() => !isFlipped && setIsFlipped(true)}>
                  <div className={`relative w-full h-full transition-all duration-700 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                    <div className={`absolute w-full h-full bg-gradient-to-br ${frontColor} rounded-xl shadow-[0_10px_20px_rgba(0,0,0,0.3)] flex flex-col items-center justify-center backface-hidden border-8 border-[#3E2723]`}>
                      <div className="border-4 border-dashed border-[#3E2723]/30 w-[90%] h-[90%] absolute rounded-lg pointer-events-none"></div>
                      <div className="bg-[#3E2723] p-6 rounded-full text-[#F3E5AB] mb-6 shadow-md">{icon}</div>
                      <h3 className="text-3xl font-black text-[#3E2723] tracking-[0.2em] uppercase font-serif drop-shadow-sm">{frontTitle}</h3>
                      <div className="absolute bottom-12 text-[#3E2723]/60 text-sm font-bold animate-pulse">é»æ“Šç¿»é–‹è–è«­</div>
                    </div>
                    <div className="absolute w-full h-full bg-[#F3E5AB] rounded-xl shadow-[0_10px_20px_rgba(0,0,0,0.3)] flex flex-col items-center justify-center p-8 backface-hidden rotate-y-180 border-8 border-[#8B4513] overflow-y-auto bg-[url('https://www.transparenttextures.com/patterns/paper.png')]">
                        {backContent}
                    </div>
                  </div>
                </div>
            );
        };

        const FateEvent = ({ onComplete }) => {
            const [card] = useState(() => FATE_CARDS[Math.floor(Math.random() * FATE_CARDS.length)]);
            const isGood = card.type === 'good';
            const backContent = (
              <div className="w-full text-center h-full flex flex-col justify-center">
                <div className={`mb-6 p-4 rounded-full w-20 h-20 mx-auto flex items-center justify-center border-4 ${isGood ? 'bg-[#E8F5E9] border-green-600 text-green-600' : 'bg-[#FFEBEE] border-red-600 text-red-600'}`}>
                    {isGood ? <Sun size={40}/> : <CloudRain size={40}/>}
                </div>
                <h3 className={`text-2xl font-black mb-4 ${isGood ? 'text-green-600' : 'text-purple-600'}`}>{card.title}</h3>
                <p className="text-lg font-bold text-[#5D4037] leading-relaxed mb-8 border-y-2 border-[#8B4513]/20 py-4">{card.text}</p>
                <div className="mb-8">
                  <span className={`text-xl font-black px-4 py-2 rounded ${isGood ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                    ä¿¡å¿ƒ {card.amount > 0 ? '+' : ''}{card.amount}
                  </span>
                  {card.freeze && <div className="text-red-600 text-sm mt-2 font-bold flex justify-center items-center gap-1"><PauseCircle size={14}/> æš«åœä¸€å›åˆ</div>}
                </div>
                <GameButton onClick={() => onComplete(0, card.amount, card.freeze)} color={isGood ? "green" : "red"}>{isGood ? "å“ˆåˆ©è·¯äº" : "æ‚”æ”¹æ±‚ä¸»"}</GameButton>
              </div>
            );
            return <CardFlip frontTitle="å‘½é‹ç‰Œ" frontColor={isGood ? "bg-[#A5D6A7]" : "bg-[#EF9A9A]"} icon={<AlertTriangle size={64} />} backContent={backContent} />;
        };

        const ChanceEvent = ({ onComplete }) => {
            const [card] = useState(() => CHANCE_CARDS[Math.floor(Math.random() * CHANCE_CARDS.length)]);
            const [quizStatus, setQuizStatus] = useState('ask');
            const handleAns = (idx) => { if (idx === card.ans) { setQuizStatus('correct'); setTimeout(() => onComplete(20, card.reward), 1500); } else { setQuizStatus('wrong'); setTimeout(() => onComplete(0, 0, true), 1500); } };
            const renderBackContent = () => {
                if (card.type === 'quiz') {
                    return (
                        <div className="w-full text-center">
                            <h3 className="text-2xl font-black text-[#8B4513] mb-6 font-serif decoration-double underline decoration-[#D7CCC8]">è–ç¶“å†·çŸ¥è­˜</h3>
                            {quizStatus === 'ask' && (<div className="w-full"><p className="text-[#3E2723] font-bold text-lg leading-relaxed mb-6">{card.q}</p><div className="space-y-3">{card.options.map((opt, idx) => (<button key={idx} onClick={() => handleAns(idx)} className="w-full bg-[#FFF3E0] text-[#5D4037] border-2 border-[#D7CCC8] py-3 rounded-lg font-bold hover:bg-[#FFE0B2] hover:border-[#FFB74D] transition-all active:scale-95 shadow-sm">{opt}</button>))}</div></div>)}
                            {quizStatus === 'correct' && (<div className="py-10 animate-bounce text-green-700"><div className="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-green-200"><Check size={40} /></div><p className="text-2xl font-black">ç­”å°äº†ï¼</p><p className="font-bold">+{card.reward} ä¿¡å¿ƒ</p></div>)}
                            {quizStatus === 'wrong' && (<div className="py-10 animate-shake text-red-700"><div className="bg-red-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-red-200"><X size={40} /></div><p className="text-2xl font-black">ç­”éŒ¯äº†...</p><p className="font-bold">æš«åœä¸€å›</p></div>)}
                        </div>
                    );
                } else {
                    return (<div className="w-full text-center h-full flex flex-col justify-center"><div className="mb-6 p-4 rounded-full w-20 h-20 mx-auto flex items-center justify-center bg-gray-200 text-gray-600 border-4 border-gray-300"><CloudRain size={40}/></div><h3 className="text-2xl font-black text-[#3E2723] mb-4">{card.title}</h3><p className="text-lg font-bold text-[#5D4037] leading-relaxed mb-6">{card.text}</p><div className="inline-block bg-red-50 border border-red-200 px-4 py-2 rounded-lg mb-8"><p className="text-red-800 font-black">ä¿¡å¿ƒå€¼ {card.amount}</p></div><GameButton onClick={() => onComplete(0, card.amount)} color="gray">æ¥å—æŒ‘æˆ°</GameButton></div>);
                }
            };
            return <CardFlip frontTitle="æ©Ÿæœƒç‰Œ" frontColor="bg-[#FFE082]" icon={<HelpCircle size={64} />} backContent={renderBackContent()} />;
        };

        const EventModal = ({ type, tileData, onClose, onComplete, coins, isOwner, onBuy, onUpgrade, onDestroy }) => {
          const BibleReader = () => {
            const [bookName] = useState(BIBLE_BOOKS[Math.floor(Math.random() * BIBLE_BOOKS.length)]);
            const [chapter] = useState(Math.floor(Math.random() * 5) + 1);
            const [content, setContent] = useState(null);
            const [loading, setLoading] = useState(true);
            const [usingFallback, setUsingFallback] = useState(false);
            useEffect(() => {
              const fetchBible = async () => {
                setLoading(true); const engBook = BIBLE_BOOKS_MAPPING[bookName];
                try { const res = await fetch(`https://bible-api.com/${engBook}+${chapter}?translation=cuv`); if (!res.ok) throw new Error("API Error"); const data = await res.json(); if (data.verses) setContent(data.verses); else throw new Error("No data"); } 
                catch (err) { setUsingFallback(true); setContent(FALLBACK_SCRIPTURE); } setLoading(false);
              }; fetchBible();
            }, [bookName, chapter]);
            return (
              <div className="bg-[#FFF8E7] rounded-3xl shadow-2xl border-8 border-[#8B4513] flex flex-col h-[500px] overflow-hidden relative">
                <div className="absolute top-0 left-0 w-full h-4 bg-[#8B4513]"></div>
                <div className="bg-[#F3E5AB] p-4 border-b-2 border-[#D7CCC8] flex-shrink-0 mt-4">
                   <h3 className="text-xl font-black text-[#5D4037] text-center flex items-center justify-center gap-2 font-serif"><BookOpen size={20} /> æ¯æ—¥éˆç³§</h3>
                   <p className="text-center text-[#8B4513] font-bold mt-1 text-sm">{usingFallback ? "è©©ç¯‡ ç¬¬ 23 ç« " : `${bookName} ç¬¬ ${chapter} ç« `}</p>
                </div>
                <div className="flex-1 overflow-y-auto p-6 custom-scrollbar bg-[url('https://www.transparenttextures.com/patterns/paper.png')]">
                   {loading ? <div className="h-full flex flex-col items-center justify-center text-[#8B4513] gap-3"><Loader className="animate-spin" size={32} /><p className="font-bold">æ­£åœ¨ç¿»é–‹è–ç¶“...</p></div> : 
                     <div className="space-y-4">{usingFallback && <div className="text-center text-xs text-[#E65100] font-bold bg-[#FFE0B2] p-2 rounded mb-2"><WifiOff size={12} className="inline mr-1"/> é›¢ç·šæ¨¡å¼</div>}{content.map((v, idx) => (<div key={idx} className="flex gap-3 text-[#3E2723] leading-relaxed text-justify text-sm font-medium"><span className="text-xs font-black text-[#8B4513] mt-0.5 shrink-0">{v.verse}</span><span>{v.text}</span></div>))}<div className="h-8"></div><div className="text-center text-[#A1887F] text-xs font-bold tracking-widest">--- AMEN ---</div></div>}
                </div>
                <div className="p-4 border-t-2 border-[#D7CCC8] flex-shrink-0 bg-[#F3E5AB]">
                   <GameButton onClick={() => onComplete(30, 80)} disabled={loading} color="amber" icon={Check}>{loading ? "è®€å–ä¸­..." : "æˆ‘è®€å®Œäº† (+80 ä¿¡å¿ƒ)"}</GameButton>
                </div>
              </div>
            );
          };

          const PropertyAction = () => {
            if (tileData.type !== 'city') return null;
            if (isOwner) {
              const upgradeCost = Math.floor(tileData.price * 0.6);
              const isFirstUpgrade = tileData.level === 0;
              return (<div className="mt-4 pt-4 border-t-2 border-[#D7CCC8] w-full"><p className="text-sm text-center text-[#5D4037] mb-3 font-bold">é€™æ˜¯ä½ çš„å±¬åœ° (Lv.{tileData.level})</p><GameButton onClick={() => onUpgrade(upgradeCost)} disabled={coins < upgradeCost} color="amber" icon={isFirstUpgrade ? Home : Flame}>{isFirstUpgrade ? `å»ºç«‹ç¥­å£‡ (-${upgradeCost})` : `ç»ç¥­ (æå‡æ©è†) (-${upgradeCost})`}</GameButton><p className="text-[10px] text-[#8B4513] text-center mt-2 font-bold">{isFirstUpgrade ? "å»ºç«‹ç¥­å£‡å¯ä¿è­·ç”¢æ¥­ä¸è¢«æ‹†æ¯€ï¼" : "ç»ç¥­æ¬¡æ•¸è¶Šå¤šï¼Œéè·¯è²»è¶Šé«˜ï¼"}</p></div>);
            }
            if (!tileData.owner) {
              return (<div className="mt-4 pt-4 border-t-2 border-[#D7CCC8] w-full"><p className="text-sm text-center text-[#5D4037] mb-3 font-bold">æ­¤åœ°ç„¡äººçœ‹å®ˆï¼Œæ˜¯å¦å¾—åœ°ç‚ºæ¥­ï¼Ÿ</p><GameButton onClick={() => onBuy(tileData.price)} disabled={coins < tileData.price} color="indigo" icon={Sword}>æ”»ä½”é€™åº§åŸ (-{tileData.price})</GameButton></div>);
            }
            if (tileData.owner === 'cpu') {
               const rentCost = tileData.rent * (tileData.level + 1);
               const destroyCost = tileData.price; 
               const claimCost = destroyCost + tileData.price;
               const hasAltar = tileData.level > 0;
               return (
                 <div className="mt-4 pt-4 border-t-2 border-[#D7CCC8] bg-[#FFEBEE] p-4 rounded-xl space-y-3 w-full border border-red-200">
                   <div className="text-center"><p className="text-[#C62828] font-bold mb-1 flex justify-center items-center gap-1"><AlertTriangle size={16}/> é€™æ˜¯é»‘å…¬ç¾Šçš„ç‡Ÿå£˜ï¼</p></div>
                   <button onClick={() => onComplete(0, -rentCost)} className="w-full py-3 rounded-lg font-bold bg-white text-[#5D4037] border-2 border-[#D7CCC8] hover:border-[#8D6E63] transition-colors flex items-center justify-center gap-2 shadow-sm"><Heart size={18} className="text-red-400" fill="currentColor"/> çµ¦äºˆç¥ç¦ (-{rentCost})</button>
                   {!hasAltar ? (
                     <><div className="relative flex py-1 items-center"><div className="flex-grow border-t border-[#EF9A9A]"></div><span className="flex-shrink-0 mx-2 text-[#EF5350] text-xs font-bold">OR</span><div className="flex-grow border-t border-[#EF9A9A]"></div></div><GameButton onClick={() => onDestroy(destroyCost, false)} disabled={coins < destroyCost} color="red" icon={Hammer}>æ‹†æ¯€ç‡Ÿå£˜ (-{destroyCost})</GameButton><div className="mt-1"><GameButton onClick={() => onDestroy(claimCost, true)} disabled={coins < claimCost} color="indigo" icon={Sword}>æ‹†æ¯€ä¸¦å»ºç«‹åŸæ±  (-{claimCost})</GameButton></div>{coins < destroyCost && <p className="text-[10px] text-red-400 text-center font-bold">ä¿¡å¿ƒä¸è¶³</p>}</>
                   ) : (<div className="text-center border-t border-red-200 pt-2 mt-2"><p className="text-xs text-[#C62828] font-bold flex items-center justify-center gap-1"><Castle size={12}/> å°æ–¹å·²å»ºç«‹å …å›ºç¥­å£‡</p><p className="text-[10px] text-red-400 mt-0.5">ç„¡æ³•é€²è¡Œæ‹†æ¯€ï¼Œåªèƒ½çµ¦äºˆç¥ç¦ã€‚</p></div>)}
                 </div>
               )
            }
            return null;
          };

          if (type === 'event_jesus' || type === 'event_paul' || type === 'prayer' || type === 'city') {
             let title, content, icon, colorTheme, btn;
             if (type === 'event_jesus') {
                const verse = BLESSING_VERSES[Math.floor(Math.random() * BLESSING_VERSES.length)];
                title = "âœï¸ é‡è¦‹è€¶ç©Œ"; colorTheme="cyan";
                content = <><p className="text-gray-500 mb-6 font-bold">ä½ åœ¨æ—…é€”ä¸­ç¶“æ­·äº†ä¸»çš„åŒåœ¨...</p><div className="bg-[#E0F7FA] p-6 rounded-xl mb-8 italic text-[#006064] relative text-lg font-medium leading-relaxed border border-[#B2EBF2]"><div className="absolute -top-3 -left-3 text-[#00BCD4]"><Heart fill="currentColor" size={32}/></div>"{verse.text}" <div className="text-right text-sm font-black mt-3 text-[#0097A7] uppercase tracking-wider">- {verse.ref}</div></div></>;
                btn = <GameButton onClick={() => onComplete(20, 100)} color="cyan">é ˜å—ç¥ç¦ (+100 ä¿¡å¿ƒ)</GameButton>;
             } else if (type === 'event_paul') {
                title = "âš¡ å¤§é¦¬è‰²è·¯"; colorTheme="indigo";
                content = <p className="text-[#3E2723] mb-8 font-medium leading-relaxed text-lg">å¿½ç„¶å¾å¤©ä¸Šæœ‰å…‰å››é¢ç…§è‘—ä½ ...<br/><span className="text-sm opacity-80">é›–ç„¶æš«æ™‚çœ‹ä¸è¦‹(æš«åœ)ï¼Œä½†ç”Ÿå‘½å°‡è¢«ç¿»è½‰ï¼</span></p>;
                btn = <GameButton onClick={() => onComplete(50, 50, true)} color="indigo">é †æœå‘¼å¬ (+50 ä¿¡å¿ƒï¼Œæš«åœ)</GameButton>;
             } else if (type === 'prayer') {
                const [input, setInput] = useState("");
                title = `ğŸ™ ${tileData.name}`; colorTheme="orange";
                content = <><p className="text-[#5D4037] mb-4 text-sm font-bold">åœ¨ä¸»é¢å‰å‚¾å¿ƒåæ„...</p><textarea className="w-full bg-[#FFF3E0] rounded-xl p-4 mb-6 outline-none border-2 border-[#FFE0B2] focus:border-[#FFB74D] text-[#5D4037] font-medium resize-none transition-all" rows={3} placeholder="è¼¸å…¥ä½ çš„ç¦±å‘Š..." value={input} onChange={e=>setInput(e.target.value)} /></>;
                btn = <div className="w-full"><GameButton onClick={() => onComplete(20, 50)} color="orange" icon={Send} disabled={!input.trim()}>ç™¼å‡ºç¦±å‘Š (+50 ä¿¡å¿ƒ)</GameButton><div className="mt-4">{tileData.type === 'city' && <PropertyAction />}</div></div>;
             } else { // city
                const isEnemyCity = tileData.owner === 'cpu';
                title = `ğŸ° ${tileData.name}`; colorTheme="amber";
                content = <><div className="mb-6 inline-block px-3 py-1 bg-[#F5F5DC] border border-[#EAD6BB] rounded text-[#8B4513] text-xs font-bold tracking-wide">{tileData.owner === 'player' ? "ä½ çš„ç”¢æ¥­" : tileData.owner === 'cpu' ? `éè·¯è²»: ${tileData.rent * (tileData.level + 1)}` : "ç„¡ä¸»ä¹‹åœ°"}</div>{!tileData.owner && (<div className="bg-[#FFF8E1] p-4 rounded-xl mb-6 text-left border border-[#FFE0B2]"><p className="text-xs text-[#F57C00] font-black mb-1 uppercase tracking-wide">City Info</p><p className="text-sm text-[#5D4037] font-medium leading-relaxed">é€™æ˜¯ä¸€åº§å …å›ºçš„åŸï¼Œéœ€è¦ä¿¡å¿ƒæ‰èƒ½æ”»ç ´ã€‚ä½”é ˜å¾Œå¯æ”¶å–å¥‰ç»é‡‘ã€‚</p></div>)}</>;
                btn = <>{!isEnemyCity && <div className="mt-4"><PropertyAction /><button onClick={onClose} className="mt-6 text-[#A1887F] text-sm font-bold hover:text-[#5D4037] underline decoration-2 underline-offset-4 w-full text-center">æš«ä¸è¡Œå‹•</button></div>}{isEnemyCity && <PropertyAction />}</>
             }

             return (
                <div className="bg-[#FFFCF5] p-8 rounded-[2rem] shadow-[0_20px_50px_rgba(0,0,0,0.2)] border-8 border-[#EAD6BB] text-center relative overflow-hidden">
                    <h3 className="text-2xl font-black text-[#3E2723] mb-2 mt-2 font-serif">{title}</h3>
                    {content}
                    {btn}
                </div>
             )
          }
          if (type === 'fate') return <FateEvent onComplete={onComplete} />;
          if (type === 'chance') return <ChanceEvent onComplete={onComplete} />;
          return null;
        };

        const App = () => {
          const [gameState, setGameState] = useState('start');
          const [board, setBoard] = useState(INITIAL_BOARD_MAP);
          const [playerPos, setPlayerPos] = useState(0);
          const [cpuPos, setCpuPos] = useState(0);
          const [faith, setFaith] = useState(1000); 
          const [cpuFaith, setCpuFaith] = useState(1000);
          const [level, setLevel] = useState(1);
          const [turn, setTurn] = useState('player'); 
          const [isMoving, setIsMoving] = useState(false);
          const [diceValue, setDiceValue] = useState(1);
          const [activeModal, setActiveModal] = useState(null);
          const [isFrozen, setIsFrozen] = useState(false);
          const [notification, setNotification] = useState(null);

          const playerProperties = board.filter(t => t.owner === 'player').length;
          const cpuProperties = board.filter(t => t.owner === 'cpu').length;

          const startGame = () => { setGameState('playing'); setFaith(1000); setCpuFaith(1000); setPlayerPos(0); setCpuPos(0); setBoard(INITIAL_BOARD_MAP); setLevel(1); };
          const notify = (text, color="bg-amber-500") => { setNotification({ text, color }); setTimeout(() => setNotification(null), 3000); };

          const rollDice = () => {
            if (isMoving || activeModal || turn !== 'player') return;
            if (isFrozen) {
              notify("ä»åœ¨æ› é‡çœæ€ä¸­... æš«åœä¸€å›", "bg-gray-500");
              setIsMoving(true); 
              setTimeout(() => { setIsFrozen(false); setIsMoving(false); setTurn('cpu'); }, 1500); 
              return;
            }
            const val = Math.floor(Math.random() * 6) + 1;
            setDiceValue(val); setIsMoving(true);
            moveToken('player', playerPos, val, (newPos) => { setPlayerPos(newPos); handleLandEvent(newPos, 'player'); });
          };

          useEffect(() => {
            if (gameState === 'playing' && turn === 'cpu') {
              setTimeout(() => {
                const val = Math.floor(Math.random() * 6) + 1;
                setDiceValue(val); setIsMoving(true);
                moveToken('cpu', cpuPos, val, (newPos) => { setCpuPos(newPos); handleCpuLandEvent(newPos); });
              }, 1000);
            }
          }, [turn, gameState]);

          const moveToken = (who, start, steps, callback) => {
            let current = start; let count = 0;
            const interval = setInterval(() => {
              current = (current + 1) % board.length;
              if (who === 'player') setPlayerPos(current); else setCpuPos(current);
              if (current === 0) {
                if (who === 'player') { setFaith(f => f + 300); notify("ç¶“éç´…æµ·(èµ·é»)ï¼ä¿¡å¿ƒå¤§å¢ +300", "bg-yellow-500"); } 
                else { setCpuFaith(f => f + 300); }
              }
              count++;
              if (count === steps) { clearInterval(interval); setIsMoving(false); callback(current); }
            }, 200);
          };

          const handleLandEvent = (pos, who) => {
            const tile = board[pos];
            if (tile.type !== 'start') { setTimeout(() => setActiveModal(tile.type), 500); } 
            else { setTurn('cpu'); }
          };

          const handleCpuLandEvent = (pos) => {
            const tile = board[pos];
            if (tile.owner === 'player') {
              const destroyCost = tile.price;
              if (tile.level === 0 && cpuFaith >= destroyCost && Math.random() < 0.4) {
                 const newBoard = [...board]; newBoard[pos].owner = null; newBoard[pos].level = 0; setBoard(newBoard);
                 setCpuFaith(f => f - destroyCost); notify(`ç³Ÿç³•ï¼é»‘å…¬ç¾Šæ”»ç ´äº†ä½ çš„ ${tile.name}ï¼`, "bg-red-500");
              } else {
                 const cost = tile.rent * (tile.level + 1); setCpuFaith(f => Math.max(0, f - cost)); setFaith(f => f + cost);
                 notify(`é»‘å…¬ç¾Šä¾†åˆ°ä½ çš„åŸï¼Œç²å¾—å¥‰ç» +${cost}`, "bg-green-500");
              }
            }
            else if (tile.type === 'city' && !tile.owner && cpuFaith >= tile.price) {
              if (Math.random() > 0.5) {
                const newBoard = [...board]; newBoard[pos].owner = 'cpu'; setBoard(newBoard);
                setCpuFaith(f => f - tile.price); notify(`é»‘å…¬ç¾Šæ”»ä½”äº† ${tile.name}!`, "bg-purple-400");
              }
            }
            else if (tile.type === 'city' && tile.owner === 'cpu' && cpuFaith >= tile.price * 0.6) {
              if (Math.random() > 0.7) {
                 const newBoard = [...board]; newBoard[pos].level += 1; setBoard(newBoard);
                 setCpuFaith(f => f - Math.floor(tile.price * 0.6));
                 const actionName = newBoard[pos].level === 1 ? "å»ºç«‹äº†ç¥­å£‡" : "é€²è¡Œäº†ç»ç¥­";
                 notify(`é»‘å…¬ç¾Šåœ¨ ${tile.name} ${actionName}ï¼`, "bg-purple-500");
              }
            }
            setTimeout(() => setTurn('player'), 1500);
          };

          const onModalComplete = (xpGain, faithChange, freeze = false) => {
            if (xpGain) { const nextXp = xp + xpGain; if (nextXp >= level * 100) { setLevel(l => l + 1); notify("éˆå‘½æˆé•·ï¼ç­‰ç´šæå‡ï¼", "bg-yellow-400"); } }
            if (faithChange) { setFaith(f => Math.max(0, f + faithChange)); if (faithChange > 0) notify(`ä¿¡å¿ƒå¢åŠ  +${faithChange}`); else notify(`ä¿¡å¿ƒæ¸›å°‘ ${Math.abs(faithChange)}`, faithChange < 0 ? "bg-red-400" : "bg-amber-500"); }
            if (freeze) setIsFrozen(true);
            setActiveModal(null); setTurn('cpu');
          };

          const handleBuy = (cost) => {
            const newBoard = [...board]; newBoard[playerPos].owner = 'player'; setBoard(newBoard);
            setFaith(f => f - cost); notify("å“ˆåˆ©è·¯äºï¼å¾—åœ°ç‚ºæ¥­ï¼", "bg-indigo-500"); setActiveModal(null); setTurn('cpu');
          };

          const handleUpgrade = (cost) => {
            const newBoard = [...board]; newBoard[playerPos].level += 1; setBoard(newBoard);
            const actionName = newBoard[playerPos].level === 1 ? "ç¥­å£‡å»ºé€ å®Œæˆ" : "ç»ç¥­å®Œæˆ";
            setFaith(f => f - cost); notify(`${actionName}ï¼Œæ©è†åŠ å€ï¼`, "bg-amber-500"); setActiveModal(null); setTurn('cpu');
          };

          const handleDestroy = (cost, claim = false) => {
            const newBoard = [...board];
            newBoard[playerPos].owner = claim ? 'player' : null;
            newBoard[playerPos].level = 0; 
            setBoard(newBoard);
            setFaith(f => f - cost);
            if (claim) notify("å“ˆåˆ©è·¯äºï¼æ”»ç ´ç‡Ÿå£˜ä¸¦å¾—åœ°ç‚ºæ¥­ï¼", "bg-indigo-500");
            else notify("ä¾é ç¥çš„å¤§èƒ½ï¼Œç‡Ÿå£˜å·²æ”»ç ´ï¼", "bg-red-500");
            setActiveModal(null); setTurn('cpu');
          };

          if (gameState === 'start') return <StartScreen onStart={startGame} />;

          return (
            <div className="min-h-screen flex flex-col items-center justify-center p-2 relative overflow-hidden">
              <BackgroundMap />
              {/* HUD */}
              <div className="w-full max-w-md fixed top-4 z-30 px-4">
                <div className="glass-panel rounded-xl p-3 shadow-floating border border-[#8B4513]/40 bg-[#FFF8E7]/90 backdrop-blur-md">
                    <div className="flex justify-between items-center mb-2 px-2">
                        <div className="flex items-center gap-2"><span className="font-black text-[#5D4037] tracking-widest text-lg font-serif">CANAAN</span></div>
                        <div className="px-3 py-0.5 bg-[#8B4513] text-[#F3E5AB] text-[10px] font-bold rounded shadow-sm border border-[#5D4037]">Lv.{level} éˆå‘½</div>
                    </div>
                    <div className="flex gap-2">
                        <div className={`flex-1 bg-[#F3E5AB] rounded-lg p-2 border transition-all duration-300 ${turn === 'player' ? 'border-[#8B4513] shadow-md scale-[1.02] bg-[#FFF8E1]' : 'border-transparent opacity-70 grayscale'}`}>
                            <div className="flex justify-between text-[10px] font-bold text-[#8D6E63] mb-1"><span>ç¶¿ç¾Š (æˆ‘)</span><span className="text-[#3E2723] flex items-center gap-0.5"><Castle size={10}/> {playerProperties}</span></div>
                            <div className="flex items-center gap-1.5 text-[#E65100] font-black text-xl"><Heart fill="currentColor" size={18} /> {faith}</div>
                        </div>
                        <div className={`flex-1 bg-[#D7CCC8] rounded-lg p-2 border transition-all duration-300 ${turn === 'cpu' ? 'border-[#3E2723] shadow-md scale-[1.02] bg-[#EFEBE9]' : 'border-transparent opacity-70 grayscale'}`}>
                            <div className="flex justify-between text-[10px] font-bold text-[#5D4037] mb-1"><span>é»‘å…¬ç¾Š</span><span className="text-[#3E2723] flex items-center gap-0.5"><Castle size={10}/> {cpuProperties}</span></div>
                            <div className="flex items-center justify-end gap-1.5 text-[#4A148C] font-black text-xl">{cpuFaith} <Heart fill="currentColor" size={18} /></div>
                        </div>
                    </div>
                </div>
              </div>

              {notification && (<div className={`fixed top-44 z-50 px-6 py-3 rounded-lg text-[#F3E5AB] font-bold shadow-[0_4px_0_#3E2723] animate-bounce text-center backdrop-blur-md border-2 border-[#5D4037] ${notification.color === 'bg-red-500' ? 'bg-[#C62828]' : 'bg-[#EF6C00]'}`}>{notification.text}</div>)}

              <div className="relative w-full max-w-md aspect-[9/16] mt-48 mb-4 p-2 scale-95">
                <div className="w-full h-full bg-[#E6D5B8]/80 rounded-[1.5rem] shadow-[inset_0_0_60px_rgba(62,39,35,0.2)] relative border-8 border-[#8D6E63] outline outline-4 outline-[#5D4037] backdrop-blur-sm overflow-hidden">
                   {/* Center Hub */}
                   <div className="absolute inset-0 m-auto w-[45%] h-[30%] flex flex-col items-center justify-center z-10">
                      <div className="w-32 h-32 rounded-full bg-[#FFF8E1] shadow-[0_8px_0_rgba(62,39,35,0.2),inset_0_4px_10px_rgba(255,255,255,0.5)] border-4 border-[#D7CCC8] flex flex-col items-center justify-center mb-6 relative overflow-hidden">
                         <div className={`w-16 h-16 bg-white rounded-xl shadow-inner flex items-center justify-center border border-[#E0E0E0] ${isMoving ? 'animate-spin' : ''}`}>{isMoving ? <RefreshCw className="text-[#8D6E63]" /> : <span className="text-4xl font-black text-[#3E2723] font-serif">{diceValue}</span>}</div>
                         <div className="absolute bottom-3 text-[10px] font-bold text-[#8D6E63] uppercase tracking-widest">{turn === 'player' ? (isFrozen ? "æ› é‡çœæ€..." : "YOUR TURN") : "CPU TURN"}</div>
                      </div>
                      <button onClick={rollDice} disabled={turn !== 'player' || isMoving || activeModal} className={`w-full py-4 rounded-xl font-black text-[#F3E5AB] shadow-[0_4px_0_#3E2723] text-lg flex items-center justify-center gap-2 transition-all transform active:translate-y-1 active:shadow-none border-2 border-[#3E2723] ${turn === 'player' && !isFrozen ? 'bg-[#8B4513] hover:bg-[#6D4C41]' : 'bg-[#BCAAA4] cursor-not-allowed border-[#8D6E63] shadow-none'}`}>{isFrozen ? <PauseCircle /> : <Dices />}{isFrozen ? "è·³éå›åˆ" : "æ“²éª°å­"}</button>
                   </div>
                   
                   {/* Tiles */}
                   {board.map((tile, i) => {
                     const pos = getGridPosition(i);
                     const style = { left: `${pos.x * 25}%`, top: `${pos.y * 12.5}%`, width: '25%', height: '12.5%' };
                     let BuildingIcon = null;
                     if (tile.owner && tile.type === 'city') {
                        const colorClass = tile.owner === 'player' ? 'text-[#1E88E5]' : 'text-[#8E24AA]';
                        const level = tile.level;
                        BuildingIcon = (<div className={`absolute -top-3 right-0 flex items-end ${colorClass} z-20 transition-all duration-300 drop-shadow-md`}><Castle size={18} fill="currentColor" />{level >= 1 && (<div className="flex -ml-1 mb-1">{[...Array(level)].map((_, idx) => (<Flame key={idx} size={14} fill={tile.owner === 'player' ? '#FF6F00' : '#AB47BC'} className={idx > 0 ? "-ml-2 text-white" : "text-white"} />))}</div>)}</div>);
                     }
                     // ç´™å¼µè³ªæ„Ÿæ ¼å­
                     const bgStyle = tile.color.replace('from-', 'from-').replace('to-', 'to-'); 
                     const ownerBorder = tile.owner === 'player' ? 'border-[#1E88E5] border-2 bg-[#E3F2FD]' : tile.owner === 'cpu' ? 'border-[#8E24AA] border-2 bg-[#F3E5F5]' : 'border-[#8D6E63]/30 border bg-[#FFF8E1]';
                     
                     return (
                       <div key={tile.id} className="absolute p-1 transition-all" style={style}>
                         <div className={`w-full h-full rounded shadow-sm flex flex-col items-center justify-center relative overflow-visible ${ownerBorder}`}>
                            {BuildingIcon}
                            <div className="text-[#5D4037] transform scale-90 mb-0.5 opacity-80">{tile.icon}</div>
                            <div className="text-[9px] font-bold text-[#3E2723] leading-none text-center px-0.5 truncate w-full tracking-tight">{tile.name || tile.label}</div>
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-30">{playerPos === i && (<div className="relative animate-hop z-40"><div className="text-2xl filter drop-shadow-md -mt-4">ğŸ‘</div><div className="w-5 h-1.5 bg-[#3E2723]/30 rounded-full blur-[1px] absolute -bottom-1 left-1/2 -translate-x-1/2"></div></div>)}{cpuPos === i && (<div className="relative transition-all duration-500 mt-2 ml-4 z-30"><div className="text-2xl filter drop-shadow-md" style={{filter: 'grayscale(100%) brightness(30%)'}}>ğŸ</div><div className="w-5 h-1.5 bg-[#3E2723]/30 rounded-full blur-[1px] absolute bottom-0 left-1/2 -translate-x-1/2"></div></div>)}</div>
                         </div>
                       </div>
                     )
                   })}
                </div>
              </div>

              {activeModal && (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#3E2723]/60 backdrop-blur-sm"><div className="w-full max-w-sm animate-hop"><EventModal type={activeModal} tileData={board[playerPos]} coins={faith} isOwner={board[playerPos].owner === 'player'} isFrozen={isFrozen} onClose={() => { setActiveModal(null); setTurn('cpu'); }} onComplete={onModalComplete} onBuy={handleBuy} onUpgrade={handleUpgrade} onDestroy={handleDestroy} /></div></div>)}
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
