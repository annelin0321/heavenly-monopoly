<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤©åœ‹å¤§å¯Œç¿ï¼šæ‡‰è¨±ä¹‹åœ°</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'canaan-gold': '#F4D03F',
              'canaan-sand': '#F5F5DC',
              'canaan-earth': '#8B4513',
              'canaan-sky': '#87CEEB',
            },
            fontFamily: {
              'rounded': ['"Zen Maru Gothic"', 'sans-serif'],
            },
            boxShadow: {
              'tile': '0 4px 0 rgba(0,0,0,0.1)',
              'tile-active': '0 2px 0 rgba(0,0,0,0.1)',
              'floating': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
            }
          }
        }
      }
    </script>
    
    <!-- è¨­å®šå­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- å¼•å…¥ React å’Œ Babel -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #FFF8E1;
            background-image: radial-gradient(#FDE68A 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #FCD34D; border-radius: 4px; }
        
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        @keyframes hop {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-hop { animation: hop 0.5s ease-in-out infinite; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BookOpen, Heart, Star, MessageCircle, RefreshCw, Check, X, Dices, AlertCircle, PauseCircle, Home, MapPin, Sword, Cross, Scroll, Tent, Footprints, Loader, HelpCircle, AlertTriangle, Play, Info, Send, Hammer, Castle, Flag, WifiOff, Sun, CloudRain, Flame } from 'lucide-react';

        // --- è³‡æ–™åº« ---
        const BLESSING_VERSES = [
          { text: "ä½ ç•¶å‰›å¼·å£¯è†½ï¼ä¸è¦æ‡¼æ€•ï¼Œä¹Ÿä¸è¦é©šæƒ¶ã€‚", ref: "ç´„æ›¸äºè¨˜ 1:9" },
          { text: "æµæ·šæ’’ç¨®çš„ï¼Œå¿…æ­¡å‘¼æ”¶å‰²ã€‚", ref: "è©©ç¯‡ 126:5" },
          { text: "æˆ‘çš„æ©å…¸å¤ ä½ ç”¨çš„ï¼Œå› ç‚ºæˆ‘çš„èƒ½åŠ›æ˜¯åœ¨äººçš„è»Ÿå¼±ä¸Šé¡¯å¾—å®Œå…¨ã€‚", ref: "å“¥æ—å¤šå¾Œæ›¸ 12:9" },
          { text: "å£“å‚·çš„è˜†è‘¦ï¼Œä»–ä¸æŠ˜æ–·ï¼›å°‡æ®˜çš„ç‡ˆç«ï¼Œä»–ä¸å¹æ»…ã€‚", ref: "ä»¥è³½äºæ›¸ 42:3" },
        ];

        const BIBLE_BOOKS_MAPPING = {
          "å‰µä¸–è¨˜": "Genesis", "å‡ºåŸƒåŠè¨˜": "Exodus", "ç´„æ›¸äºè¨˜": "Joshua", "è©©ç¯‡": "Psalms", "ç®´è¨€": "Proverbs",
          "é¦¬å¤ªç¦éŸ³": "Matthew", "ç´„ç¿°ç¦éŸ³": "John", "ç¾…é¦¬æ›¸": "Romans", "å•Ÿç¤ºéŒ„": "Revelation"
        };
        const BIBLE_BOOKS = Object.keys(BIBLE_BOOKS_MAPPING);

        const FALLBACK_SCRIPTURE = [
            { verse: 1, text: "è€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚" },
            { verse: 2, text: "ä»–ä½¿æˆ‘èººè‡¥åœ¨é’è‰åœ°ä¸Šï¼Œé ˜æˆ‘åœ¨å¯å®‰æ­‡çš„æ°´é‚Šã€‚" },
            { verse: 3, text: "ä»–ä½¿æˆ‘çš„éˆé­‚ç”¦é†’ï¼Œç‚ºè‡ªå·±çš„åå¼•å°æˆ‘èµ°ç¾©è·¯ã€‚" },
            { verse: 4, text: "æˆ‘é›–ç„¶è¡Œéæ­»è”­çš„å¹½è°·ï¼Œä¹Ÿä¸æ€•é­å®³ï¼Œå› ç‚ºä½ èˆ‡æˆ‘åŒåœ¨ï¼›ä½ çš„æ–ï¼Œä½ çš„ç«¿ï¼Œéƒ½å®‰æ…°æˆ‘ã€‚" },
            { verse: 5, text: "åœ¨æˆ‘æ•µäººé¢å‰ï¼Œä½ ç‚ºæˆ‘æ“ºè¨­ç­µå¸­ï¼›ä½ ç”¨æ²¹è†äº†æˆ‘çš„é ­ï¼Œä½¿æˆ‘çš„ç¦æ¯æ»¿æº¢ã€‚" },
            { verse: 6, text: "æˆ‘ä¸€ç”Ÿä¸€ä¸–å¿…æœ‰æ©æƒ æ…ˆæ„›éš¨è‘—æˆ‘ï¼›æˆ‘ä¸”è¦ä½åœ¨è€¶å’Œè¯çš„æ®¿ä¸­ï¼Œç›´åˆ°æ°¸é ã€‚" }
        ];

        const FATE_CARDS = [
          { type: 'bad', text: "ç™¾å§“åœ¨æ› é‡ç™¼æ€¨è¨€ï¼Œä¿¡å¿ƒå‹•æ–ã€‚", amount: -30, freeze: false, title: "æ€¨è¨€çš„ç¶²ç¾…" },
          { type: 'bad', text: "è£½é€ äº†é‡‘ç‰›çŠ¢ï¼Œå¾—ç½ªäº†ç¥ã€‚", amount: -50, freeze: true, title: "å¶åƒçš„è©¦æ¢" },
          { type: 'bad', text: "è½ä¿¡æ¢å­çš„æƒ¡ä¿¡ï¼Œä¸æ•¢é€²å»ã€‚", amount: -20, freeze: true, title: "è†½æ€¯çš„å¿ƒ" },
          { type: 'bad', text: "å› ç‚ºè²ªæ„›ä¸–ç•Œï¼Œåº•é¦¬é›¢æ£„äº†é“ç†ã€‚", amount: -40, freeze: false, title: "ä¸–ç•Œçš„èª˜æƒ‘" },
          { type: 'good', text: "ä½ åœ¨æ› é‡ä¸­å–®å–®ä»°æœ›ç¥ã€‚", amount: 50, freeze: false, title: "å …å®šçš„ä¿¡å¿ƒ" },
          { type: 'good', text: "å¤©é™å—å“ªï¼Œæ¯æ—¥ä¾›æ‡‰ã€‚", amount: 30, freeze: false, title: "ç¥çš„ä¾›æ‡‰" },
          { type: 'good', text: "æ“Šæ•—äº†ä¾†è¥²çš„äºç‘ªåŠ›äººã€‚", amount: 40, freeze: false, title: "é ä¸»å¾—å‹" },
          { type: 'good', text: "é›²æŸ±ç«æŸ±æ—¥å¤œå¼•é ˜ã€‚", amount: 60, freeze: false, title: "ç¥çš„åŒåœ¨" },
        ];

        const CHANCE_CARDS = [
          { type: 'quiz', q: "ä»¥è‰²åˆ—äººç¹è¡Œè€¶åˆ©å“¥åŸå¹¾å¤©å¾ŒåŸç‰†å€’å¡Œï¼Ÿ", options: ["3å¤©", "7å¤©", "12å¤©"], ans: 1, reward: 50 },
          { type: 'quiz', q: "èª°åœ¨ç´„æ—¦æ²³ç‚ºè€¶ç©Œæ–½æ´—ï¼Ÿ", options: ["å½¼å¾—", "æ–½æ´—ç´„ç¿°", "ä¿ç¾…"], ans: 1, reward: 50 },
          { type: 'quiz', q: "ä¿ç¾…åœ¨å“ªè£¡çœ‹è¦‹å¤§å…‰è€Œæ‚”æ”¹ï¼Ÿ", options: ["è€¶è·¯æ’’å†·", "å¤§é¦¬è‰²è·¯ä¸Š", "ç¾…é¦¬"], ans: 1, reward: 60 },
          { type: 'quiz', q: "è€¶ç©Œçš„ç¬¬ä¸€å€‹ç¥è¹Ÿæ˜¯ä»€éº¼ï¼Ÿ", options: ["æ°´è®Šé…’", "äº”é¤…äºŒé­š", "é†«æ²»çå­"], ans: 0, reward: 40 },
          { type: 'event_bad', title: "é‡åˆ°å·¨äºº", text: "çœ‹è¦‹äºç´æ—äººé«˜å¤§ï¼Œå¿ƒè£¡å®³æ€•ã€‚", amount: -30 },
          { type: 'event_bad', title: "ç‘ªæ‹‰è‹¦æ°´", text: "æ°´æ˜¯è‹¦çš„ï¼Œç„¡æ³•é£²ç”¨ã€‚", amount: -20 },
          { type: 'event_bad', title: "é‡åˆ°å¼·ç›œ", text: "è·¯é€”ä¸­é­é‡å±éšªï¼Œæå¤±è²¡ç‰©ã€‚", amount: -40 },
        ];

        // --- æ£‹ç›¤è¨­å®š ---
        const INITIAL_BOARD_MAP = [
          { id: 0, type: 'start', label: 'éç´…æµ·', name: 'å‡ºåŸƒåŠ', color: 'from-yellow-100 to-yellow-200', icon: <Footprints size={20} /> },
          { id: 1, type: 'city', label: 'åŸæ± ', name: 'è€¶åˆ©å“¥', price: 100, rent: 20, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 2, type: 'fate', label: 'å‘½é‹', name: 'æ› é‡', color: 'from-purple-100 to-purple-200', icon: <AlertTriangle size={18} /> },
          { id: 3, type: 'city', label: 'åŸæ± ', name: 'è‰¾åŸ', price: 120, rent: 25, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 4, type: 'bible', label: 'è®€ç¶“', name: 'æœƒå¹•', color: 'from-blue-50 to-blue-100', icon: <Scroll size={18} /> },
          { id: 5, type: 'city', label: 'åŸæ± ', name: 'åŸºé', price: 140, rent: 30, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 6, type: 'event_jesus', label: 'æ©å…¸', name: 'åŠ åˆ©åˆ©æµ·', color: 'from-cyan-50 to-cyan-100', icon: <Cross size={18} /> },
          { id: 7, type: 'city', label: 'åŸæ± ', name: 'å¸Œä¼¯å´™', price: 160, rent: 35, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 8, type: 'chance', label: 'æ©Ÿæœƒ', name: 'æ™ºæ…§é–€', color: 'from-yellow-50 to-yellow-100', icon: <HelpCircle size={18} /> },
          { id: 9, type: 'city', label: 'åŸæ± ', name: 'ä¼¯ç‰¹åˆ©', price: 150, rent: 30, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 10, type: 'prayer', label: 'ç¦±å‘Š', name: 'å®¢è¥¿é¦¬å°¼', color: 'from-orange-50 to-orange-100', icon: <MessageCircle size={18} /> },
          { id: 11, type: 'city', label: 'é‡é®', name: 'è€¶è·¯æ’’å†·', price: 300, rent: 60, owner: null, level: 0, color: 'from-rose-50 to-rose-100', icon: <Home size={18} /> },
          { id: 12, type: 'event_paul', label: 'äº‹ä»¶', name: 'å¤§é¦¬è‰²è·¯', color: 'from-indigo-50 to-indigo-100', icon: <MapPin size={18} /> },
          { id: 13, type: 'city', label: 'åŸæ± ', name: 'ç¤ºåŠ', price: 200, rent: 40, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 14, type: 'bible', label: 'è®€ç¶“', name: 'åº‡å“©äº', color: 'from-blue-50 to-blue-100', icon: <Scroll size={18} /> },
          { id: 15, type: 'city', label: 'åŸæ± ', name: 'ç¤ºç¾…', price: 180, rent: 35, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 16, type: 'fate', label: 'å‘½é‹', name: 'é¢¨æµª', color: 'from-purple-100 to-purple-200', icon: <AlertTriangle size={18} /> },
          { id: 17, type: 'city', label: 'åŸæ± ', name: 'åˆ¥æ˜¯å·´', price: 220, rent: 45, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 18, type: 'chance', label: 'æ©Ÿæœƒ', name: 'ä¿¡å¿ƒé–€', color: 'from-yellow-50 to-yellow-100', icon: <HelpCircle size={18} /> },
          { id: 19, type: 'city', label: 'åŸæ± ', name: 'å¤ç‘£', price: 250, rent: 50, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
        ];

        const getGridPosition = (index) => {
          if (index <= 3) return { x: index, y: 0 };
          if (index <= 9) return { x: 3, y: index - 3 };
          if (index <= 13) return { x: 3 - (index - 10), y: 7 };
          if (index <= 19) return { x: 0, y: 7 - (index - 13) };
          return { x: 0, y: 0 };
        };

        // --- çµ„ä»¶ ---
        const StartScreen = ({ onStart }) => {
          return (
            <div className="min-h-screen bg-[#FDF6E3] font-[Zen_Maru_Gothic] flex flex-col items-center justify-center p-6 text-center relative overflow-hidden">
              <div className="absolute top-10 left-10 text-amber-200 animate-blob"><Star size={80} /></div>
              <div className="absolute bottom-20 right-10 text-blue-200 animate-blob"><Heart size={100} /></div>
              <div className="z-10 max-w-md w-full bg-white/80 backdrop-blur-sm p-8 rounded-[3rem] shadow-2xl border-8 border-[#EAD6BB]">
                <h1 className="text-4xl font-black text-amber-600 mb-2 tracking-wider drop-shadow-sm">å¤©åœ‹å¤§å¯Œç¿</h1>
                <h2 className="text-xl font-bold text-[#8B4513] mb-8">- æ‡‰è¨±ä¹‹åœ°ç¯‡ -</h2>
                <div className="flex justify-center items-center gap-6 mb-8">
                  <div className="flex flex-col items-center animate-bounce">
                    <div className="text-6xl drop-shadow-md">ğŸ‘</div>
                    <span className="text-sm font-bold text-gray-500 mt-2 bg-white px-2 rounded-full">ä½  (ç¶¿ç¾Š)</span>
                  </div>
                  <div className="text-2xl font-black text-amber-400">VS</div>
                  <div className="flex flex-col items-center animate-pulse">
                    <div className="text-6xl drop-shadow-md" style={{filter: 'grayscale(100%) brightness(30%)'}}>ğŸ</div>
                    <span className="text-sm font-bold text-gray-500 mt-2 bg-white px-2 rounded-full">é»‘å…¬ç¾Š</span>
                  </div>
                </div>
                <div className="bg-[#FFF8E7] p-4 rounded-2xl text-left mb-8 border-2 border-[#EAD6BB]">
                  <h3 className="font-bold text-amber-600 mb-3 flex items-center gap-2"><Info size={18} /> éŠæˆ²è¦å‰‡</h3>
                  <ul className="text-sm text-gray-600 space-y-2 font-medium">
                    <li className="flex items-start gap-2"><span className="text-amber-500">1.</span> <span>ç´¯ç© <span className="text-indigo-500 font-bold">ä¿¡å¿ƒå€¼ (Faith)</span> ä¾†æ¦®è€€ç¥ã€‚</span></li>
                    <li className="flex items-start gap-2"><span className="text-amber-500">2.</span> <span>è¸©åˆ°åŸæ± å¯ <span className="font-bold">å¾—åœ°ç‚ºæ¥­ (å»ºç«‹åŸæ± )</span>ã€‚</span></li>
                    <li className="flex items-start gap-2"><span className="text-amber-500">3.</span> <span>ä¹‹å¾Œå¯ <span className="font-bold">å»ºç«‹ç¥­å£‡</span> èˆ‡ <span className="font-bold">ç»ç¥­</span>ï¼Œæå‡éè·¯è²»ã€‚</span></li>
                    <li className="flex items-start gap-2"><span className="text-amber-500">4.</span> <span>æ¯”é»‘å…¬ç¾Šæ“æœ‰æ›´å¤šä¿¡å¿ƒèˆ‡åœŸåœ°ï¼Œæˆç‚ºå¤©åœ‹å¤§è´å®¶ï¼</span></li>
                  </ul>
                </div>
                <button onClick={onStart} className="w-full bg-gradient-to-r from-amber-400 to-orange-500 text-white text-xl font-black py-4 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center justify-center gap-2 group">
                  <Play fill="currentColor" className="group-hover:translate-x-1 transition-transform" /> é–‹å§‹å†’éšª
                </button>
              </div>
              <p className="absolute bottom-6 text-gray-400 text-xs font-bold">Design by å±¬éˆçˆ­æˆ°å°çµ„</p>
            </div>
          );
        };

        const GameButton = ({ onClick, disabled, color = "blue", icon: Icon, children }) => {
            const colors = {
                blue: "bg-blue-500 hover:bg-blue-600 shadow-blue-200",
                amber: "bg-amber-500 hover:bg-amber-600 shadow-amber-200",
                indigo: "bg-indigo-500 hover:bg-indigo-600 shadow-indigo-200",
                red: "bg-red-500 hover:bg-red-600 shadow-red-200",
                purple: "bg-purple-500 hover:bg-purple-600 shadow-purple-200",
                gray: "bg-gray-500 hover:bg-gray-600 shadow-gray-200",
                orange: "bg-orange-500 hover:bg-orange-600 shadow-orange-200",
                cyan: "bg-cyan-500 hover:bg-cyan-600 shadow-cyan-200",
                green: "bg-green-500 hover:bg-green-600 shadow-green-200",
            };
            const bgClass = disabled ? "bg-gray-300 text-gray-500 cursor-not-allowed" : `${colors[color]} text-white shadow-lg active:scale-95 active:shadow-none`;
            return (
                <button onClick={onClick} disabled={disabled} className={`w-full py-3.5 rounded-xl font-bold transition-all flex items-center justify-center gap-2 ${bgClass}`}>
                    {Icon && <Icon size={20} strokeWidth={2.5} />}
                    {children}
                </button>
            );
        };

        const CardFlip = ({ frontTitle, frontColor, backContent, icon }) => {
            const [isFlipped, setIsFlipped] = useState(false);
            return (
                <div className="relative w-full h-[450px] perspective-1000 cursor-pointer group" onClick={() => !isFlipped && setIsFlipped(true)}>
                  <div className={`relative w-full h-full transition-all duration-700 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                    <div className={`absolute w-full h-full bg-gradient-to-br ${frontColor} rounded-3xl shadow-2xl flex flex-col items-center justify-center backface-hidden border-4 border-white/30`}>
                      <div className="bg-white/20 p-6 rounded-full text-white mb-4 backdrop-blur-sm shadow-inner group-hover:scale-110 transition-transform duration-500">{icon}</div>
                      <h3 className="text-3xl font-black text-white tracking-widest drop-shadow-md">{frontTitle}</h3>
                      <div className="absolute bottom-10 text-white/80 text-sm font-bold animate-bounce flex flex-col items-center gap-1"><span>é»æ“Šç¿»é–‹</span><div className="w-1 h-1 bg-white rounded-full"></div></div>
                    </div>
                    <div className="absolute w-full h-full bg-white rounded-3xl shadow-2xl flex flex-col items-center justify-center p-8 backface-hidden rotate-y-180 border-4 border-white overflow-y-auto">{backContent}</div>
                  </div>
                </div>
            );
        };

        const FateEvent = ({ onComplete }) => {
            const [card] = useState(() => FATE_CARDS[Math.floor(Math.random() * FATE_CARDS.length)]);
            const isGood = card.type === 'good';
            
            const backContent = (
              <div className="w-full text-center h-full flex flex-col justify-center">
                <div className={`mb-6 p-4 rounded-full w-20 h-20 mx-auto flex items-center justify-center ${isGood ? 'bg-green-100 text-green-500' : 'bg-red-100 text-red-500'}`}>
                    {isGood ? <Sun size={40}/> : <CloudRain size={40}/>}
                </div>
                <h3 className={`text-2xl font-black mb-4 ${isGood ? 'text-green-600' : 'text-purple-600'}`}>{card.title}</h3>
                <p className="text-lg font-bold text-gray-800 leading-relaxed mb-6">{card.text}</p>
                <div className={`inline-block px-4 py-2 rounded-lg mb-8 border ${isGood ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                  <p className={`font-black ${isGood ? 'text-green-600' : 'text-red-600'}`}>ä¿¡å¿ƒå€¼ {card.amount > 0 ? '+' : ''}{card.amount}</p>
                  {card.freeze && <p className="text-red-500 text-xs mt-1 flex items-center justify-center gap-1 font-bold"><PauseCircle size={12}/> æš«åœä¸€å›åˆ</p>}
                </div>
                <GameButton onClick={() => onComplete(0, card.amount, card.freeze)} color={isGood ? "green" : "purple"}>{isGood ? "å“ˆåˆ©è·¯äº" : "æ‚”æ”¹æ±‚ä¸»èµ¦å…"}</GameButton>
              </div>
            );
            return <CardFlip frontTitle="å‘½é‹ç‰Œ" frontColor="from-purple-500 to-indigo-600" icon={<AlertTriangle size={64} />} backContent={backContent} />;
        };

        const ChanceEvent = ({ onComplete }) => {
            const [card] = useState(() => CHANCE_CARDS[Math.floor(Math.random() * CHANCE_CARDS.length)]);
            const [quizStatus, setQuizStatus] = useState('ask');

            const handleAns = (idx) => { 
                if (idx === card.ans) { setQuizStatus('correct'); setTimeout(() => onComplete(20, card.reward), 1500); } 
                else { setQuizStatus('wrong'); setTimeout(() => onComplete(0, 0, true), 1500); } 
            };

            const renderBackContent = () => {
                if (card.type === 'quiz') {
                    return (
                        <div className="w-full text-center">
                            <h3 className="text-2xl font-black text-amber-500 mb-6">è–ç¶“å†·çŸ¥è­˜</h3>
                            {quizStatus === 'ask' && (
                                <div className="w-full">
                                    <div className="bg-amber-50 p-4 rounded-xl mb-6 border border-amber-100"><p className="text-gray-800 font-bold text-lg leading-relaxed">{card.q}</p></div>
                                    <div className="space-y-3">{card.options.map((opt, idx) => (<button key={idx} onClick={() => handleAns(idx)} className="w-full bg-white text-gray-700 border-2 border-gray-100 py-3 rounded-xl font-bold hover:border-amber-400 hover:text-amber-600 transition-all active:scale-95">{opt}</button>))}</div>
                                </div>
                            )}
                            {quizStatus === 'correct' && (
                                <div className="py-10 animate-bounce text-green-500"><div className="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"><Check size={40} /></div><p className="text-2xl font-black">ç­”å°äº†ï¼</p><p className="font-bold text-green-600">+{card.reward} ä¿¡å¿ƒ</p></div>
                            )}
                            {quizStatus === 'wrong' && (
                                <div className="py-10 animate-shake text-red-400"><div className="bg-red-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"><X size={40} /></div><p className="text-2xl font-black">ç­”éŒ¯äº†...</p><p className="font-bold text-red-500">æš«åœä¸€å›</p></div>
                            )}
                        </div>
                    );
                } else {
                    return (
                      <div className="w-full text-center h-full flex flex-col justify-center">
                        <div className="mb-6 p-4 rounded-full w-20 h-20 mx-auto flex items-center justify-center bg-gray-100 text-gray-500">
                            <CloudRain size={40}/>
                        </div>
                        <h3 className="text-2xl font-black text-gray-600 mb-4">{card.title}</h3>
                        <p className="text-lg font-bold text-gray-800 leading-relaxed mb-6">{card.text}</p>
                        <div className="inline-block bg-red-50 border border-red-200 px-4 py-2 rounded-lg mb-8">
                          <p className="text-red-600 font-black">ä¿¡å¿ƒå€¼ {card.amount}</p>
                        </div>
                        <GameButton onClick={() => onComplete(0, card.amount)} color="gray">æ¥å—æŒ‘æˆ°</GameButton>
                      </div>
                    );
                }
            };

            return <CardFlip frontTitle="æ©Ÿæœƒç‰Œ" frontColor="from-amber-400 to-orange-500" icon={<HelpCircle size={64} />} backContent={renderBackContent()} />;
        };

        const EventModal = ({ type, tileData, onClose, onComplete, coins, isOwner, onBuy, onUpgrade, onDestroy }) => {
          const BibleReader = () => {
            const [bookName] = useState(BIBLE_BOOKS[Math.floor(Math.random() * BIBLE_BOOKS.length)]);
            const [chapter] = useState(Math.floor(Math.random() * 5) + 1);
            const [content, setContent] = useState(null);
            const [loading, setLoading] = useState(true);
            const [usingFallback, setUsingFallback] = useState(false);

            useEffect(() => {
              const fetchBible = async () => {
                setLoading(true);
                const engBook = BIBLE_BOOKS_MAPPING[bookName];
                try {
                  const res = await fetch(`https://bible-api.com/${engBook}+${chapter}?translation=cuv`);
                  if (!res.ok) throw new Error("API Error");
                  const data = await res.json();
                  if (data.verses) setContent(data.verses); 
                  else throw new Error("No data");
                } catch (err) { 
                  console.error("Bible fetch failed, using fallback", err);
                  setUsingFallback(true);
                  setContent(FALLBACK_SCRIPTURE);
                }
                setLoading(false);
              };
              fetchBible();
            }, [bookName, chapter]);

            return (
              <div className="bg-white rounded-3xl shadow-2xl border-4 border-blue-100 flex flex-col h-[500px] overflow-hidden">
                <div className="bg-blue-50 p-4 border-b border-blue-100 flex-shrink-0">
                   <h3 className="text-xl font-bold text-blue-800 text-center flex items-center justify-center gap-2"><BookOpen size={20} /> æ¯æ—¥éˆç³§</h3>
                   <p className="text-center text-blue-600 font-bold mt-1 text-sm">{usingFallback ? "è©©ç¯‡ ç¬¬ 23 ç« " : `${bookName} ç¬¬ ${chapter} ç« `}</p>
                </div>
                <div className="flex-1 overflow-y-auto p-6 bg-white custom-scrollbar">
                   {loading ? (
                     <div className="h-full flex flex-col items-center justify-center text-gray-400 gap-3"><Loader className="animate-spin text-blue-400" size={32} /><p className="font-bold">æ­£åœ¨ç¿»é–‹è–ç¶“...</p></div>
                   ) : (
                     <div className="space-y-4">
                        {usingFallback && <div className="text-center text-xs text-orange-400 font-bold bg-orange-50 p-2 rounded-lg mb-2"><WifiOff size={12} className="inline mr-1"/> ç¶²è·¯ä¸ç©©ï¼Œé¡¯ç¤ºå‚™ç”¨ç¶“æ–‡</div>}
                        {content.map((v, idx) => (<div key={idx} className="flex gap-3 text-gray-700 leading-relaxed text-justify text-sm"><span className="text-xs font-black text-blue-400 mt-0.5 shrink-0 bg-blue-50 w-5 h-5 flex items-center justify-center rounded-full">{v.verse}</span><span>{v.text}</span></div>))}
                        <div className="h-8"></div><div className="text-center text-gray-300 text-xs font-bold tracking-widest">--- AMEN ---</div>
                     </div>
                   )}
                </div>
                <div className="p-4 border-t border-gray-100 flex-shrink-0 bg-gray-50">
                   <GameButton onClick={() => onComplete(30, 80)} disabled={loading} color="blue" icon={Check}>{loading ? "è®€å–ä¸­..." : "æˆ‘è®€å®Œäº† (+80 ä¿¡å¿ƒ)"}</GameButton>
                </div>
              </div>
            );
          };

          const PropertyAction = () => {
            if (tileData.type !== 'city') return null;
            if (isOwner) {
              const upgradeCost = Math.floor(tileData.price * 0.6);
              const isFirstUpgrade = tileData.level === 0;
              return (
                <div className="mt-4 pt-4 border-t border-gray-100 w-full">
                  <p className="text-sm text-center text-gray-500 mb-3 font-bold">é€™æ˜¯ä½ çš„å±¬åœ° (Lv.{tileData.level})</p>
                  <GameButton 
                    onClick={() => onUpgrade(upgradeCost)} 
                    disabled={coins < upgradeCost} 
                    color="amber" 
                    icon={isFirstUpgrade ? Home : Flame}
                  >
                    {isFirstUpgrade ? `å»ºç«‹ç¥­å£‡ (-${upgradeCost})` : `ç»ç¥­ (æå‡æ©è†) (-${upgradeCost})`}
                  </GameButton>
                  <p className="text-[10px] text-amber-600 text-center mt-2 font-bold">{isFirstUpgrade ? "å»ºç«‹ç¥­å£‡å¯ä¿è­·ç”¢æ¥­ä¸è¢«æ‹†æ¯€ï¼" : "ç»ç¥­æ¬¡æ•¸è¶Šå¤šï¼Œéè·¯è²»è¶Šé«˜ï¼"}</p>
                </div>
              );
            }
            if (!tileData.owner) {
              return (<div className="mt-4 pt-4 border-t border-gray-100 w-full"><p className="text-sm text-center text-gray-500 mb-3 font-bold">æ­¤åœ°ç„¡äººçœ‹å®ˆï¼Œæ˜¯å¦å¾—åœ°ç‚ºæ¥­ï¼Ÿ</p><GameButton onClick={() => onBuy(tileData.price)} disabled={coins < tileData.price} color="indigo" icon={Sword}>æ”»ä½”é€™åº§åŸ (å»ºç«‹åŸæ± ) (-{tileData.price})</GameButton></div>);
            }
            if (tileData.owner === 'cpu') {
               const rentCost = tileData.rent * (tileData.level + 1);
               const destroyCost = tileData.price; 
               const claimCost = destroyCost + tileData.price;
               const hasAltar = tileData.level > 0;
               return (
                 <div className="mt-4 pt-4 border-t border-red-100 bg-red-50 p-4 rounded-xl space-y-3 w-full">
                   <div className="text-center"><p className="text-red-500 font-bold mb-1 flex justify-center items-center gap-1"><AlertTriangle size={16}/> é€™æ˜¯é»‘å…¬ç¾Šçš„ç‡Ÿå£˜ï¼</p></div>
                   <button onClick={() => onComplete(0, -rentCost)} className="w-full py-3 rounded-xl font-bold bg-white text-gray-600 border-2 border-gray-200 hover:border-gray-400 transition-colors flex items-center justify-center gap-2"><Heart size={18} className="text-red-400" fill="currentColor"/> çµ¦äºˆç¥ç¦ (-{rentCost})</button>
                   {!hasAltar ? (
                     <>
                        <div className="relative flex py-1 items-center"><div className="flex-grow border-t border-red-200"></div><span className="flex-shrink-0 mx-2 text-red-300 text-xs font-bold">OR</span><div className="flex-grow border-t border-red-200"></div></div>
                        <GameButton onClick={() => onDestroy(destroyCost, false)} disabled={coins < destroyCost} color="red" icon={Hammer}>æ‹†æ¯€ç‡Ÿå£˜ (-{destroyCost})</GameButton>
                        <div className="mt-2"><GameButton onClick={() => onDestroy(claimCost, true)} disabled={coins < claimCost} color="indigo" icon={Sword}>æ‹†æ¯€ä¸¦å»ºç«‹åŸæ±  (-{claimCost})</GameButton></div>
                        {coins < destroyCost && <p className="text-[10px] text-red-400 text-center font-bold">ä¿¡å¿ƒä¸è¶³ï¼Œç„¡æ³•æ‹†æ¯€</p>}
                     </>
                   ) : (
                     <div className="text-center border-t border-red-200 pt-2 mt-2"><p className="text-xs text-red-800 font-bold flex items-center justify-center gap-1"><Castle size={12}/> å°æ–¹å·²å»ºç«‹å …å›ºç¥­å£‡</p><p className="text-[10px] text-red-400 mt-0.5">ç„¡æ³•é€²è¡Œæ‹†æ¯€ï¼Œåªèƒ½çµ¦äºˆç¥ç¦ã€‚</p></div>
                   )}
                 </div>
               )
            }
            return null;
          };

          const HandHeartIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 14h2a2 2 0 1 0 0-4h-3c-.6 0-1.1.2-1.4.6L4 16h2a2 2 0 0 1 2 2v2"/><path d="M22 13a18.15 18.15 0 0 1-20 6"/></svg>;

          if (type === 'bible') return <BibleReader />;
          if (type === 'event_jesus') {
            const verse = BLESSING_VERSES[Math.floor(Math.random() * BLESSING_VERSES.length)];
            return (<div className="bg-white p-8 rounded-[2rem] shadow-2xl border-4 border-cyan-100 text-center relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-cyan-300 to-blue-400"></div><h3 className="text-2xl font-black text-cyan-600 mb-2 mt-2">âœï¸ é‡è¦‹è€¶ç©Œ</h3><p className="text-gray-500 mb-6 font-bold">ä½ åœ¨æ—…é€”ä¸­ç¶“æ­·äº†ä¸»çš„åŒåœ¨...</p><div className="bg-cyan-50 p-6 rounded-2xl mb-8 italic text-gray-700 relative text-lg font-medium leading-relaxed"><div className="absolute -top-3 -left-3 text-cyan-300"><Heart fill="currentColor" size={32}/></div>"{verse.text}" <div className="text-right text-sm font-black mt-3 text-cyan-600 uppercase tracking-wider">- {verse.ref}</div></div><GameButton onClick={() => onComplete(20, 100)} color="cyan">é ˜å—ç¥ç¦ (+100 ä¿¡å¿ƒ)</GameButton></div>);
          }
          if (type === 'event_paul') {
            return (<div className="bg-white p-8 rounded-[2rem] shadow-2xl border-4 border-indigo-100 text-center relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-300 to-purple-400"></div><h3 className="text-2xl font-black text-indigo-600 mb-2 mt-2">âš¡ å¤§é¦¬è‰²è·¯ä¸Šçš„å…‰</h3><p className="text-gray-600 mb-8 font-medium leading-relaxed">å¿½ç„¶å¾å¤©ä¸Šæœ‰å…‰å››é¢ç…§è‘—ä½ ...<br/>é›–ç„¶æš«æ™‚çœ‹ä¸è¦‹(æš«åœ)ï¼Œä½†ç”Ÿå‘½å°‡è¢«ç¿»è½‰ï¼</p><GameButton onClick={() => onComplete(50, 50, true)} color="indigo">é †æœå‘¼å¬ (+50 ä¿¡å¿ƒï¼Œæš«åœ)</GameButton></div>);
          }
          if (type === 'fate') return <FateEvent onComplete={onComplete} />;
          if (type === 'chance') return <ChanceEvent onComplete={onComplete} />;
          if (type === 'prayer') {
            const [input, setInput] = useState("");
            return (<div className="bg-white p-8 rounded-[2rem] shadow-2xl border-4 border-orange-100 text-center"><h3 className="text-2xl font-black text-orange-500 mb-2">ğŸ™ {tileData.name}</h3><p className="text-gray-400 mb-6 text-sm font-bold">åœ¨ä¸»é¢å‰å‚¾å¿ƒåæ„...</p><textarea className="w-full bg-orange-50 rounded-2xl p-4 mb-6 outline-none focus:ring-4 ring-orange-200/50 text-gray-700 font-medium resize-none transition-all" rows={3} placeholder="è¼¸å…¥ä½ çš„ç¦±å‘Š..." value={input} onChange={e=>setInput(e.target.value)} /><div className="w-full"><GameButton onClick={() => onComplete(20, 50)} color="orange" icon={Send} disabled={!input.trim()}>ç™¼å‡ºç¦±å‘Š (+50 ä¿¡å¿ƒ)</GameButton><div className="mt-4">{tileData.type === 'city' && <PropertyAction />}</div></div></div>);
          }
          if (type === 'city') {
             const isEnemyCity = tileData.owner === 'cpu';
             return (<div className="bg-white p-8 rounded-[2rem] shadow-2xl border-4 border-amber-100 text-center"><h3 className="text-2xl font-black text-amber-600 mb-2 flex items-center justify-center gap-2"><Castle size={24} /> {tileData.name}</h3><div className="mb-6 inline-block px-3 py-1 bg-gray-100 rounded-lg text-gray-500 text-xs font-bold tracking-wide">{tileData.owner === 'player' ? "ä½ çš„ç”¢æ¥­" : tileData.owner === 'cpu' ? `éè·¯è²»: ${tileData.rent * (tileData.level + 1)}` : "ç„¡ä¸»ä¹‹åœ°"}</div>{!tileData.owner && (<div className="bg-amber-50 p-4 rounded-xl mb-6 text-left border border-amber-100"><p className="text-xs text-amber-500 font-black mb-1 uppercase tracking-wide">City Info</p><p className="text-sm text-gray-700 font-medium leading-relaxed">é€™æ˜¯ä¸€åº§å …å›ºçš„åŸï¼Œéœ€è¦ä¿¡å¿ƒæ‰èƒ½æ”»ç ´ã€‚ä½”é ˜å¾Œå¯æ”¶å–å¥‰ç»é‡‘ã€‚</p></div>)}<PropertyAction />{!isEnemyCity && <button onClick={onClose} className="mt-6 text-gray-400 text-sm font-bold hover:text-gray-600 underline decoration-2 underline-offset-4">æš«ä¸è¡Œå‹•</button>}</div>)
          }
          return null;
        };

        const App = () => {
          const [gameState, setGameState] = useState('start');
          const [board, setBoard] = useState(INITIAL_BOARD_MAP);
          const [playerPos, setPlayerPos] = useState(0);
          const [cpuPos, setCpuPos] = useState(0);
          const [faith, setFaith] = useState(1000); 
          const [cpuFaith, setCpuFaith] = useState(1000);
          const [level, setLevel] = useState(1);
          const [xp, setXp] = useState(0);
          const [turn, setTurn] = useState('player'); 
          const [isMoving, setIsMoving] = useState(false);
          const [diceValue, setDiceValue] = useState(1);
          const [activeModal, setActiveModal] = useState(null);
          const [isFrozen, setIsFrozen] = useState(false);
          const [notification, setNotification] = useState(null);

          const playerProperties = board.filter(t => t.owner === 'player').length;
          const cpuProperties = board.filter(t => t.owner === 'cpu').length;

          const startGame = () => { setGameState('playing'); setFaith(1000); setCpuFaith(1000); setPlayerPos(0); setCpuPos(0); setBoard(INITIAL_BOARD_MAP); setLevel(1); };
          const notify = (text, color="bg-amber-500") => { setNotification({ text, color }); setTimeout(() => setNotification(null), 3000); };

          const rollDice = () => {
            if (isMoving || activeModal || turn !== 'player') return;
            if (isFrozen) {
              notify("ä»åœ¨æ› é‡çœæ€ä¸­... æš«åœä¸€å›", "bg-gray-500");
              setIsMoving(true); 
              setTimeout(() => { setIsFrozen(false); setIsMoving(false); setTurn('cpu'); }, 1500); 
              return;
            }
            const val = Math.floor(Math.random() * 6) + 1;
            setDiceValue(val); setIsMoving(true);
            moveToken('player', playerPos, val, (newPos) => { setPlayerPos(newPos); handleLandEvent(newPos, 'player'); });
          };

          useEffect(() => {
            if (gameState === 'playing' && turn === 'cpu') {
              setTimeout(() => {
                const val = Math.floor(Math.random() * 6) + 1;
                setDiceValue(val); setIsMoving(true);
                moveToken('cpu', cpuPos, val, (newPos) => { setCpuPos(newPos); handleCpuLandEvent(newPos); });
              }, 1000);
            }
          }, [turn, gameState]);

          const moveToken = (who, start, steps, callback) => {
            let current = start; let count = 0;
            const interval = setInterval(() => {
              current = (current + 1) % board.length;
              if (who === 'player') setPlayerPos(current); else setCpuPos(current);
              if (current === 0) {
                if (who === 'player') { setFaith(f => f + 300); notify("ç¶“éç´…æµ·(èµ·é»)ï¼ä¿¡å¿ƒå¤§å¢ +300", "bg-yellow-500"); } 
                else { setCpuFaith(f => f + 300); }
              }
              count++;
              if (count === steps) { clearInterval(interval); setIsMoving(false); callback(current); }
            }, 200);
          };

          const handleLandEvent = (pos, who) => {
            const tile = board[pos];
            if (tile.type !== 'start') { setTimeout(() => setActiveModal(tile.type), 500); } 
            else { setTurn('cpu'); }
          };

          const handleCpuLandEvent = (pos) => {
            const tile = board[pos];
            if (tile.owner === 'player') {
              const destroyCost = tile.price;
              if (tile.level === 0 && cpuFaith >= destroyCost && Math.random() < 0.4) {
                 const newBoard = [...board]; newBoard[pos].owner = null; newBoard[pos].level = 0; setBoard(newBoard);
                 setCpuFaith(f => f - destroyCost); notify(`ç³Ÿç³•ï¼é»‘å…¬ç¾Šæ”»ç ´äº†ä½ çš„ ${tile.name}ï¼`, "bg-red-500");
              } else {
                 const cost = tile.rent * (tile.level + 1); setCpuFaith(f => Math.max(0, f - cost)); setFaith(f => f + cost);
                 notify(`é»‘å…¬ç¾Šä¾†åˆ°ä½ çš„åŸï¼Œç²å¾—å¥‰ç» +${cost}`, "bg-green-500");
              }
            }
            else if (tile.type === 'city' && !tile.owner && cpuFaith >= tile.price) {
              if (Math.random() > 0.5) {
                const newBoard = [...board]; newBoard[pos].owner = 'cpu'; setBoard(newBoard);
                setCpuFaith(f => f - tile.price); notify(`é»‘å…¬ç¾Šæ”»ä½”äº† ${tile.name}!`, "bg-purple-400");
              }
            }
            else if (tile.type === 'city' && tile.owner === 'cpu' && cpuFaith >= tile.price * 0.6) {
              if (Math.random() > 0.7) {
                 const newBoard = [...board]; newBoard[pos].level += 1; setBoard(newBoard);
                 setCpuFaith(f => f - Math.floor(tile.price * 0.6));
                 const actionName = newBoard[pos].level === 1 ? "å»ºç«‹äº†ç¥­å£‡" : "é€²è¡Œäº†ç»ç¥­";
                 notify(`é»‘å…¬ç¾Šåœ¨ ${tile.name} ${actionName}ï¼`, "bg-purple-500");
              }
            }
            setTimeout(() => setTurn('player'), 1500);
          };

          const onModalComplete = (xpGain, faithChange, freeze = false) => {
            if (xpGain) { const nextXp = xp + xpGain; if (nextXp >= level * 100) { setLevel(l => l + 1); setXp(nextXp - level * 100); notify("éˆå‘½æˆé•·ï¼ç­‰ç´šæå‡ï¼", "bg-yellow-400"); } else { setXp(nextXp); } }
            if (faithChange) { setFaith(f => Math.max(0, f + faithChange)); if (faithChange > 0) notify(`ä¿¡å¿ƒå¢åŠ  +${faithChange}`); else notify(`ä¿¡å¿ƒæ¸›å°‘ ${Math.abs(faithChange)}`, faithChange < 0 ? "bg-red-400" : "bg-amber-500"); }
            if (freeze) setIsFrozen(true);
            setActiveModal(null); setTurn('cpu');
          };

          const handleBuy = (cost) => {
            const newBoard = [...board]; newBoard[playerPos].owner = 'player'; setBoard(newBoard);
            setFaith(f => f - cost); notify("å“ˆåˆ©è·¯äºï¼å¾—åœ°ç‚ºæ¥­ï¼", "bg-indigo-500"); setActiveModal(null); setTurn('cpu');
          };

          const handleUpgrade = (cost) => {
            const newBoard = [...board]; newBoard[playerPos].level += 1; setBoard(newBoard);
            const actionName = newBoard[playerPos].level === 1 ? "ç¥­å£‡å»ºé€ å®Œæˆ" : "ç»ç¥­å®Œæˆ";
            setFaith(f => f - cost); notify(`${actionName}ï¼Œæ©è†åŠ å€ï¼`, "bg-amber-500"); setActiveModal(null); setTurn('cpu');
          };

          const handleDestroy = (cost, claim = false) => {
            const newBoard = [...board];
            newBoard[playerPos].owner = claim ? 'player' : null;
            newBoard[playerPos].level = 0; 
            setBoard(newBoard);
            setFaith(f => f - cost);
            if (claim) notify("å“ˆåˆ©è·¯äºï¼æ”»ç ´ç‡Ÿå£˜ä¸¦å¾—åœ°ç‚ºæ¥­ï¼", "bg-indigo-500");
            else notify("ä¾é ç¥çš„å¤§èƒ½ï¼Œç‡Ÿå£˜å·²æ”»ç ´ï¼", "bg-red-500");
            setActiveModal(null); setTurn('cpu');
          };

          if (gameState === 'start') return <StartScreen onStart={startGame} />;

          return (
            <div className="min-h-screen flex flex-col items-center justify-center p-2 relative overflow-hidden">
              <div className="w-full max-w-md fixed top-4 z-30 px-4">
                <div className="glass-panel rounded-2xl p-4 shadow-floating border border-white/40">
                    <div className="flex justify-between items-center mb-3">
                        <div className="flex items-center gap-2"><span className="font-black text-amber-600 tracking-wide text-lg">CANAAN</span><div className="px-2 py-0.5 bg-yellow-100 text-yellow-700 text-[10px] font-bold rounded-full">Lv.{level}</div></div>
                    </div>
                    <div className="flex gap-3">
                        <div className={`flex-1 bg-gradient-to-br from-white to-indigo-50 rounded-xl p-2 border-2 transition-all duration-300 ${turn === 'player' ? 'border-indigo-400 shadow-md scale-105' : 'border-transparent opacity-60 grayscale'}`}>
                            <div className="flex justify-between text-[10px] font-bold text-gray-400 mb-1"><span>YOU</span><span className="bg-indigo-100 text-indigo-600 px-1.5 rounded-md flex items-center gap-0.5"><Castle size={8}/> {playerProperties}</span></div>
                            <div className="flex items-center gap-1.5 text-indigo-600 font-black text-xl"><Heart fill="currentColor" size={18} /> {faith}</div>
                        </div>
                        <div className={`flex-1 bg-gradient-to-br from-white to-purple-50 rounded-xl p-2 border-2 transition-all duration-300 ${turn === 'cpu' ? 'border-purple-400 shadow-md scale-105' : 'border-transparent opacity-60 grayscale'}`}>
                            <div className="flex justify-between text-[10px] font-bold text-gray-400 mb-1"><span>CPU</span><span className="bg-purple-100 text-purple-600 px-1.5 rounded-md flex items-center gap-0.5"><Castle size={8}/> {cpuProperties}</span></div>
                            <div className="flex items-center justify-end gap-1.5 text-purple-600 font-black text-xl">{cpuFaith} <Heart fill="currentColor" size={18} /></div>
                        </div>
                    </div>
                </div>
              </div>

              {notification && (<div className={`fixed top-40 z-50 px-6 py-3 rounded-full text-white font-bold shadow-xl animate-bounce text-center backdrop-blur-md ${notification.color}`}>{notification.text}</div>)}

              <div className="relative w-full max-w-md aspect-[9/16] mt-36 mb-4 p-2 scale-95">
                <div className="w-full h-full bg-[#E6C9A8] rounded-[2.5rem] shadow-[inset_0_0_40px_rgba(139,69,19,0.15)] relative border-8 border-[#D7CCC8] ring-4 ring-[#EFEBE9]">
                   <div className="absolute inset-0 m-auto w-[45%] h-[30%] flex flex-col items-center justify-center z-10">
                      <div className="w-32 h-32 rounded-full bg-[#FFF8E1] shadow-[inset_0_4px_10px_rgba(0,0,0,0.05)] border-4 border-white flex flex-col items-center justify-center mb-4 relative overflow-hidden">
                         <div className={`w-16 h-16 bg-white rounded-2xl shadow-md flex items-center justify-center border-2 border-orange-100 ${isMoving ? 'animate-spin' : ''}`}>{isMoving ? <RefreshCw className="text-orange-300" /> : <span className="text-4xl font-black text-gray-800">{diceValue}</span>}</div>
                         <div className="absolute bottom-3 text-[10px] font-bold text-gray-400 uppercase tracking-widest">{turn === 'player' ? (isFrozen ? "æ› é‡çœæ€ä¸­..." : "YOUR TURN") : "CPU TURN"}</div>
                      </div>
                      <button onClick={rollDice} disabled={turn !== 'player' || isMoving || activeModal} className={`w-full py-4 rounded-2xl font-black text-white shadow-lg text-lg flex items-center justify-center gap-2 transition-all transform active:scale-95 ${turn === 'player' && !isFrozen ? 'bg-gradient-to-r from-orange-400 to-amber-500' : 'bg-gray-300 cursor-not-allowed'}`}>{isFrozen ? <PauseCircle /> : <Dices />}{isFrozen ? "è·³éå›åˆ" : "æ“²éª°å­"}</button>
                   </div>
                   {board.map((tile, i) => {
                     const pos = getGridPosition(i);
                     const style = { left: `${pos.x * 25}%`, top: `${pos.y * 12.5}%`, width: '25%', height: '12.5%' };
                     let BuildingIcon = null;
                     if (tile.owner && tile.type === 'city') {
                        const colorClass = tile.owner === 'player' ? 'text-indigo-500 drop-shadow-[0_2px_0_rgba(99,102,241,0.5)]' : 'text-purple-600 drop-shadow-[0_2px_0_rgba(147,51,234,0.5)]';
                        const level = tile.level;
                        BuildingIcon = (
                            <div className={`absolute -top-3 right-0 flex items-end ${colorClass} z-20 transition-all duration-300`}>
                                <Castle size={18} fill="currentColor" />
                                {level >= 1 && (
                                    <div className="flex -ml-1 mb-1">
                                        {[...Array(level)].map((_, idx) => (
                                            <Flame key={idx} size={14} fill={tile.owner === 'player' ? '#F59E0B' : '#D946EF'} className={idx > 0 ? "-ml-2 text-white" : "text-white"} />
                                        ))}
                                    </div>
                                )}
                            </div>
                        );
                     }
                     const bgGradient = `bg-gradient-to-br ${tile.color}`;
                     const ownerBorder = tile.owner === 'player' ? 'border-indigo-400 ring-2 ring-indigo-200' : tile.owner === 'cpu' ? 'border-purple-400 ring-2 ring-purple-200' : 'border-white/60';
                     return (
                       <div key={tile.id} className="absolute p-1 transition-all" style={style}>
                         <div className={`w-full h-full rounded-xl shadow-tile flex flex-col items-center justify-center relative border-b-4 active:border-b-0 active:translate-y-[4px] transition-all overflow-visible ${bgGradient} ${ownerBorder}`}>
                            {BuildingIcon}
                            <div className="text-gray-600/80 transform scale-90 mb-0.5">{tile.icon}</div>
                            <div className="text-[9px] font-bold text-gray-700 leading-none text-center px-0.5 truncate w-full tracking-tighter">{tile.name || tile.label}</div>
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-30">{playerPos === i && (<div className="relative animate-hop z-40"><div className="text-2xl filter drop-shadow-lg -mt-4">ğŸ‘</div><div className="w-6 h-2 bg-black/20 rounded-full blur-[2px] absolute -bottom-1 left-1/2 -translate-x-1/2"></div></div>)}{cpuPos === i && (<div className="relative transition-all duration-500 mt-2 ml-4 z-30"><div className="text-2xl filter drop-shadow-lg" style={{filter: 'grayscale(100%) brightness(30%)'}}>ğŸ</div><div className="w-6 h-2 bg-black/20 rounded-full blur-[2px] absolute bottom-0 left-1/2 -translate-x-1/2"></div></div>)}</div>
                         </div>
                       </div>
                     )
                   })}
                   <div className="absolute bottom-16 w-full text-center opacity-20 pointer-events-none"><h2 className="text-5xl font-black text-[#8B4513] tracking-widest">CANAAN</h2></div>
                </div>
              </div>

              {activeModal && (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-[2px]"><div className="w-full max-w-sm animate-hop"><EventModal type={activeModal} tileData={board[playerPos]} coins={faith} isOwner={board[playerPos].owner === 'player'} isFrozen={isFrozen} onClose={() => { setActiveModal(null); setTurn('cpu'); }} onComplete={onModalComplete} onBuy={handleBuy} onUpgrade={handleUpgrade} onDestroy={handleDestroy} /></div></div>)}
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
