<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤©åœ‹å¤§å¯Œç¿ï¼šæ‡‰è¨±ä¹‹åœ°</title>
    
    <!-- å¼•å…¥ Tailwind CSS (æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¨­å®šå­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- å¼•å…¥ React å’Œ Babel (æ ¸å¿ƒå¼•æ“) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #93C5FD; border-radius: 4px; }
        .animate-blob { animation: blob 7s infinite; }
        @keyframes blob { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
    </style>
</head>
<body class="bg-[#FDF6E3]">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BookOpen, Heart, Star, MessageCircle, RefreshCw, Check, X, Dices, AlertCircle, PauseCircle, Home, MapPin, Sword, Cross, Scroll, Tent, Footprints, Loader, HelpCircle, AlertTriangle, Play, Info, Send, Hammer, Castle, Flag } from 'lucide-react';

        // --- è³‡æ–™åº« ---
        const BLESSING_VERSES = [
          { text: "ä½ ç•¶å‰›å¼·å£¯è†½ï¼ä¸è¦æ‡¼æ€•ï¼Œä¹Ÿä¸è¦é©šæƒ¶ã€‚", ref: "ç´„æ›¸äºè¨˜ 1:9" },
          { text: "æµæ·šæ’’ç¨®çš„ï¼Œå¿…æ­¡å‘¼æ”¶å‰²ã€‚", ref: "è©©ç¯‡ 126:5" },
          { text: "æˆ‘çš„æ©å…¸å¤ ä½ ç”¨çš„ï¼Œå› ç‚ºæˆ‘çš„èƒ½åŠ›æ˜¯åœ¨äººçš„è»Ÿå¼±ä¸Šé¡¯å¾—å®Œå…¨ã€‚", ref: "å“¥æ—å¤šå¾Œæ›¸ 12:9" },
          { text: "å£“å‚·çš„è˜†è‘¦ï¼Œä»–ä¸æŠ˜æ–·ï¼›å°‡æ®˜çš„ç‡ˆç«ï¼Œä»–ä¸å¹æ»…ã€‚", ref: "ä»¥è³½äºæ›¸ 42:3" },
        ];

        const BIBLE_BOOKS_MAPPING = {
          "å‰µä¸–è¨˜": "Genesis", "å‡ºåŸƒåŠè¨˜": "Exodus", "ç´„æ›¸äºè¨˜": "Joshua", "è©©ç¯‡": "Psalms", "ç®´è¨€": "Proverbs",
          "é¦¬å¤ªç¦éŸ³": "Matthew", "ç´„ç¿°ç¦éŸ³": "John", "ç¾…é¦¬æ›¸": "Romans", "å•Ÿç¤ºéŒ„": "Revelation"
        };
        const BIBLE_BOOKS = Object.keys(BIBLE_BOOKS_MAPPING);

        const TEMPTATIONS = [
          { text: "ç™¾å§“åœ¨æ› é‡ç™¼æ€¨è¨€ï¼Œä¿¡å¿ƒå‹•æ–ã€‚", penalty: 30, freeze: false, title: "æ€¨è¨€çš„ç¶²ç¾…" },
          { text: "è£½é€ äº†é‡‘ç‰›çŠ¢ï¼Œå¾—ç½ªäº†ç¥ã€‚", penalty: 50, freeze: true, title: "å¶åƒçš„è©¦æ¢" },
          { text: "è½ä¿¡æ¢å­çš„æƒ¡ä¿¡ï¼Œä¸æ•¢é€²å»ã€‚", penalty: 20, freeze: true, title: "è†½æ€¯çš„å¿ƒ" },
          { text: "å› ç‚ºè²ªæ„›ä¸–ç•Œï¼Œåº•é¦¬é›¢æ£„äº†é“ç†ã€‚", penalty: 40, freeze: false, title: "ä¸–ç•Œçš„èª˜æƒ‘" },
        ];

        const TRIVIA_QUESTIONS = [
          { q: "ä»¥è‰²åˆ—äººç¹è¡Œè€¶åˆ©å“¥åŸå¹¾å¤©å¾ŒåŸç‰†å€’å¡Œï¼Ÿ", options: ["3å¤©", "7å¤©", "12å¤©"], ans: 1, reward: 50 },
          { q: "èª°åœ¨ç´„æ—¦æ²³ç‚ºè€¶ç©Œæ–½æ´—ï¼Ÿ", options: ["å½¼å¾—", "æ–½æ´—ç´„ç¿°", "ä¿ç¾…"], ans: 1, reward: 50 },
          { q: "ä¿ç¾…åœ¨å“ªè£¡çœ‹è¦‹å¤§å…‰è€Œæ‚”æ”¹ï¼Ÿ", options: ["è€¶è·¯æ’’å†·", "å¤§é¦¬è‰²è·¯ä¸Š", "ç¾…é¦¬"], ans: 1, reward: 60 },
          { q: "è€¶ç©Œçš„ç¬¬ä¸€å€‹ç¥è¹Ÿæ˜¯ä»€éº¼ï¼Ÿ", options: ["æ°´è®Šé…’", "äº”é¤…äºŒé­š", "é†«æ²»çå­"], ans: 0, reward: 40 },
        ];

        // --- æ£‹ç›¤è¨­å®š ---
        const INITIAL_BOARD_MAP = [
          { id: 0, type: 'start', label: 'éç´…æµ·', name: 'å‡ºåŸƒåŠ', color: 'bg-yellow-200', icon: <Footprints size={18} /> },
          { id: 1, type: 'city', label: 'åŸæ± ', name: 'è€¶åˆ©å“¥', price: 100, rent: 20, owner: null, level: 0, color: 'bg-amber-100', icon: <Tent size={18} /> },
          { id: 2, type: 'temptation', label: 'å‘½é‹', name: 'æ› é‡', color: 'bg-purple-100', icon: <AlertTriangle size={18} /> },
          { id: 3, type: 'city', label: 'åŸæ± ', name: 'è‰¾åŸ', price: 120, rent: 25, owner: null, level: 0, color: 'bg-amber-100', icon: <Tent size={18} /> },
          { id: 4, type: 'bible', label: 'è®€ç¶“', name: 'æœƒå¹•', color: 'bg-blue-100', icon: <Scroll size={18} /> },
          { id: 5, type: 'city', label: 'åŸæ± ', name: 'åŸºé', price: 140, rent: 30, owner: null, level: 0, color: 'bg-amber-100', icon: <Tent size={18} /> },
          { id: 6, type: 'event_jesus', label: 'æ©å…¸', name: 'åŠ åˆ©åˆ©æµ·', color: 'bg-cyan-100', icon: <Cross size={18} /> },
          { id: 7, type: 'city', label: 'åŸæ± ', name: 'å¸Œä¼¯å´™', price: 160, rent: 35, owner: null, level: 0, color: 'bg-amber-100', icon: <Tent size={18} /> },
          { id: 8, type: 'chance', label: 'æ©Ÿæœƒ', name: 'æ™ºæ…§é–€', color: 'bg-yellow-100', icon: <HelpCircle size={18} /> },
          { id: 9, type: 'city', label: 'åŸæ± ', name: 'ä¼¯ç‰¹åˆ©', price: 150, rent: 30, owner: null, level: 0, color: 'bg-amber-100', icon: <Tent size={18} /> },
          { id: 10, type: 'prayer', label: 'ç¦±å‘Š', name: 'å®¢è¥¿é¦¬å°¼', color: 'bg-orange-100', icon: <MessageCircle size={18} /> },
          { id: 11, type: 'city', label: 'é‡é®', name: 'è€¶è·¯æ’’å†·', price: 300, rent: 60, owner: null, level: 0, color: 'bg-rose-100', icon: <Home size={18} /> },
          { id: 12, type: 'event_paul', label: 'äº‹ä»¶', name: 'å¤§é¦¬è‰²è·¯', color: 'bg-indigo-100', icon: <MapPin size={18} /> },
          { id: 13, type: 'city', label: 'åŸæ± ', name: 'ç¤ºåŠ', price: 200, rent: 40, owner: null, level: 0, color: 'bg-amber-100', icon: <Tent size={18} /> },
          { id: 14, type: 'bible', label: 'è®€ç¶“', name: 'åº‡å“©äº', color: 'bg-blue-100', icon: <Scroll size={18} /> },
          { id: 15, type: 'city', label: 'åŸæ± ', name: 'ç¤ºç¾…', price: 180, rent: 35, owner: null, level: 0, color: 'bg-amber-100', icon: <Tent size={18} /> },
          { id: 16, type: 'temptation', label: 'å‘½é‹', name: 'é¢¨æµª', color: 'bg-purple-100', icon: <AlertTriangle size={18} /> },
          { id: 17, type: 'city', label: 'åŸæ± ', name: 'åˆ¥æ˜¯å·´', price: 220, rent: 45, owner: null, level: 0, color: 'bg-amber-100', icon: <Tent size={18} /> },
          { id: 18, type: 'chance', label: 'æ©Ÿæœƒ', name: 'ä¿¡å¿ƒé–€', color: 'bg-yellow-100', icon: <HelpCircle size={18} /> },
          { id: 19, type: 'city', label: 'åŸæ± ', name: 'å¤ç‘£', price: 250, rent: 50, owner: null, level: 0, color: 'bg-amber-100', icon: <Tent size={18} /> },
        ];

        const getGridPosition = (index) => {
          if (index <= 3) return { x: index, y: 0 };
          if (index <= 9) return { x: 3, y: index - 3 };
          if (index <= 13) return { x: 3 - (index - 10), y: 7 };
          if (index <= 19) return { x: 0, y: 7 - (index - 13) };
          return { x: 0, y: 0 };
        };

        // --- Start Screen ---
        const StartScreen = ({ onStart }) => {
          return (
            <div className="min-h-screen bg-[#FDF6E3] font-[Zen_Maru_Gothic] flex flex-col items-center justify-center p-6 text-center relative overflow-hidden">
              <div className="absolute top-10 left-10 text-amber-200 animate-blob"><Star size={80} /></div>
              <div className="absolute bottom-20 right-10 text-blue-200 animate-blob"><Heart size={100} /></div>
              <div className="z-10 max-w-md w-full bg-white/80 backdrop-blur-sm p-8 rounded-[3rem] shadow-2xl border-8 border-[#EAD6BB]">
                <h1 className="text-4xl font-black text-amber-600 mb-2 tracking-wider drop-shadow-sm">å¤©åœ‹å¤§å¯Œç¿</h1>
                <h2 className="text-xl font-bold text-[#8B4513] mb-8">- æ‡‰è¨±ä¹‹åœ°ç¯‡ -</h2>
                <div className="flex justify-center items-center gap-6 mb-8">
                  <div className="flex flex-col items-center animate-bounce">
                    <div className="text-6xl drop-shadow-md">ğŸ‘</div>
                    <span className="text-sm font-bold text-gray-500 mt-2 bg-white px-2 rounded-full">ä½  (ç¶¿ç¾Š)</span>
                  </div>
                  <div className="text-2xl font-black text-amber-400">VS</div>
                  <div className="flex flex-col items-center animate-pulse">
                    <div className="text-6xl drop-shadow-md" style={{filter: 'grayscale(100%) brightness(30%)'}}>ğŸ</div>
                    <span className="text-sm font-bold text-gray-500 mt-2 bg-white px-2 rounded-full">é»‘å…¬ç¾Š</span>
                  </div>
                </div>
                <div className="bg-[#FFF8E7] p-4 rounded-2xl text-left mb-8 border-2 border-[#EAD6BB]">
                  <h3 className="font-bold text-amber-600 mb-3 flex items-center gap-2"><Info size={18} /> éŠæˆ²è¦å‰‡</h3>
                  <ul className="text-sm text-gray-600 space-y-2 font-medium">
                    <li className="flex items-start gap-2"><span className="text-amber-500">1.</span> <span>ç´¯ç© <span className="text-indigo-500 font-bold">ä¿¡å¿ƒå€¼ (Faith)</span> ä¾†æ¦®è€€ç¥ã€‚</span></li>
                    <li className="flex items-start gap-2"><span className="text-amber-500">2.</span> <span>è¸©åˆ°åŸæ± å¯ <span className="font-bold">å¾—åœ°ç‚ºæ¥­</span>ï¼Œå»ºç«‹ç¥­å£‡ã€‚</span></li>
                    <li className="flex items-start gap-2"><span className="text-amber-500">3.</span> <span>è‹¥è¸©åˆ°å°æ–¹çš„åœ°ï¼Œå¯é¸æ“‡ <span className="text-red-500 font-bold">æ”»ç ´ç‡Ÿå£˜ (æ‹†æ¯€)</span> å¥ªå›ä¸»æ¬Šï¼</span></li>
                    <li className="flex items-start gap-2"><span className="text-amber-500">4.</span> <span>æ¯”é»‘å…¬ç¾Šæ“æœ‰æ›´å¤šä¿¡å¿ƒèˆ‡åœŸåœ°ï¼Œæˆç‚ºå¤©åœ‹å¤§è´å®¶ï¼</span></li>
                  </ul>
                </div>
                <button onClick={onStart} className="w-full bg-gradient-to-r from-amber-400 to-orange-500 text-white text-xl font-black py-4 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center justify-center gap-2 group">
                  <Play fill="currentColor" className="group-hover:translate-x-1 transition-transform" /> é–‹å§‹å†’éšª
                </button>
              </div>
              <p className="absolute bottom-6 text-gray-400 text-xs font-bold">Design by å±¬éˆçˆ­æˆ°å°çµ„</p>
            </div>
          );
        };

        // --- Modal ---
        const EventModal = ({ type, tileData, onClose, onComplete, coins, isOwner, onBuy, onUpgrade, onDestroy }) => {
          const btnClass = "w-full py-3 rounded-xl font-bold shadow-md transition-all active:scale-95 flex items-center justify-center gap-2";
          const [isFlipped, setIsFlipped] = useState(false);

          const HandHeartIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 14h2a2 2 0 1 0 0-4h-3c-.6 0-1.1.2-1.4.6L4 16h2a2 2 0 0 1 2 2v2"/><path d="M22 13a18.15 18.15 0 0 1-20 6"/></svg>;

          const CardFlip = ({ frontTitle, frontColor, backContent, icon }) => (
            <div className="relative w-full h-[400px] perspective-1000 cursor-pointer" onClick={() => !isFlipped && setIsFlipped(true)}>
              <div className={`relative w-full h-full transition-all duration-700 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                <div className={`absolute w-full h-full ${frontColor} rounded-3xl shadow-xl flex flex-col items-center justify-center backface-hidden border-4 border-white`}>
                  <div className="text-white opacity-90 animate-pulse">{icon}</div>
                  <h3 className="text-3xl font-black text-white mt-4 tracking-widest">{frontTitle}</h3>
                  <p className="text-white/80 mt-2 text-sm font-bold animate-bounce">é»æ“Šç¿»é–‹</p>
                </div>
                <div className="absolute w-full h-full bg-white rounded-3xl shadow-xl flex flex-col items-center justify-center p-6 backface-hidden rotate-y-180 border-4 border-gray-100 overflow-y-auto">{backContent}</div>
              </div>
            </div>
          );

          const BibleReader = () => {
            const [bookName] = useState(BIBLE_BOOKS[Math.floor(Math.random() * BIBLE_BOOKS.length)]);
            const [chapter] = useState(Math.floor(Math.random() * 5) + 1);
            const [content, setContent] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(false);
            useEffect(() => {
              const fetchBible = async () => {
                setLoading(true);
                const engBook = BIBLE_BOOKS_MAPPING[bookName];
                try {
                  const res = await fetch(`https://bible-api.com/${engBook}+${chapter}?translation=cuv`);
                  const data = await res.json();
                  if (data.verses) setContent(data.verses); else setError(true);
                } catch (err) { setError(true); }
                setLoading(false);
              };
              fetchBible();
            }, [bookName, chapter]);
            return (
              <div className="bg-white rounded-3xl shadow-xl border-4 border-blue-100 flex flex-col h-[500px] overflow-hidden">
                <div className="bg-blue-50 p-4 border-b border-blue-100 flex-shrink-0">
                   <h3 className="text-xl font-bold text-blue-800 text-center flex items-center justify-center gap-2"><BookOpen size={20} /> æ¯æ—¥éˆç³§</h3>
                   <p className="text-center text-blue-600 font-bold mt-1">{bookName} ç¬¬ {chapter} ç« </p>
                </div>
                <div className="flex-1 overflow-y-auto p-6 bg-white custom-scrollbar">
                   {loading ? <div className="h-full flex flex-col items-center justify-center text-gray-400 gap-2"><Loader className="animate-spin" /><p>æ­£åœ¨ç¿»é–‹è–ç¶“...</p></div> : 
                    error ? <div className="h-full flex flex-col items-center justify-center text-red-400 gap-2"><AlertCircle /><p>é€£ç·šå¤±æ•—ã€‚</p></div> : 
                     <div className="space-y-4">{content.map((v, idx) => (<div key={idx} className="flex gap-2 text-gray-700 leading-relaxed text-justify"><span className="text-xs font-bold text-blue-400 mt-1 shrink-0">{v.verse}</span><span>{v.text}</span></div>))}<div className="h-8"></div><div className="text-center text-gray-400 text-sm">--- æœ¬ç« çµæŸ ---</div></div>}
                </div>
                <div className="p-4 border-t border-gray-100 flex-shrink-0 bg-gray-50">
                   <button onClick={() => onComplete(30, 80)} disabled={loading || error} className={`${btnClass} ${loading || error ? 'bg-gray-300 text-gray-500' : 'bg-blue-500 text-white hover:bg-blue-600'}`}>{loading ? "è®€å–ä¸­..." : <><Check size={20} /> æˆ‘è®€å®Œäº† (+80 ä¿¡å¿ƒ)</>}</button>
                </div>
              </div>
            );
          };

          const PropertyAction = () => {
            if (tileData.type !== 'city') return null;
            
            if (isOwner) {
              const upgradeCost = Math.floor(tileData.price * 0.6);
              return (<div className="mt-4 pt-4 border-t border-gray-100"><p className="text-sm text-gray-500 mb-2">é€™æ˜¯ä½ çš„å±¬åœ° (Lv.{tileData.level})</p><button onClick={() => onUpgrade(upgradeCost)} disabled={coins < upgradeCost} className={`${btnClass} ${coins >= upgradeCost ? 'bg-amber-400 text-white' : 'bg-gray-200 text-gray-400'}`}><Home size={18} /> å»ºç«‹ç¥­å£‡/æ•™æœƒ (-{upgradeCost} ä¿¡å¿ƒ)</button></div>);
            }
            
            if (!tileData.owner) {
              return (<div className="mt-4 pt-4 border-t border-gray-100"><p className="text-sm text-gray-500 mb-2">æ­¤åœ°ç„¡äººçœ‹å®ˆï¼Œæ˜¯å¦å¾—åœ°ç‚ºæ¥­ï¼Ÿ</p><button onClick={() => onBuy(tileData.price)} disabled={coins < tileData.price} className={`${btnClass} ${coins >= tileData.price ? 'bg-indigo-500 text-white hover:bg-indigo-600' : 'bg-gray-200 text-gray-400'}`}><Sword size={18} /> æ”»ä½”é€™åº§åŸ (-{tileData.price} ä¿¡å¿ƒ)</button></div>);
            }
            
            if (tileData.owner === 'cpu') {
               const rentCost = tileData.rent * (tileData.level + 1);
               const destroyCost = tileData.price; 
               return (
                 <div className="mt-4 pt-4 border-t border-red-100 bg-red-50 p-3 rounded-lg space-y-3">
                   <div className="text-center">
                     <p className="text-red-500 font-bold mb-1">âš ï¸ é€™æ˜¯é»‘å…¬ç¾Šçš„ç‡Ÿå£˜ï¼</p>
                     <p className="text-gray-600 text-xs">é¸æ“‡ 1: çµ¦äºˆç¥ç¦ (ä»˜éè·¯è²»)</p>
                   </div>
                   
                   <button onClick={() => onComplete(0, -rentCost)} className={`${btnClass} bg-gray-400 text-white hover:bg-gray-500`}>
                     <HandHeartIcon /> çµ¦äºˆç¥ç¦ (-{rentCost})
                   </button>

                   <div className="relative flex py-1 items-center"><div className="flex-grow border-t border-red-200"></div><span className="flex-shrink-0 mx-2 text-red-300 text-xs">OR</span><div className="flex-grow border-t border-red-200"></div></div>

                   <button onClick={() => onDestroy(destroyCost)} disabled={coins < destroyCost} className={`${btnClass} ${coins >= destroyCost ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-red-200 text-white cursor-not-allowed'}`}>
                     <Hammer size={18} /> æ‹†æ¯€ç¥­å£‡ (-{destroyCost})
                   </button>
                   {coins < destroyCost && <p className="text-[10px] text-red-300 text-center">ä¿¡å¿ƒä¸è¶³ï¼Œç„¡æ³•æ‹†æ¯€</p>}
                 </div>
               )
            }
            return null;
          };

          if (type === 'bible') return <BibleReader />;
          if (type === 'event_jesus') {
            const verse = BLESSING_VERSES[Math.floor(Math.random() * BLESSING_VERSES.length)];
            return (<div className="bg-white p-6 rounded-3xl shadow-xl border-4 border-cyan-100 text-center"><h3 className="text-xl font-bold text-cyan-600 mb-2">âœï¸ é‡è¦‹è€¶ç©Œ</h3><p className="text-gray-600 mb-4">ä½ åœ¨æ—…é€”ä¸­ç¶“æ­·äº†ä¸»çš„åŒåœ¨...</p><div className="bg-cyan-50 p-4 rounded-xl mb-6 italic text-gray-700 relative"><div className="absolute -top-3 -left-3 text-cyan-300"><Heart fill="currentColor" size={24}/></div>"{verse.text}" <div className="text-right text-xs font-bold mt-2 text-cyan-500">- {verse.ref}</div></div><button onClick={() => onComplete(20, 100)} className={`${btnClass} bg-cyan-500 text-white`}>é ˜å—ç¥ç¦ (+100 ä¿¡å¿ƒ)</button></div>);
          }
          if (type === 'event_paul') {
            return (<div className="bg-white p-6 rounded-3xl shadow-xl border-4 border-indigo-100 text-center"><h3 className="text-xl font-bold text-indigo-600 mb-2">âš¡ å¤§é¦¬è‰²è·¯ä¸Šçš„å…‰</h3><p className="text-gray-600 mb-6 text-sm">å¿½ç„¶å¾å¤©ä¸Šæœ‰å…‰å››é¢ç…§è‘—ä½ ...<br/>é›–ç„¶æš«æ™‚çœ‹ä¸è¦‹(æš«åœ)ï¼Œä½†ç”Ÿå‘½å°‡è¢«ç¿»è½‰ï¼</p><button onClick={() => onComplete(50, 50, true)} className={`${btnClass} bg-indigo-500 text-white`}>é †æœå‘¼å¬ (+50 ä¿¡å¿ƒï¼Œæš«åœä¸€å›)</button></div>);
          }
          if (type === 'temptation') {
            const temp = TEMPTATIONS[Math.floor(Math.random() * TEMPTATIONS.length)];
            const backContent = (<><h3 className="text-2xl font-black text-purple-600 mb-2">{temp.title}</h3><div className="my-6 text-center"><p className="text-lg font-bold text-gray-800 mb-4 leading-relaxed">{temp.text}</p><div className="inline-block bg-red-50 border border-red-100 px-4 py-2 rounded-lg"><p className="text-red-500 font-bold">ä¿¡å¿ƒå€¼ -{temp.penalty}</p>{temp.freeze && <p className="text-red-400 text-sm mt-1 flex items-center justify-center gap-1"><PauseCircle size={14}/> æš«åœä¸€å›åˆ</p>}</div></div><button onClick={() => onComplete(0, -temp.penalty, temp.freeze)} className={`${btnClass} bg-purple-500 text-white hover:bg-purple-600`}>æ‚”æ”¹æ±‚ä¸»èµ¦å…</button></>);
            return (<CardFlip frontTitle="å‘½é‹ç‰Œ" frontColor="bg-gradient-to-br from-purple-500 to-indigo-600" icon={<AlertTriangle size={64} />} backContent={backContent} />);
          }
          if (type === 'chance') {
            const [qIndex] = useState(Math.floor(Math.random() * TRIVIA_QUESTIONS.length));
            const q = TRIVIA_QUESTIONS[qIndex];
            const [status, setStatus] = useState('ask');
            const handleAns = (idx) => { 
                if (idx === q.ans) { 
                    setStatus('correct'); 
                    setTimeout(() => onComplete(20, q.reward), 1500); 
                } else { 
                    setStatus('wrong'); 
                    setTimeout(() => onComplete(0, 0, true), 1500); 
                } 
            };
            const backContent = (<><h3 className="text-2xl font-black text-amber-500 mb-4">è–ç¶“å†·çŸ¥è­˜</h3>{status === 'ask' && (<div className="w-full"><p className="text-gray-800 font-bold mb-6 text-lg text-center leading-relaxed">{q.q}</p><div className="space-y-3">{q.options.map((opt, idx) => (<button key={idx} onClick={() => handleAns(idx)} className="w-full bg-amber-50 text-amber-800 py-3 rounded-xl font-bold hover:bg-amber-100 transition-colors border border-amber-200">{opt}</button>))}</div></div>)}{status === 'correct' && (<div className="py-8 animate-bounce text-green-500 text-center"><Check size={64} className="mx-auto mb-4" /><p className="text-xl font-bold">ç­”å°äº†ï¼ +{q.reward} ä¿¡å¿ƒ</p></div>)}{status === 'wrong' && (<div className="py-8 animate-shake text-red-400 text-center"><X size={64} className="mx-auto mb-4" /><p className="text-xl font-bold">ç­”éŒ¯äº†... æš«åœä¸€å›</p></div>)}</>);
            return (<CardFlip frontTitle="æ©Ÿæœƒç‰Œ" frontColor="bg-gradient-to-br from-amber-400 to-orange-500" icon={<HelpCircle size={64} />} backContent={backContent} />);
          }
          if (type === 'prayer') {
            const [input, setInput] = useState("");
            return (<div className="bg-white p-6 rounded-3xl shadow-xl border-4 border-orange-100 text-center"><h3 className="text-xl font-bold text-orange-500 mb-2">ğŸ™ {tileData.name}</h3><p className="text-gray-500 mb-4 text-sm">åœ¨ä¸»é¢å‰å‚¾å¿ƒåæ„...</p><textarea className="w-full bg-orange-50 rounded-xl p-3 mb-4 outline-none focus:ring-2 ring-orange-200" rows={3} placeholder="è¼¸å…¥ä½ çš„ç¦±å‘Š..." value={input} onChange={e=>setInput(e.target.value)} /><div><button onClick={() => onComplete(20, 50)} className={`${btnClass} bg-orange-400 text-white`}><Send size={18} /> ç™¼å‡ºç¦±å‘Š (+50 ä¿¡å¿ƒ)</button><PropertyAction /></div></div>);
          }
          if (type === 'city') {
             // ä¿®æ­£ï¼šç•¶æ˜¯ CPU çš„åŸæ± æ™‚ï¼Œä¸é¡¯ç¤ºã€Œæš«ä¸è¡Œå‹•ã€
             const isEnemyCity = tileData.owner === 'cpu';
             
             return (<div className="bg-white p-6 rounded-3xl shadow-xl border-4 border-amber-100 text-center"><h3 className="text-xl font-bold text-amber-600 mb-2">ğŸ° {tileData.name}</h3><div className="mb-4 text-gray-500 text-sm">{tileData.owner === 'player' ? "é€™æ˜¯ä½ çš„ç”¢æ¥­" : tileData.owner === 'cpu' ? `éè·¯å¥‰ç»é‡‘: ${tileData.rent}` : "ç„¡ä¸»ä¹‹åœ°"}</div>{!tileData.owner && (<div className="bg-amber-50 p-4 rounded-xl mb-4 text-left"><p className="text-xs text-gray-500 font-bold mb-1">åŸæ± ä»‹ç´¹ï¼š</p><p className="text-sm text-gray-700">é€™æ˜¯ä¸€åº§å …å›ºçš„åŸï¼Œéœ€è¦ä¿¡å¿ƒæ‰èƒ½æ”»ç ´ã€‚ä½”é ˜å¾Œå¯æ”¶å–å¥‰ç»é‡‘ã€‚</p></div>)}<PropertyAction />{!isEnemyCity && <button onClick={onClose} className="mt-4 text-gray-400 text-sm underline">æš«ä¸è¡Œå‹•</button>}</div>)
          }
          return null;
        };

        const App = () => {
          const [gameState, setGameState] = useState('start');
          const [board, setBoard] = useState(INITIAL_BOARD_MAP);
          const [playerPos, setPlayerPos] = useState(0);
          const [cpuPos, setCpuPos] = useState(0);
          const [faith, setFaith] = useState(1000); 
          const [cpuFaith, setCpuFaith] = useState(1000);
          const [level, setLevel] = useState(1);
          const [xp, setXp] = useState(0);
          const [turn, setTurn] = useState('player'); 
          const [isMoving, setIsMoving] = useState(false);
          const [diceValue, setDiceValue] = useState(1);
          const [activeModal, setActiveModal] = useState(null);
          const [isFrozen, setIsFrozen] = useState(false);
          const [notification, setNotification] = useState(null);

          // è¨ˆç®—ç”¢æ¥­æ•¸é‡
          const playerProperties = board.filter(t => t.owner === 'player').length;
          const cpuProperties = board.filter(t => t.owner === 'cpu').length;

          const startGame = () => {
            setGameState('playing');
            setFaith(1000); setCpuFaith(1000); setPlayerPos(0); setCpuPos(0);
            setBoard(INITIAL_BOARD_MAP); setLevel(1);
          };

          const notify = (text, color="bg-amber-500") => {
            setNotification({ text, color }); setTimeout(() => setNotification(null), 3000);
          };

          const rollDice = () => {
            if (isMoving || activeModal || turn !== 'player') return;
            
            if (isFrozen) {
              notify("ä»åœ¨æ› é‡çœæ€ä¸­... æš«åœä¸€å›", "bg-gray-500");
              setIsMoving(true); 
              setTimeout(() => { 
                  setIsFrozen(false); 
                  setIsMoving(false);
                  setTurn('cpu'); 
              }, 1500); 
              return;
            }
            
            const val = Math.floor(Math.random() * 6) + 1;
            setDiceValue(val); setIsMoving(true);
            moveToken('player', playerPos, val, (newPos) => { setPlayerPos(newPos); handleLandEvent(newPos, 'player'); });
          };

          useEffect(() => {
            if (gameState === 'playing' && turn === 'cpu') {
              setTimeout(() => {
                const val = Math.floor(Math.random() * 6) + 1;
                setDiceValue(val); setIsMoving(true);
                moveToken('cpu', cpuPos, val, (newPos) => { setCpuPos(newPos); handleCpuLandEvent(newPos); });
              }, 1000);
            }
          }, [turn, gameState]);

          const moveToken = (who, start, steps, callback) => {
            let current = start; let count = 0;
            const interval = setInterval(() => {
              current = (current + 1) % board.length;
              if (who === 'player') setPlayerPos(current); else setCpuPos(current);
              if (current === 0) {
                if (who === 'player') { setFaith(f => f + 300); notify("ç¶“éç´…æµ·(èµ·é»)ï¼ä¿¡å¿ƒå¤§å¢ +300", "bg-yellow-500"); } 
                else { setCpuFaith(f => f + 300); }
              }
              count++;
              if (count === steps) { clearInterval(interval); setIsMoving(false); callback(current); }
            }, 200);
          };

          const handleLandEvent = (pos, who) => {
            const tile = board[pos];
            if (tile.type !== 'city' && tile.owner === 'cpu') {
               // Non-city owned logic
            }
            if (tile.type !== 'start') { setTimeout(() => setActiveModal(tile.type), 500); } 
            else { setTurn('cpu'); }
          };

          const handleCpuLandEvent = (pos) => {
            const tile = board[pos];
            if (tile.owner === 'player') {
              const destroyCost = tile.price;
              if (cpuFaith >= destroyCost && Math.random() < 0.4) {
                 const newBoard = [...board];
                 newBoard[pos].owner = null;
                 newBoard[pos].level = 0;
                 setBoard(newBoard);
                 setCpuFaith(f => f - destroyCost);
                 notify(`ç³Ÿç³•ï¼é»‘å…¬ç¾Šæ”»ç ´äº†ä½ çš„ ${tile.name}ï¼`, "bg-red-500");
              } else {
                 const cost = tile.rent * (tile.level + 1);
                 setCpuFaith(f => Math.max(0, f - cost)); setFaith(f => f + cost);
                 notify(`é»‘å…¬ç¾Šä¾†åˆ°ä½ çš„åŸï¼Œç²å¾—å¥‰ç» +${cost}`, "bg-green-500");
              }
            }
            else if (tile.type === 'city' && !tile.owner && cpuFaith >= tile.price) {
              if (Math.random() > 0.5) {
                const newBoard = [...board]; newBoard[pos].owner = 'cpu'; setBoard(newBoard);
                setCpuFaith(f => f - tile.price); notify(`é»‘å…¬ç¾Šæ”»ä½”äº† ${tile.name}!`, "bg-purple-400");
              }
            }
            setTimeout(() => setTurn('player'), 1500);
          };

          const onModalComplete = (xpGain, faithChange, freeze = false) => {
            if (xpGain) {
              const nextXp = xp + xpGain;
              if (nextXp >= level * 100) { setLevel(l => l + 1); setXp(nextXp - level * 100); notify("éˆå‘½æˆé•·ï¼ç­‰ç´šæå‡ï¼", "bg-yellow-400"); } 
              else { setXp(nextXp); }
            }
            if (faithChange) {
              setFaith(f => Math.max(0, f + faithChange));
              if (faithChange > 0) notify(`ä¿¡å¿ƒå¢åŠ  +${faithChange}`);
              else notify(`ä¿¡å¿ƒæ¸›å°‘ ${Math.abs(faithChange)}`, faithChange < 0 ? "bg-red-400" : "bg-amber-500");
            }
            if (freeze) setIsFrozen(true);
            setActiveModal(null); setTurn('cpu');
          };

          const handleBuy = (cost) => {
            const newBoard = [...board]; newBoard[playerPos].owner = 'player'; setBoard(newBoard);
            setFaith(f => f - cost); notify("å“ˆåˆ©è·¯äºï¼å¾—åœ°ç‚ºæ¥­ï¼", "bg-indigo-500"); setActiveModal(null); setTurn('cpu');
          };

          const handleUpgrade = (cost) => {
            const newBoard = [...board]; newBoard[playerPos].level += 1; setBoard(newBoard);
            setFaith(f => f - cost); notify("ç¥­å£‡å»ºé€ å®Œæˆï¼Œæ©å…¸åŠ å€ï¼", "bg-amber-500"); setActiveModal(null); setTurn('cpu');
          };

          const handleDestroy = (cost) => {
            const newBoard = [...board];
            newBoard[playerPos].owner = null; 
            newBoard[playerPos].level = 0;
            setBoard(newBoard);
            setFaith(f => f - cost);
            notify("ä¾é ç¥çš„å¤§èƒ½ï¼Œç‡Ÿå£˜å·²æ”»ç ´ï¼", "bg-red-500");
            setActiveModal(null);
            setTurn('cpu');
          };

          if (gameState === 'start') return <StartScreen onStart={startGame} />;

          return (
            <div className="min-h-screen bg-[#FDF6E3] font-[Zen_Maru_Gothic] flex flex-col items-center justify-center p-2 overflow-hidden relative text-gray-800">
              {/* Top Info */}
              <div className="w-full max-w-md bg-white/80 backdrop-blur-md rounded-b-3xl shadow-sm p-4 z-20 absolute top-0">
                <div className="flex justify-between items-center mb-3">
                   <h1 className="text-lg font-black text-amber-600 tracking-wider">å¤©åœ‹å¤§å¯Œç¿ï¼šæ‡‰è¨±ä¹‹åœ°</h1>
                   <div className="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold">Lv.{level} éˆå‘½</div>
                </div>
                <div className="flex justify-between items-stretch gap-2">
                   <div className={`flex-1 p-2 rounded-xl transition-all border-2 ${turn === 'player' ? 'bg-indigo-50 border-indigo-200 scale-105 shadow-md' : 'bg-white/50 border-transparent opacity-70'}`}>
                      <div className="flex justify-between items-center mb-1">
                         <span className="text-xs font-bold text-gray-500">æˆ‘ (ç¶¿ç¾Š)</span>
                         <span className="text-xs font-bold bg-indigo-100 text-indigo-600 px-2 rounded-full flex items-center gap-1"><Home size={10} /> {playerProperties}</span>
                      </div>
                      <div className="flex items-center gap-1 text-indigo-600 font-bold text-lg"><Heart fill="currentColor" size={20} /> {faith}</div>
                   </div>
                   <div className={`flex-1 p-2 rounded-xl transition-all border-2 ${turn === 'cpu' ? 'bg-purple-50 border-purple-200 scale-105 shadow-md' : 'bg-white/50 border-transparent opacity-70'}`}>
                      <div className="flex justify-between items-center mb-1">
                         <span className="text-xs font-bold bg-purple-100 text-purple-600 px-2 rounded-full flex items-center gap-1"><Home size={10} /> {cpuProperties}</span>
                         <span className="text-xs font-bold text-gray-500">é»‘å…¬ç¾Š</span>
                      </div>
                      <div className="flex items-center gap-1 text-purple-600 font-bold text-lg justify-end">{cpuFaith} <Heart fill="currentColor" size={20} /></div>
                   </div>
                </div>
              </div>

              {/* Notification */}
              {notification && (<div className={`fixed top-36 z-50 px-6 py-3 rounded-full text-white font-bold shadow-xl animate-bounce text-center ${notification.color}`}>{notification.text}</div>)}

              {/* Board Area */}
              <div className="relative w-full max-w-md aspect-[9/16] mt-24 mb-4 p-2">
                <div className="w-full h-full bg-[#EAD6BB] rounded-2xl shadow-inner relative border-8 border-[#D4C3AA]">
                   <div className="absolute inset-0 m-auto w-[40%] h-[30%] flex flex-col items-center justify-center z-10">
                      <div className="text-center mb-6">
                        <div className={`w-16 h-16 bg-white rounded-2xl shadow-[0_4px_0_#ccc] flex items-center justify-center border-2 border-gray-100 mx-auto mb-2 ${isMoving ? 'animate-spin' : ''}`}>{isMoving ? <RefreshCw className="text-gray-300" /> : <span className="text-4xl font-black text-gray-700">{diceValue}</span>}</div>
                        <div className="bg-white/50 px-3 py-1 rounded-full text-xs font-bold text-gray-600">
                          {turn === 'player' ? (isFrozen ? "æ› é‡çœæ€ä¸­..." : "è¼ªåˆ°ä½ äº†") : "é»‘å…¬ç¾Šè¡Œå‹•ä¸­"}
                        </div>
                      </div>
                      <button onClick={rollDice} disabled={turn !== 'player' || isMoving || activeModal} className={`w-full py-4 rounded-full font-black text-white shadow-lg text-xl flex items-center justify-center gap-2 transition-all active:translate-y-1 active:shadow-none ${turn === 'player' && !isFrozen ? 'bg-gradient-to-r from-amber-400 to-orange-400' : 'bg-gray-300'}`}>{isFrozen ? <PauseCircle /> : <Dices />}{isFrozen ? "è·³éå›åˆ" : "å‰é€²"}</button>
                   </div>
                   {board.map((tile, i) => {
                     const pos = getGridPosition(i);
                     const style = { left: `${pos.x * 25}%`, top: `${pos.y * 12.5}%`, width: '25%', height: '12.5%' };
                     let BuildingIcon = null;
                     if (tile.owner && tile.type === 'city') {
                        const colorClass = tile.owner === 'player' ? 'text-indigo-600' : 'text-purple-600';
                        const count = tile.level + 1;
                        BuildingIcon = (
                            <div className={`absolute -top-3 right-0 flex ${colorClass} drop-shadow-md z-10`}>
                                {[...Array(count)].map((_, idx) => (
                                    <Castle key={idx} size={16} fill="currentColor" className={idx > 0 ? "-ml-2" : ""} />
                                ))}
                            </div>
                        );
                     }
                     return (
                       <div key={tile.id} className="absolute p-[2px] transition-all" style={style}>
                         <div className={`w-full h-full rounded-lg border-2 ${tile.color} shadow-sm flex flex-col items-center justify-center relative ${tile.owner === 'player' ? 'border-indigo-500 bg-indigo-50' : tile.owner === 'cpu' ? 'border-purple-500 bg-purple-50' : 'border-white/50'}`}>
                            {BuildingIcon}
                            <div className="text-gray-600 opacity-80 transform scale-75">{tile.icon}</div>
                            <div className="text-[10px] font-bold text-gray-700 leading-none text-center px-1 truncate w-full">{tile.name || tile.label}</div>
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">{playerPos === i && <div className="text-2xl absolute z-20 animate-bounce drop-shadow-md -mt-3">ğŸ‘</div>}{cpuPos === i && <div className="text-2xl absolute z-10 transition-all duration-500 mt-2 ml-2 opacity-90 drop-shadow-sm" style={{filter: 'grayscale(100%) brightness(30%)'}}>ğŸ</div>}</div>
                         </div>
                       </div>
                     )
                   })}
                   <div className="absolute bottom-20 w-full text-center opacity-30 pointer-events-none"><h2 className="text-4xl font-black text-[#8B4513]">CANAAN</h2><p className="text-sm font-bold text-[#8B4513]">Land of Promise</p></div>
                </div>
              </div>

              {/* Modal Overlay */}
              {activeModal && (<div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4"><div className="w-full max-w-sm"><EventModal type={activeModal} tileData={board[playerPos]} coins={faith} isOwner={board[playerPos].owner === 'player'} isFrozen={isFrozen} onClose={() => { setActiveModal(null); setTurn('cpu'); }} onComplete={onModalComplete} onBuy={handleBuy} onUpgrade={handleUpgrade} onDestroy={handleDestroy} /></div></div>)}
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
