<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤©åœ‹å¤§å¯Œç¿ï¼šæ‡‰è¨±ä¹‹åœ°</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'adventure-bg': '#E6D5B8', 'adventure-paper': '#F3E5AB', 'adventure-ink': '#3E2723',
              'adventure-gold': '#B8860B', 'adventure-red': '#8B0000', 'adventure-sea': '#87A8B3',
            },
            fontFamily: { 'rounded': ['"Zen Maru Gothic"', 'sans-serif'], 'serif': ['"Times New Roman"', 'serif'] },
            boxShadow: { 'paper': '2px 3px 5px rgba(62, 39, 35, 0.3)', 'deck': '2px 2px 0 #3E2723, 4px 4px 0 #3E2723, 6px 6px 10px rgba(0,0,0,0.3)' }
          }
        }
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <script type="importmap">
    { "imports": { "react": "https://esm.sh/react@18.2.0", "react-dom/client": "https://esm.sh/react-dom@18.2.0/client", "lucide-react": "https://esm.sh/lucide-react@0.263.1" } }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #E6D5B8; color: #3E2723; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #E0C097; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #8B4513; border-radius: 4px; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .vintage-border { border: 2px solid #8B4513; outline: 2px dashed #BCAAA4; outline-offset: -6px; }
        .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .dice-scene { width: 60px; height: 60px; perspective: 400px; }
        .dice { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1s ease-out; }
        .dice.rolling { animation: roll 0.5s infinite linear; }
        .dice-face { position: absolute; width: 60px; height: 60px; background: #FFF; border: 2px solid #E0E0E0; border-radius: 12px; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .dot { width: 10px; height: 10px; background: #333; border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5); }
        .face-1 { transform: rotateY(0deg) translateZ(30px); } .face-2 { transform: rotateY(90deg) translateZ(30px); } .face-3 { transform: rotateY(180deg) translateZ(30px); }
        .face-4 { transform: rotateY(-90deg) translateZ(30px); } .face-5 { transform: rotateX(90deg) translateZ(30px); } .face-6 { transform: rotateX(-90deg) translateZ(30px); }
        .dots-1 { justify-content: center; } .dots-2 { justify-content: space-between; padding: 10px; } .dots-2 .dot:nth-child(2) { align-self: flex-end; }
        .dots-3 { justify-content: space-between; padding: 10px; } .dots-3 .dot:nth-child(2) { align-self: center; } .dots-3 .dot:nth-child(3) { align-self: flex-end; }
        .dots-4, .dots-5, .dots-6 { display: grid; grid-template-columns: 1fr 1fr; padding: 10px; gap: 8px; } .dots-5 .dot:nth-child(5) { grid-column: 1 / span 2; justify-self: center; align-self: center; }
        @keyframes roll { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(360deg) rotateY(360deg); } }
        @keyframes hop { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
        .animate-hop { animation: hop 0.6s ease-in-out infinite; }
        .filter-p1 { filter: brightness(110%); } 
        .filter-p2 { filter: sepia(0.5) hue-rotate(-30deg) saturate(1.2); } 
        .filter-p3 { filter: sepia(0.8) hue-rotate(350deg) saturate(1.5); } 
        .filter-p4 { filter: sepia(0.6) hue-rotate(20deg) saturate(1.8); } 
        .filter-cpu { filter: grayscale(100%) brightness(10%); } 
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BookOpen, Heart, Star, MessageCircle, RefreshCw, Check, X, Dices, AlertCircle, PauseCircle, Home, MapPin, Sword, Cross, Scroll, Tent, Footprints, Loader, HelpCircle, AlertTriangle, Play, Info, Send, Hammer, Castle, Flag, WifiOff, Sun, CloudRain, Flame, ExternalLink, Pointer, Facebook, Instagram, AtSign, Mail, Lock, User, Users, Crown, Skull } from 'lucide-react';

        // --- Data ---
        const BIBLE_DB = {
            "å‰µä¸–è¨˜": [ { verse: 1, text: "èµ·åˆï¼Œç¥å‰µé€ å¤©åœ°ã€‚" }, { verse: 2, text: "åœ°æ˜¯ç©ºè™›æ··æ²Œï¼Œæ·µé¢é»‘æš—ï¼›ç¥çš„éˆé‹è¡Œåœ¨æ°´é¢ä¸Šã€‚" }, { verse: 3, text: "ç¥èªªï¼šã€Œè¦æœ‰å…‰ã€ï¼Œå°±æœ‰äº†å…‰ã€‚" } ],
            "è©©ç¯‡": [ { verse: 1, text: "è€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚" }, { verse: 2, text: "ä»–ä½¿æˆ‘èººè‡¥åœ¨é’è‰åœ°ä¸Šï¼Œé ˜æˆ‘åœ¨å¯å®‰æ­‡çš„æ°´é‚Šã€‚" } ],
            "é¦¬å¤ªç¦éŸ³": [ { verse: 3, text: "è™›å¿ƒçš„äººæœ‰ç¦äº†ï¼å› ç‚ºå¤©åœ‹æ˜¯ä»–å€‘çš„ã€‚" }, { verse: 4, text: "å“€æ…Ÿçš„äººæœ‰ç¦äº†ï¼å› ç‚ºä»–å€‘å¿…å¾—å®‰æ…°ã€‚" } ]
        };
        const BIBLE_BOOKS = Object.keys(BIBLE_DB);
        const FALLBACK_SCRIPTURE = [{verse:1,text:"è€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚"}];
        const BIBLE_BOOKS_MAPPING = {"å‰µä¸–è¨˜":"Genesis","å‡ºåŸƒåŠè¨˜":"Exodus","ç´„æ›¸äºè¨˜":"Joshua","è©©ç¯‡":"Psalms","ç®´è¨€":"Proverbs","é¦¬å¤ªç¦éŸ³":"Matthew","ç´„ç¿°ç¦éŸ³":"John","ç¾…é¦¬æ›¸":"Romans","å•Ÿç¤ºéŒ„":"Revelation"};

        const PLAYER_CONFIGS = [
            { id: 0, name: 'ç™½ç¶¿ç¾Š', icon: 'ğŸ‘', color: 'text-indigo-600', bg: 'bg-indigo-100', border: 'border-indigo-400', filter: 'filter-p1' },
            { id: 1, name: 'èŠ±æ–‘ç¾Š', icon: 'ğŸ', color: 'text-amber-600', bg: 'bg-amber-100', border: 'border-amber-400', filter: 'filter-p2' },
            { id: 2, name: 'å°é¹¿', icon: 'ğŸ¦Œ', color: 'text-emerald-600', bg: 'bg-emerald-100', border: 'border-emerald-400', filter: 'filter-p3' },
            { id: 3, name: 'é§±é§', icon: 'ğŸª', color: 'text-orange-600', bg: 'bg-orange-100', border: 'border-orange-400', filter: 'filter-p4' }
        ];

        const CPU_CONFIG = { id: 99, name: 'é»‘å…¬ç¾Š', icon: 'ğŸ', color: 'text-purple-600', bg: 'bg-purple-100', border: 'border-purple-400', filter: 'filter-cpu' };

        const WIN_CONDITION_FAITH = 2000;
        const WIN_CONDITION_ALTARS = 5;

        const BLESSING_VERSES = [{text:"ä½ ç•¶å‰›å¼·å£¯è†½ï¼ä¸è¦æ‡¼æ€•ã€‚", ref:"ç´„æ›¸äºè¨˜ 1:9"},{text:"æµæ·šæ’’ç¨®çš„ï¼Œå¿…æ­¡å‘¼æ”¶å‰²ã€‚", ref:"è©©ç¯‡ 126:5"}];
        const FATE_CARDS = [
          { type: 'bad', text: "ç™¾å§“åœ¨æ› é‡ç™¼æ€¨è¨€ï¼Œä¿¡å¿ƒå‹•æ–ã€‚", amount: -50, freeze: false, title: "æ€¨è¨€çš„ç¶²ç¾…" },
          { type: 'bad', text: "è£½é€ äº†é‡‘ç‰›çŠ¢ï¼Œå¾—ç½ªäº†ç¥ã€‚", amount: -80, freeze: true, title: "å¶åƒçš„è©¦æ¢" },
          { type: 'good', text: "å¤©é™å—å“ªï¼Œæ¯æ—¥ä¾›æ‡‰ã€‚", amount: 50, freeze: false, title: "ç¥çš„ä¾›æ‡‰" },
          { type: 'good', text: "é›²æŸ±ç«æŸ±æ—¥å¤œå¼•é ˜ã€‚", amount: 80, freeze: false, title: "ç¥çš„åŒåœ¨" },
        ];
        const CHANCE_CARDS = [
          { type: 'quiz', q: "ä»¥è‰²åˆ—äººç¹è€¶åˆ©å“¥å¹¾å¤©ï¼Ÿ", options: ["3å¤©", "7å¤©"], ans: 1, reward: 80 },
          { type: 'quiz', q: "èª°åœ¨ç´„æ—¦æ²³æ–½æ´—ï¼Ÿ", options: ["å½¼å¾—", "ç´„ç¿°"], ans: 1, reward: 80 },
          { type: 'event_bad', title: "é‡åˆ°å·¨äºº", text: "çœ‹è¦‹äºç´æ—äººé«˜å¤§ï¼Œå¿ƒè£¡å®³æ€•ã€‚", amount: -40 },
          { type: 'event_bad', title: "ç‘ªæ‹‰è‹¦æ°´", text: "æ°´æ˜¯è‹¦çš„ï¼Œç„¡æ³•é£²ç”¨ã€‚", amount: -30 },
        ];
        const INITIAL_BOARD_MAP = [
          { id: 0, type: 'start', label: 'éç´„æ—¦æ²³', name: 'é€²è¿¦å—', color: 'from-yellow-100 to-yellow-200', icon: <Footprints size={20} /> },
          { id: 1, type: 'city', label: 'åŸæ± ', name: 'å‰ç”²', price: 100, rent: 20, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 2, type: 'fate', label: 'å‘½é‹', name: 'æ› é‡', color: 'from-purple-100 to-purple-200', icon: <AlertTriangle size={18} /> },
          { id: 3, type: 'city', label: 'åŸæ± ', name: 'è€¶åˆ©å“¥', price: 120, rent: 25, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 4, type: 'bible', label: 'è®€ç¶“', name: 'æœƒå¹•', color: 'from-blue-50 to-blue-100', icon: <Scroll size={18} /> },
          { id: 5, type: 'city', label: 'åŸæ± ', name: 'è‰¾åŸ', price: 140, rent: 30, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 6, type: 'event_jesus', label: 'æ©å…¸', name: 'åŠ åˆ©åˆ©æµ·', color: 'from-cyan-50 to-cyan-100', icon: <Cross size={18} /> },
          { id: 7, type: 'city', label: 'åŸæ± ', name: 'åŸºé', price: 160, rent: 35, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 8, type: 'chance', label: 'æ©Ÿæœƒ', name: 'æ™ºæ…§é–€', color: 'from-yellow-50 to-yellow-100', icon: <HelpCircle size={18} /> },
          { id: 9, type: 'city', label: 'åŸæ± ', name: 'äºé›…å´™', price: 150, rent: 30, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 10, type: 'prayer', label: 'ç¦±å‘Š', name: 'å®¢è¥¿é¦¬å°¼', color: 'from-orange-50 to-orange-100', icon: <MessageCircle size={18} /> },
          { id: 11, type: 'city', label: 'é‡é®', name: 'å¸Œä¼¯å´™', price: 300, rent: 60, owner: null, level: 0, color: 'from-rose-50 to-rose-100', icon: <Home size={18} /> },
          { id: 12, type: 'event_paul', label: 'äº‹ä»¶', name: 'å¤§é¦¬è‰²è·¯', color: 'from-indigo-50 to-indigo-100', icon: <MapPin size={18} /> },
          { id: 13, type: 'city', label: 'åŸæ± ', name: 'åº•ç’§', price: 200, rent: 40, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 14, type: 'bible', label: 'è®€ç¶“', name: 'åº‡å“©äº', color: 'from-blue-50 to-blue-100', icon: <Scroll size={18} /> },
          { id: 15, type: 'city', label: 'åŸæ± ', name: 'å¤ç‘£', price: 180, rent: 35, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 16, type: 'fate', label: 'å‘½é‹', name: 'é¢¨æµª', color: 'from-purple-100 to-purple-200', icon: <AlertTriangle size={18} /> },
          { id: 17, type: 'city', label: 'åŸæ± ', name: 'ç¤ºåŠ', price: 220, rent: 45, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
          { id: 18, type: 'chance', label: 'æ©Ÿæœƒ', name: 'ä¿¡å¿ƒé–€', color: 'from-yellow-50 to-yellow-100', icon: <HelpCircle size={18} /> },
          { id: 19, type: 'city', label: 'åŸæ± ', name: 'ç¤ºç¾…', price: 250, rent: 50, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} /> },
        ];
        const getGridPosition = (index) => { if (index <= 3) return { x: index, y: 0 }; if (index <= 9) return { x: 3, y: index - 3 }; if (index <= 13) return { x: 3 - (index - 10), y: 7 }; if (index <= 19) return { x: 0, y: 7 - (index - 13) }; return { x: 0, y: 0 }; };

        // --- Components ---
        const Dice3D = ({ value, rolling }) => {
            const getTransform = (val) => { const map = ['rotateX(0) rotateY(0)', 'rotateX(0) rotateY(0)', 'rotateY(-90deg)', 'rotateY(180deg)', 'rotateY(90deg)', 'rotateX(-90deg)', 'rotateX(90deg)']; return map[val] || map[1]; };
            return (<div className="dice-scene"><div className={`dice ${rolling ? 'rolling' : ''}`} style={{ transform: rolling ? '' : getTransform(value) }}><div className="dice-face face-1 dots-1"><div className="dot" style={{width:16, height:16, background:'#D32F2F'}}></div></div><div className="dice-face face-2 dots-2"><div className="dot"></div><div className="dot"></div></div><div className="dice-face face-3 dots-3"><div className="dot"></div><div className="dot"></div><div className="dot"></div></div><div className="dice-face face-4 dots-4"><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div></div><div className="dice-face face-5 dots-5"><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div></div><div className="dice-face face-6 dots-6"><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div></div></div></div>);
        };
        const Deck = ({ type, active, onClick }) => {
            const isFate = type === 'fate';
            return (<div onClick={active ? onClick : undefined} className={`w-20 h-28 rounded-lg border-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-300 relative ${isFate ? "bg-[#8E44AD] border-[#6C3483]" : "bg-[#F39C12] border-[#D35400]"} ${active ? 'animate-bounce ring-4 ring-yellow-400 z-20' : 'opacity-80 shadow-deck'}`}><div className="absolute inset-1 border border-white/30 border-dashed rounded pointer-events-none"></div><div className="mb-1">{isFate ? <AlertTriangle size={20} className="text-white"/> : <HelpCircle size={20} className="text-white"/>}</div><div className="text-white font-black text-sm tracking-widest writing-vertical-rl">{isFate?"å‘½é‹":"æ©Ÿæœƒ"}</div><div className={`absolute -bottom-1 -right-1 w-full h-full rounded-lg -z-10 ${isFate ? "bg-[#4A235A]" : "bg-[#A04000]"}`}></div>{active && <div className="absolute -top-10 left-1/2 -translate-x-1/2 bg-black/70 text-white text-[10px] px-2 py-1 rounded animate-pulse whitespace-nowrap">è«‹é»æ“ŠæŠ½å¡</div>}</div>);
        };
        const BackgroundMap = () => (<div className="fixed inset-0 w-full h-full z-[-1] overflow-hidden pointer-events-none"><svg width="100%" height="100%" viewBox="0 0 400 800" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg"><defs><filter id="paper-texture"><feTurbulence type="fractalNoise" baseFrequency="0.04" numOctaves="5"/><feDiffuseLighting lightingColor="#E6D5B8" surfaceScale="2"><feDistantLight azimuth="45" elevation="60"/></feDiffuseLighting></filter><radialGradient id="vignette" cx="50%" cy="50%" r="70%"><stop offset="50%" stopColor="#8B4513" stopOpacity="0"/><stop offset="100%" stopColor="#3E2723" stopOpacity="0.5"/></radialGradient></defs><rect width="100%" height="100%" fill="#E6D5B8"/><rect width="100%" height="100%" filter="url(#paper-texture)" opacity="0.6"/><path d="M -50 0 L 80 0 Q 60 200 40 400 T -20 800 L -50 800 Z" fill="#87A8B3" opacity="0.4" stroke="#546E7A"/><path d="M 280 150 Q 300 130 320 150 T 280 150" fill="#87A8B3" opacity="0.6"/><path d="M 300 160 Q 290 200 310 250 T 290 350" fill="none" stroke="#546E7A" strokeWidth="2" opacity="0.5"/><path d="M 290 350 Q 270 380 290 420 T 310 380 Q 320 360 290 350" fill="#87A8B3" opacity="0.6"/><path d="M 100 700 L 130 650 L 160 700 L 190 660 L 220 700" fill="none" stroke="#5D4037" strokeWidth="2" strokeLinejoin="round" opacity="0.4"/><path d="M 50 750 C 80 700, 150 720, 200 650 S 100 500, 150 450 S 250 350, 280 200" fill="none" stroke="#8B0000" strokeWidth="2" strokeDasharray="6,4" opacity="0.6"/><rect width="100%" height="100%" fill="url(#vignette)" style={{mixBlendMode: 'multiply'}}/></svg></div>);
        
        const StartScreen = ({ onStart }) => {
            const [playerCount, setPlayerCount] = useState(1); 
            return (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center relative overflow-hidden"><BackgroundMap /><div className="z-10 max-w-md w-full bg-[#F3E5AB] p-8 rounded-xl shadow-[0_10px_30px_rgba(62,39,35,0.4)] border-4 border-[#8B4513] relative vintage-border"><div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-[#8B4513] text-[#F3E5AB] px-4 py-1 text-sm font-bold rounded shadow-md tracking-widest">BIBLE ADVENTURE</div><h1 className="text-4xl font-black text-[#3E2723] mb-2 font-serif">å¤©åœ‹å¤§å¯Œç¿</h1><h2 className="text-lg font-bold text-[#5D4037] mb-8">- æ‡‰è¨±ä¹‹åœ°ç¯‡ -</h2>
            <div className="flex justify-center items-center gap-8 mb-8"><div className="text-6xl">ğŸ‘</div><div className="text-2xl font-black">VS</div><div className="text-6xl grayscale opacity-80" style={{filter: 'grayscale(100%) brightness(10%)'}}>ğŸ</div></div>
            <div className="flex justify-center gap-2 mb-6"><button onClick={()=>setPlayerCount(1)} className={`px-4 py-2 rounded-lg font-bold border-2 transition-all ${playerCount===1 ? 'bg-[#8B4513] text-[#F3E5AB] border-[#8B4513]' : 'bg-transparent text-[#8B4513] border-[#8B4513]/50'}`}><User size={20} className="inline"/> å–®äººæŒ‘æˆ°</button><button onClick={()=>setPlayerCount(2)} className={`px-4 py-2 rounded-lg font-bold border-2 transition-all ${playerCount>1 ? 'bg-[#8B4513] text-[#F3E5AB] border-[#8B4513]' : 'bg-transparent text-[#8B4513] border-[#8B4513]/50'}`}><Users size={20} className="inline"/> å¤šäººåŒæ¨‚</button></div>
            {playerCount > 1 && (<div className="flex justify-center items-center gap-4 mb-6 text-[#3E2723]"><span className="font-bold">ç©å®¶äººæ•¸:</span><button onClick={()=>setPlayerCount(2)} className={`w-8 h-8 rounded-full border-2 ${playerCount===2?'bg-[#8B4513] text-white':'bg-white'}`}>2</button><button onClick={()=>setPlayerCount(3)} className={`w-8 h-8 rounded-full border-2 ${playerCount===3?'bg-[#8B4513] text-white':'bg-white'}`}>3</button><button onClick={()=>setPlayerCount(4)} className={`w-8 h-8 rounded-full border-2 ${playerCount===4?'bg-[#8B4513] text-white':'bg-white'}`}>4</button></div>)}
            <div className="text-left mb-6 space-y-3 bg-[#E6D5B8] p-4 rounded border border-[#8B4513]/30 shadow-inner"><h3 className="font-bold text-[#8B4513] mb-3 flex items-center gap-2 border-b border-[#8B4513]/20 pb-2"><Info size={18} /> éŠæˆ²è¦å‰‡</h3><div className="flex items-start gap-3"><div className="bg-[#8B4513] text-[#F3E5AB] w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">1</div><p className="text-sm font-bold text-[#3E2723]">æ“²éª°å­ï¼Œç´¯ç©ä¿¡å¿ƒã€‚</p></div><div className="flex items-start gap-3"><div className="bg-[#8B4513] text-[#F3E5AB] w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">2</div><p className="text-sm font-bold text-[#3E2723]">æ”»ä½”åŸæ± ï¼Œå»ºç«‹ç¥­å£‡ã€‚</p></div><div className="flex items-start gap-3"><div className="bg-[#8B4513] text-[#F3E5AB] w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">3</div><p className="text-sm font-bold text-[#3E2723]">é‡åˆ°é»‘å…¬ç¾Šçš„ç‡Ÿå£˜ï¼Œé¸æ“‡æ‹†æ¯€æˆ–ç¥ç¦ã€‚</p></div></div><button onClick={()=>onStart(playerCount)} className="w-full bg-[#8B4513] hover:bg-[#5D4037] text-[#F3E5AB] text-xl font-black py-4 rounded shadow-md border-2 border-[#3E2723]"><Sword size={24} className="inline mr-2"/> {playerCount===1?'é–‹å§‹æŒ‘æˆ°':'é–‹å§‹éŠæˆ²'}</button><div className="mt-8 pt-6 border-t border-[#8B4513]/30"><p className="text-[#3E2723] font-bold mb-4">è€¶ç©ŒåŠ æ²¹ç«™ x å¾®å…‰æ–°äº‹</p><div className="flex justify-center gap-4"><a href="https://www.facebook.com/profile.php?id=100068500932557" target="_blank" className="text-[#3E2723] hover:text-[#8B4513] transition-colors"><Facebook size={24} /></a><a href="https://www.instagram.com/forever.believe.in.jesus/" target="_blank" className="text-[#3E2723] hover:text-[#8B4513] transition-colors"><Instagram size={24} /></a><a href="https://www.threads.net/@forever.believe.in.jesus" target="_blank" className="text-[#3E2723] hover:text-[#8B4513] transition-colors"><AtSign size={24} /></a><a href="https://line.me/R/ti/p/@469cjlho" target="_blank" className="text-[#3E2723] hover:text-[#8B4513] transition-colors"><MessageCircle size={24} /></a><a href="mailto:newthingsinthelittlelight@gmail.com" target="_blank" className="text-[#3E2723] hover:text-[#8B4513] transition-colors"><Mail size={24} /></a></div></div></div></div>);
        };

        const GameButton = ({ onClick, disabled, color = "blue", icon: Icon, children }) => {
            const colors = { blue: "bg-blue-500", amber: "bg-amber-500", indigo: "bg-indigo-500", red: "bg-red-500", purple: "bg-purple-500", gray: "bg-gray-500", orange: "bg-orange-500", cyan: "bg-cyan-500", green: "bg-green-500" };
            return <button type="button" onClick={onClick} disabled={disabled} className={`w-full py-3.5 rounded-lg font-bold transition-all flex items-center justify-center gap-2 ${disabled ? "bg-gray-300 cursor-not-allowed" : `${colors[color]} text-white shadow-md active:scale-95`}`}>{Icon && <Icon size={20}/>} {children}</button>;
        };
        const CardFlip = ({ frontTitle, frontColor, backContent, icon, textColor="text-[#3E2723]" }) => {
            const [isFlipped, setIsFlipped] = useState(false);
            return (<div className="relative w-full h-[450px] perspective-1000 cursor-pointer group" onClick={() => !isFlipped && setIsFlipped(true)}><div className={`relative w-full h-full transition-all duration-700 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}><div className={`absolute w-full h-full bg-gradient-to-br ${frontColor} rounded-xl shadow-[0_10px_20px_rgba(0,0,0,0.3)] flex flex-col items-center justify-center backface-hidden border-8 border-[#3E2723]`}><div className="border-4 border-dashed border-[#3E2723]/30 w-[90%] h-[90%] absolute rounded-lg pointer-events-none"></div><div className="bg-[#3E2723] p-6 rounded-full text-[#F3E5AB] mb-6 shadow-md">{icon}</div><h3 className={`text-3xl font-black ${textColor} tracking-[0.2em] uppercase font-serif drop-shadow-sm`}>{frontTitle}</h3><div className={`absolute bottom-12 ${textColor} opacity-80 text-sm font-bold animate-pulse`}>é»æ“Šç¿»é–‹</div></div><div className="absolute w-full h-full bg-[#F3E5AB] rounded-xl shadow-[0_10px_20px_rgba(0,0,0,0.3)] flex flex-col items-center justify-center p-8 backface-hidden rotate-y-180 border-8 border-[#8B4513] overflow-y-auto bg-[url('https://www.transparenttextures.com/patterns/paper.png')]">{backContent}</div></div></div>);
        };
        const FateEvent = ({ onComplete }) => {
            const [card] = useState(() => FATE_CARDS[Math.floor(Math.random() * FATE_CARDS.length)]);
            const isGood = card.type === 'good';
            return <CardFlip frontTitle="å‘½é‹ç‰Œ" frontColor="from-purple-500 to-indigo-600" textColor="text-white" icon={<AlertTriangle size={64} />} backContent={<div className="w-full text-center h-full flex flex-col justify-center"><div className={`mb-6 p-4 rounded-full w-20 h-20 mx-auto flex items-center justify-center border-4 ${isGood?'bg-[#E8F5E9] border-green-600 text-green-600':'bg-[#FFEBEE] border-red-600 text-red-600'}`}>{isGood?<Sun size={40}/>:<CloudRain size={40}/>}</div><h3 className="text-2xl font-black mb-4 text-[#3E2723]">{card.title}</h3><p className="text-lg font-bold text-[#5D4037] mb-8">{card.text}</p><div className="mb-8"><span className={`text-xl font-black px-4 py-2 rounded ${isGood?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>ä¿¡å¿ƒ {card.amount>0?'+':''}{card.amount}</span>{card.freeze&&<div className="text-red-600 text-sm mt-2 font-bold flex justify-center items-center gap-1"><PauseCircle size={14}/> æš«åœä¸€å›åˆ</div>}</div><GameButton onClick={()=>onComplete(0,card.amount,card.freeze)} color={isGood?"green":"red"}>{isGood?"å“ˆåˆ©è·¯äº":"æ‚”æ”¹æ±‚ä¸»"}</GameButton></div>} />;
        };
        const ChanceEvent = ({ onComplete }) => {
            const [card] = useState(() => CHANCE_CARDS[Math.floor(Math.random() * CHANCE_CARDS.length)]);
            const [quizStatus, setQuizStatus] = useState('ask');
            const handleAns = (idx) => { if (idx === card.ans) { setQuizStatus('correct'); setTimeout(() => onComplete(20, card.reward), 1500); } else { setQuizStatus('wrong'); setTimeout(() => onComplete(0, 0, true), 1500); } };
            const content = card.type === 'quiz' ? (<div className="w-full text-center"><h3 className="text-2xl font-black text-[#8B4513] mb-6">è–ç¶“å†·çŸ¥è­˜</h3>{quizStatus==='ask'&&(<><p className="text-[#3E2723] font-bold text-lg mb-6">{card.q}</p><div className="space-y-3">{card.options.map((opt,i)=><button key={i} onClick={()=>handleAns(i)} className="w-full bg-[#FFF3E0] text-[#5D4037] border-2 border-[#D7CCC8] py-3 rounded-lg font-bold hover:bg-[#FFE0B2]">{opt}</button>)}</div></>)}{quizStatus==='correct'&&<div className="py-10 animate-bounce text-green-700"><Check size={40} className="mx-auto"/><p className="text-2xl font-black">ç­”å°äº†ï¼</p><p className="font-bold text-green-600">+{card.reward} ä¿¡å¿ƒ</p></div>}{quizStatus==='wrong'&&<div className="py-10 animate-shake text-red-700"><X size={40} className="mx-auto"/><p className="text-2xl font-black">ç­”éŒ¯äº†...</p><p className="font-bold text-red-500">æš«åœä¸€å›</p></div>}</div>) : (<div className="w-full text-center h-full flex flex-col justify-center"><CloudRain size={40} className="mx-auto text-gray-500 mb-4"/><h3 className="text-2xl font-black text-[#3E2723] mb-4">{card.title}</h3><p className="text-lg font-bold text-[#5D4037] mb-6">{card.text}</p><div className="inline-block bg-red-50 border border-red-200 px-4 py-2 rounded-lg mb-8"><p className="text-red-800 font-black">ä¿¡å¿ƒå€¼ {card.amount}</p></div><GameButton onClick={()=>onComplete(0,card.amount)} color="gray">æ¥å—æŒ‘æˆ°</GameButton></div>);
            return <CardFlip frontTitle="æ©Ÿæœƒç‰Œ" frontColor="bg-[#FFE082]" icon={<HelpCircle size={64} />} backContent={content} />;
        };
        const PrayerEvent = ({ tileData, onComplete }) => {
            const [val, setVal] = useState("");
            return (<div className="bg-[#FFF8E7] p-8 rounded-3xl border-4 border-[#FFB74D] text-center relative"><h3 className="text-2xl font-black text-[#E65100]">ğŸ™ {tileData.name}</h3><p className="text-gray-500 mb-4 text-sm">åœ¨ä¸»é¢å‰å‚¾å¿ƒåæ„...</p><textarea className="w-full p-2 border-2 border-[#FFE0B2] rounded my-4 bg-white" rows="3" placeholder="è¼¸å…¥ä½ çš„ç¦±å‘Š..." onChange={e=>setVal(e.target.value)}/><GameButton onClick={()=>onComplete(20,50)} color="orange" disabled={!val.trim()} icon={Send}>ç™¼å‡ºç¦±å‘Š (+50 ä¿¡å¿ƒ)</GameButton></div>);
        };
        const CityEvent = ({ tileData, coins, isOwner, onBuy, onUpgrade, onDestroy, onComplete }) => {
            const PropertyAction = () => {
                if (isOwner) { const cost=Math.floor(tileData.price*0.6); const isFirst=tileData.level===0; return (<div className="mt-4 border-t-2 border-[#D7CCC8] pt-4"><p className="text-sm font-bold text-center mb-2">å±¬åœ° Lv.{tileData.level}</p><GameButton onClick={()=>onUpgrade(cost)} disabled={coins<cost} color="amber" icon={isFirst?Home:Flame}>{isFirst?`å»ºç«‹ç¥­å£‡ (-${cost})`:`ç»ç¥­ (-${cost})`}</GameButton></div>); }
                if (!tileData.owner) return (<div className="mt-4 border-t-2 border-[#D7CCC8] pt-4"><GameButton onClick={()=>onBuy(tileData.price)} disabled={coins<tileData.price} color="indigo" icon={Sword}>æ”»ä½” (-{tileData.price})</GameButton></div>);
                if (tileData.owner) { const rent=tileData.rent*(tileData.level+1); const destroy=tileData.price; const claim=destroy+tileData.price; return (<div className="mt-4 bg-[#FFEBEE] p-3 rounded border border-red-200"><p className="text-center text-red-600 font-bold mb-2">æ•µæ–¹ç‡Ÿå£˜</p><button onClick={()=>onComplete(0,-rent)} className="w-full py-2 bg-white border border-red-300 rounded text-red-600 font-bold mb-2">ç¥ç¦ (-{rent})</button>{tileData.level===0?<><GameButton onClick={()=>onDestroy(destroy,false)} disabled={coins<destroy} color="red" icon={Hammer}>æ‹†æ¯€ (-{destroy})</GameButton><div className="mt-1"><GameButton onClick={()=>onDestroy(claim,true)} disabled={coins<claim} color="indigo" icon={Sword}>æ‹†æ¯€ä¸¦å»ºç«‹ (-{claim})</GameButton></div></>:<p className="text-center text-xs text-red-400">å°æ–¹å·²å»ºç¥­å£‡ï¼Œç„¡æ³•æ‹†æ¯€</p>}</div>); }
                return null;
            };
            const isOwned = tileData.owner !== null;
            const isEnemy = isOwned && !isOwner;
            return (<div className="bg-[#FFF8E7] p-8 rounded-3xl border-4 border-[#D7CCC8] text-center relative"><h3 className="text-2xl font-black text-[#5D4037]">ğŸ° {tileData.name}</h3><PropertyAction />{!isEnemy&&!isOwner&&!isOwned&&<button onClick={()=>onComplete(0,0)} className="mt-4 text-sm text-gray-500 underline">æš«ä¸è¡Œå‹•</button>}</div>);
        };
        const EventModal = ({ type, tileData, onClose, onComplete, coins, isOwner, onBuy, onUpgrade, onDestroy }) => {
            const CloseButton = () => <button onClick={onClose} className="absolute top-4 right-4 bg-white/50 hover:bg-white text-gray-600 p-2 rounded-full shadow-sm transition-all z-50 border border-white/60"><X size={20} /></button>;
            const BibleReader = () => {
                const [selection] = useState(() => {
                    const randomBook = BIBLE_BOOKS[Math.floor(Math.random() * BIBLE_BOOKS.length)];
                    return { book: randomBook, content: BIBLE_DB[randomBook] };
                });
                return (<div className="bg-[#FFF8E7] rounded-3xl shadow-2xl border-8 border-[#8B4513] flex flex-col h-[500px] overflow-hidden relative"><CloseButton/><div className="bg-[#F3E5AB] p-4 border-b-2 border-[#D7CCC8] mt-4"><h3 className="text-xl font-black text-[#5D4037] text-center flex justify-center gap-2"><BookOpen/> æ¯æ—¥éˆç³§</h3><p className="text-center text-[#8B4513] font-bold text-sm">{selection.book}</p></div><div className="flex-1 overflow-y-auto p-6 custom-scrollbar"><div className="space-y-4">{selection.content.map((v,i)=>(<div key={i} className="flex gap-3 text-gray-700 leading-relaxed text-justify text-sm font-medium"><span className="text-xs font-black text-[#8B4513] mt-0.5 shrink-0 bg-[#F3E5AB] w-5 h-5 flex items-center justify-center rounded-full">{v.verse}</span><span>{v.text}</span></div>))}</div><div className="h-8"></div></div><div className="p-4 bg-[#F3E5AB] space-y-2"><GameButton onClick={()=>onComplete(30,80)} color="amber" icon={Check}>æˆ‘è®€å®Œäº† (+80 ä¿¡å¿ƒ)</GameButton></div></div>);
            };
            if (type==='event_jesus') return (<div className="bg-[#FFF8E7] p-8 rounded-3xl border-4 border-[#87CEEB] text-center relative"><CloseButton/><h3 className="text-2xl font-black text-[#0097A7]">âœï¸ é‡è¦‹è€¶ç©Œ</h3><p className="my-4">é ˜å—å±¬å¤©çš„ç¥ç¦...</p><GameButton onClick={()=>onComplete(20,100)} color="cyan">é ˜å— (+100)</GameButton></div>);
            if (type==='event_paul') return (<div className="bg-[#FFF8E7] p-8 rounded-3xl border-4 border-[#5C6BC0] text-center relative"><CloseButton/><h3 className="text-2xl font-black text-[#3949AB]">âš¡ å¤§é¦¬è‰²è·¯</h3><p className="my-4">æš«æ™‚çœ‹ä¸è¦‹ï¼Œä½†ç”Ÿå‘½ç¿»è½‰ã€‚</p><GameButton onClick={()=>onComplete(50,50,true)} color="indigo">é †æœå‘¼å¬ (+50, æš«åœ)</GameButton></div>);
            if (type==='bible') return <div className="relative"><CloseButton/><BibleReader /></div>;
            if (type==='fate') return <div className="relative"><CloseButton/><FateEvent onComplete={onComplete} /></div>;
            if (type==='chance') return <div className="relative"><CloseButton/><ChanceEvent onComplete={onComplete} /></div>;
            if (type==='prayer') return <div className="relative"><CloseButton/><PrayerEvent tileData={tileData} onComplete={onComplete} /></div>;
            if (type==='city') return <div className="relative"><CloseButton/><CityEvent tileData={tileData} coins={coins} isOwner={isOwner} onBuy={onBuy} onUpgrade={onUpgrade} onDestroy={onDestroy} onComplete={onComplete} /></div>;
            return null;
        };

        const GameOverScreen = ({ winner, onRestart }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-6 text-center animate-hop">
                <div className="bg-[#FFF8E7] p-8 rounded-[3rem] border-8 border-[#B8860B] shadow-[0_0_50px_#B8860B] max-w-sm w-full">
                    <Crown size={64} className="mx-auto text-[#B8860B] mb-4 animate-bounce" />
                    <h2 className="text-4xl font-black text-[#3E2723] mb-2">æ¦®è€€æ™‚åˆ»</h2>
                    <p className="text-xl font-bold text-[#8B4513] mb-6">ç²å‹è€…ï¼š<span className={winner.color}>{winner.name}</span></p>
                    <div className="text-6xl mb-6">{winner.icon}</div>
                    <p className="text-sm text-[#5D4037] mb-8 font-bold">"é‚£ç¾å¥½çš„ä»—æˆ‘å·²ç¶“æ‰“éäº†ï¼Œç•¶è·‘çš„è·¯æˆ‘å·²ç¶“è·‘ç›¡äº†ï¼Œæ‰€ä¿¡çš„é“æˆ‘å·²ç¶“å®ˆä½äº†ã€‚"</p>
                    <button onClick={onRestart} className="w-full bg-[#B8860B] hover:bg-[#9A7D0A] text-white text-xl font-black py-4 rounded-xl shadow-lg border-2 border-[#3E2723]">å†ä¾†ä¸€å±€</button>
                </div>
            </div>
        );

        const App = () => {
          const [gameState, setGameState] = useState('start');
          const [board, setBoard] = useState(INITIAL_BOARD_MAP);
          const [players, setPlayers] = useState([]);
          const [currentTurn, setCurrentTurn] = useState(0);
          const [isMoving, setIsMoving] = useState(false);
          const [diceValue, setDiceValue] = useState(1);
          const [activeModal, setActiveModal] = useState(null);
          const [notification, setNotification] = useState(null);
          const [waitingForDraw, setWaitingForDraw] = useState(null);
          const [winner, setWinner] = useState(null);

          const notify = (text, color="bg-amber-500") => { setNotification({ text, color }); setTimeout(() => setNotification(null), 3000); };

          const startGame = (count) => {
            const newPlayers = Array.from({ length: count }, (_, i) => ({
                ...PLAYER_CONFIGS[i],
                pos: 0,
                faith: 1000,
                isFrozen: false,
                isCPU: i === 1 && count === 1 // P2 is CPU only in 1-player mode
            }));
            if (count === 1) { // Add CPU manually for 1P mode
                newPlayers.push({ ...CPU_CONFIG, pos: 0, faith: 1000, isFrozen: false, isCPU: true });
            }
            setPlayers(newPlayers);
            setBoard(INITIAL_BOARD_MAP);
            setGameState('playing');
            setCurrentTurn(0);
            setWinner(null);
          };

          const checkWinCondition = (currentPlayers, currentBoard) => {
             const activePlayers = currentPlayers.filter(p => p.faith >= 0);
             if (activePlayers.length === 1) return activePlayers[0];
             for (let p of currentPlayers) {
                 if (p.faith >= WIN_CONDITION_FAITH) return p;
                 const owned = currentBoard.filter(t => t.owner === p.id && t.level > 0).length;
                 if (owned >= WIN_CONDITION_ALTARS) return p;
             }
             return null;
          };

          const nextTurn = () => {
              const win = checkWinCondition(players, board);
              if (win) { setWinner(win); return; }
              setCurrentTurn(prev => (prev + 1) % players.length);
          };

          useEffect(() => {
              if (gameState === 'playing' && players[currentTurn]?.isCPU && !isMoving && !activeModal && !waitingForDraw) {
                  setTimeout(() => rollDice(), 1000);
              }
          }, [currentTurn, players, gameState, isMoving, activeModal, waitingForDraw]);

          const rollDice = () => {
              const player = players[currentTurn];
              if (player.isFrozen) {
                  notify(`${player.name} æ› é‡çœæ€ä¸­...`, "bg-gray-500");
                  setIsMoving(true);
                  setTimeout(() => {
                      setPlayers(prev => prev.map((p, i) => i === currentTurn ? { ...p, isFrozen: false } : p));
                      setIsMoving(false);
                      nextTurn();
                  }, 1500);
                  return;
              }

              setIsMoving(true);
              const val = Math.floor(Math.random() * 6) + 1;
              setDiceValue(val);

              let steps = 0;
              const moveInterval = setInterval(() => {
                  setPlayers(prev => {
                      const copy = [...prev];
                      copy[currentTurn].pos = (copy[currentTurn].pos + 1) % board.length;
                      if (copy[currentTurn].pos === 0) {
                          copy[currentTurn].faith += 300;
                          notify(`${copy[currentTurn].name} ç¶“éç´…æµ· +300`, "bg-yellow-500");
                      }
                      return copy;
                  });
                  steps++;
                  if (steps === val) {
                      clearInterval(moveInterval);
                      setIsMoving(false);
                      // Use calculated final position
                      const finalPos = (player.pos + val) % board.length;
                      handleLandEvent(finalPos);
                  }
              }, 200);
          };

          const handleLandEvent = (finalPos) => {
              const player = players[currentTurn];
              const tile = board[finalPos]; // Use passed finalPos

              if (player.isCPU) { handleCpuLogic(player, tile); return; }

              if (tile.type === 'fate' || tile.type === 'chance') {
                  setWaitingForDraw(tile.type);
              } else if (tile.type !== 'start') {
                  setTimeout(() => setActiveModal(tile.type), 500);
              } else {
                  nextTurn();
              }
          };

          const handleCpuLogic = (player, tile) => {
              const delayNext = () => setTimeout(nextTurn, 1500);
              if (tile.type === 'city') {
                  if (tile.owner === null) {
                      if (player.faith >= tile.price && Math.random() > 0.4) {
                          updateBoardAndFaith(player.id, -tile.price, 'buy');
                          notify(`${player.name} æ”»ä½”äº† ${tile.name}`, "bg-purple-500");
                      } else delayNext();
                  } else if (tile.owner === player.id) {
                       if (player.faith >= tile.price * 0.6 && Math.random() > 0.6) {
                           updateBoardAndFaith(player.id, -Math.floor(tile.price*0.6), 'upgrade');
                           notify(`${player.name} ç»ç¥­äº† ${tile.name}`, "bg-purple-600");
                       } else delayNext();
                  } else {
                       const rent = tile.rent * (tile.level + 1);
                       const destroy = tile.price;
                       if (tile.level === 0 && player.faith >= destroy && Math.random() < 0.4) {
                           updateBoardAndFaith(player.id, -destroy, 'destroy');
                           notify(`${player.name} æ‹†æ¯€äº†ç‡Ÿå£˜ï¼`, "bg-red-600");
                       } else {
                           updateBoardAndFaith(player.id, -rent, 'rent', tile.owner);
                           notify(`${player.name} æ”¯ä»˜äº†å¥‰ç»é‡‘`, "bg-green-600");
                       }
                  }
              } else if (tile.type === 'fate' || tile.type === 'chance') {
                  const effect = Math.random() > 0.5 ? 50 : -30;
                  updatePlayerFaith(player.id, effect);
                  notify(`${player.name} é‡åˆ°äº†${tile.type==='fate'?'å‘½é‹':'æ©Ÿæœƒ'}`, "bg-blue-500");
                  delayNext();
              } else {
                  updatePlayerFaith(player.id, 50);
                  notify(`${player.name} ç²å¾—äº†ç¥ç¦`, "bg-blue-400");
                  delayNext();
              }
          };

          const updatePlayerFaith = (pid, amount) => {
              setPlayers(prev => prev.map(p => {
                  if (p.id === pid) return { ...p, faith: p.faith + amount };
                  return p;
              }));
          };

          const updateBoardAndFaith = (pid, amount, action, targetPid=null) => {
              const player = players.find(p => p.id === pid);
              const pos = player.pos;
              setPlayers(prev => prev.map(p => {
                  if (p.id === pid) return { ...p, faith: p.faith + amount };
                  if (p.id === targetPid && action === 'rent') return { ...p, faith: p.faith - amount }; 
                  return p;
              }));
              setBoard(prev => {
                  const newBoard = [...prev];
                  const tile = { ...newBoard[pos] };
                  if (action === 'buy' || action === 'buy_destroy') { tile.owner = pid; tile.level = 0; }
                  if (action === 'upgrade') { tile.level += 1; }
                  if (action === 'destroy') { tile.owner = null; tile.level = 0; }
                  newBoard[pos] = tile;
                  return newBoard;
              });
              if (!players[currentTurn].isCPU) { setActiveModal(null); nextTurn(); } else { setTimeout(nextTurn, 1500); }
          };
          
          const onModalComplete = (xpG, faithChange, freeze = false) => {
             setPlayers(prev => prev.map((p, i) => {
                 if (i !== currentTurn) return p;
                 return { ...p, faith: Math.max(0, p.faith + (faithChange || 0)), isFrozen: freeze };
             }));
             if (faithChange > 0) notify(`ä¿¡å¿ƒå¢åŠ  +${faithChange}`);
             else if (faithChange < 0) notify(`ä¿¡å¿ƒæ¸›å°‘ ${Math.abs(faithChange)}`, "bg-red-500");
             
             setActiveModal(null); nextTurn();
          };
          const onCardDraw = (type) => { setWaitingForDraw(null); setActiveModal(type); };

          if (gameState === 'start') return <StartScreen onStart={startGame} />;
          if (winner) return <GameOverScreen winner={winner} onRestart={() => setGameState('start')} />;

          const currentPlayer = players[currentTurn];

          return (
            <div className="min-h-screen flex flex-col items-center justify-center p-2 relative overflow-hidden">
               <BackgroundMap />
               
               <div className="w-full max-w-md fixed top-4 z-30 px-2">
                   <div className="glass-panel rounded-xl p-2 shadow-floating border border-[#8B4513]/40 bg-[#FFF8E7]/90 backdrop-blur-md flex justify-between items-center">
                       <span className="font-black text-[#5D4037] text-lg font-serif ml-2">CANAAN</span>
                       <div className="flex gap-2 overflow-x-auto no-scrollbar">
                           {players.map((p, i) => (
                               <div key={p.id} className={`flex flex-col items-center p-1 rounded-lg border-2 transition-all ${i === currentTurn ? `${p.bg} ${p.border} scale-110 shadow-md` : 'border-transparent opacity-60 scale-90'}`}>
                                   <div className="text-xl">{p.icon}</div>
                                   <span className={`text-[10px] font-bold ${p.color}`}>{p.faith}</span>
                               </div>
                           ))}
                       </div>
                   </div>
               </div>

               {notification && <div className={`fixed top-36 z-50 px-6 py-3 rounded-lg text-[#F3E5AB] font-bold shadow-[0_4px_0_#3E2723] animate-bounce text-center backdrop-blur-md border-2 border-[#5D4037] ${notification.color === 'bg-red-500' ? 'bg-[#C62828]' : 'bg-[#EF6C00]'}`}>{notification.text}</div>}
               
               <div className="relative w-full max-w-md aspect-[9/16] mt-32 mb-4 p-2 scale-95">
                  <div className="w-full h-full bg-[#E6D5B8]/80 rounded-[1.5rem] shadow-[inset_0_0_60px_rgba(62,39,35,0.2)] relative border-8 border-[#8D6E63] outline outline-4 outline-[#5D4037] backdrop-blur-sm overflow-hidden">
                     
                     <div className="absolute top-[12.5%] left-[25%] w-[50%] h-[75%] flex flex-col items-center justify-between py-6 z-20 pointer-events-none">
                        <div className="flex justify-between w-full px-2 pointer-events-auto">
                            <Deck type="fate" active={waitingForDraw === 'fate'} onClick={() => onCardDraw('fate')} />
                            <Deck type="chance" active={waitingForDraw === 'chance'} onClick={() => onCardDraw('chance')} />
                        </div>

                        {!waitingForDraw && (
                            <div className="flex flex-col items-center pointer-events-auto">
                                <div className="w-24 h-24 rounded-full bg-[#FFF8E1] shadow-[inset_0_4px_10px_rgba(0,0,0,0.05)] border-4 border-[#D7CCC8] flex flex-col items-center justify-center mb-4 relative overflow-hidden">
                                    <div className="scale-75"><Dice3D value={diceValue} rolling={isMoving}/></div>
                                </div>
                                <button onClick={rollDice} disabled={currentPlayer.isCPU || isMoving || activeModal} className={`w-36 py-3 rounded-xl font-black text-[#F3E5AB] shadow-[0_4px_0_#3E2723] text-sm flex items-center justify-center gap-2 transition-all active:translate-y-1 active:shadow-none border-2 border-[#3E2723] ${currentPlayer.isCPU ? 'bg-gray-400' : currentPlayer.isFrozen ? 'bg-red-600' : 'bg-[#8B4513] hover:bg-[#6D4C41]'}`}>
                                    {currentPlayer.isCPU ? "é›»è…¦æ€è€ƒä¸­..." : currentPlayer.isFrozen ? <><Lock size={16}/> è·³é</> : "æ“²éª°å­"}
                                </button>
                                <div className={`mt-2 px-3 py-1 rounded-full text-xs font-bold ${currentPlayer.bg} ${currentPlayer.color} border border-current shadow-sm`}>
                                    {currentPlayer.name} çš„å›åˆ
                                </div>
                            </div>
                        )}
                        {waitingForDraw && (<div className="bg-[#FFF8E1] border-2 border-[#8B4513] px-4 py-2 rounded-full text-[#8B4513] font-black animate-bounce shadow-lg flex items-center gap-2 text-sm pointer-events-auto"><Pointer size={16} /> è«‹é»æ“Šç‰Œå †</div>)}
                     </div>

                     {board.map((tile, i) => {
                         const pos = getGridPosition(i);
                         const style = { left: `${pos.x * 25}%`, top: `${pos.y * 12.5}%`, width: '25%', height: '12.5%' };
                         let BuildingIcon = null;
                         if(tile.owner !== null && tile.type === 'city') {
                             const owner = players.find(p => p.id === tile.owner);
                             const colors = ['text-indigo-600', 'text-purple-600', 'text-pink-600', 'text-amber-600'];
                             const colorClass = owner ? colors[owner.id % 4] : 'text-gray-500';
                             BuildingIcon = (<div className={`absolute -top-3 right-0 flex items-end ${colorClass} z-20 drop-shadow-md`}><Castle size={16} fill="currentColor"/>{tile.level>=1 && <div className="flex -ml-1"><Flame size={12} className="text-orange-500" fill="currentColor"/></div>}</div>);
                         }
                         
                         const playersHere = players.filter(p => p.pos === i);
                         
                         return (
                            <div key={tile.id} className="absolute p-1 transition-all" style={style}>
                                <div className={`w-full h-full rounded shadow-sm flex flex-col items-center justify-center relative overflow-visible border-white/60 bg-gradient-to-br ${tile.color} border-2`}>
                                    {BuildingIcon}
                                    <div className="text-[#5D4037] transform scale-90 mb-0.5 opacity-80">{tile.icon}</div>
                                    <div className="text-[9px] font-bold text-[#3E2723] leading-none text-center px-0.5 truncate w-full tracking-tight">{tile.name || tile.label}</div>
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-30 flex-wrap content-center gap-1">
                                        {playersHere.map((p, idx) => (
                                            <div key={p.id} className={`text-xl drop-shadow-md transition-all duration-500 ${p.filter}`} style={{transform: `translate(${idx*2}px, ${idx*-2}px)`}}>{p.icon}</div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                         )
                     })}
                  </div>
               </div>
               
               {activeModal && (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#3E2723]/60 backdrop-blur-sm"><div className="w-full max-w-sm animate-hop"><EventModal type={activeModal} tileData={board[playerPos]} coins={currentPlayer.faith} isOwner={board[playerPos].owner === currentPlayer.id} isFrozen={currentPlayer.isFrozen} onClose={() => { setActiveModal(null); nextTurn(); }} onComplete={onModalComplete} onBuy={(c)=>updateBoardAndFaith(currentPlayer.id, -c, 'buy')} onUpgrade={(c)=>updateBoardAndFaith(currentPlayer.id, -c, 'upgrade')} onDestroy={(c, claim)=>updateBoardAndFaith(currentPlayer.id, -c, claim?'buy_destroy':'destroy')} player={currentPlayer} /></div></div>)}
            </div>
           );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
